# 多用戶對話隔離架構圖

## 整體架構

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端（多個用戶）                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用戶 A                    用戶 B                    用戶 C      │
│  ┌──────────┐             ┌──────────┐             ┌──────────┐│
│  │ Session  │             │ Session  │             │ Session  ││
│  │ ID: A123 │             │ ID: B456 │             │ ID: C789 ││
│  └────┬─────┘             └────┬─────┘             └────┬─────┘│
│       │                        │                        │      │
│       │ API Request            │ API Request            │      │
│       │ {session_id: A123}     │ {session_id: B456}     │      │
│       │                        │                        │      │
└───────┼────────────────────────┼────────────────────────┼──────┘
        │                        │                        │
        ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    後端 API (FastAPI)                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│              ConversationManager (全局單例)                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  sessions: Dict[str, ConversationContext]                 │ │
│  │                                                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │ │
│  │  │ Context A   │  │ Context B   │  │ Context C   │      │ │
│  │  │ ID: A123    │  │ ID: B456    │  │ ID: C789    │      │ │
│  │  ├─────────────┤  ├─────────────┤  ├─────────────┤      │ │
│  │  │ messages: []│  │ messages: []│  │ messages: []│      │ │
│  │  │ candidates  │  │ candidates  │  │ candidates  │      │ │
│  │  │ [10 位]     │  │ [5 位]      │  │ [8 位]      │      │ │
│  │  │ last_query  │  │ last_query  │  │ last_query  │      │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 會話隔離機制

```
用戶 A 的對話流程：
┌──────────────────────────────────────────────────────────────┐
│ Session ID: session_1700000001_abc123                        │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 第 1 輪：                                                     │
│   用戶: "找溝通能力強的人"                                    │
│   系統: 搜索全部候選人 → 返回 10 位                           │
│   Context.current_candidates = [候選人 1-10]                 │
│                                                              │
│ 第 2 輪：                                                     │
│   用戶: "從這些人中找出有領導力的"                            │
│   系統: 檢測到 "從這些人中" → 漸進式篩選                      │
│   系統: 只在 [候選人 1-10] 中篩選                            │
│   系統: 返回 3 位符合條件                                     │
│   Context.current_candidates = [候選人 2, 5, 8]              │
│                                                              │
│ 第 3 輪：                                                     │
│   用戶: "再篩選出內向型的"                                    │
│   系統: 只在 [候選人 2, 5, 8] 中篩選                         │
│   系統: 返回 1 位符合條件                                     │
│   Context.current_candidates = [候選人 5]                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘

用戶 B 的對話流程（同時進行）：
┌──────────────────────────────────────────────────────────────┐
│ Session ID: session_1700000002_xyz789                        │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 第 1 輪：                                                     │
│   用戶: "找創造力強的設計師"                                  │
│   系統: 搜索全部候選人 → 返回 5 位                            │
│   Context.current_candidates = [候選人 3, 7, 11, 15, 20]    │
│                                                              │
│ 第 2 輪：                                                     │
│   用戶: "從這些人中找出內向型的"                              │
│   系統: 只在 [候選人 3, 7, 11, 15, 20] 中篩選               │
│   系統: 返回 2 位符合條件                                     │
│   Context.current_candidates = [候選人 7, 15]                │
│                                                              │
└──────────────────────────────────────────────────────────────┘

✅ 用戶 A 和用戶 B 的對話完全隔離
✅ 各自的 "從這些人中" 只在自己的候選人列表中操作
```

---

## 上下文感知流程

```
┌─────────────────────────────────────────────────────────────┐
│                    用戶發送查詢                              │
│                 "從這些人中找領導力強的"                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 獲取會話上下文                                           │
│     context = conversation_manager.get_or_create_session()   │
│     - session_id: "session_abc123"                          │
│     - current_candidates: [10 位候選人]                     │
│     - messages: [對話歷史]                                   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 分析上下文意圖                                           │
│     analyze_context_intent(context, query)                  │
│     - 檢測關鍵詞: "從這些人中"                               │
│     - 檢查 context.current_candidates 是否存在              │
│     - 判斷意圖: filter_from_current                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 執行漸進式篩選                                           │
│     - 使用 LLM 分析新條件: "領導力強"                        │
│     - 從 context.current_candidates (10 位) 中篩選          │
│     - 返回符合條件的候選人 (3 位)                            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 更新會話上下文                                           │
│     context.set_current_candidates([3 位候選人])            │
│     context.add_message('user', query)                      │
│     context.add_message('assistant', response)              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 返回結果給前端                                           │
│     - candidates: [3 位候選人]                              │
│     - understanding: "從 10 位候選人中篩選出 3 位..."       │
│     - suggestions: ["從這些人中再篩選", "重新搜索"]         │
└─────────────────────────────────────────────────────────────┘
```

---

## 意圖識別決策樹

```
用戶查詢: "從這些人中找領導力強的"
│
├─ 檢查: context.current_candidates 是否存在？
│  │
│  ├─ 是 (有 10 位候選人)
│  │  │
│  │  ├─ 檢查: 查詢中是否包含 "從這些人中"、"從中"、"再篩選" 等關鍵詞？
│  │  │  │
│  │  │  ├─ 是
│  │  │  │  └─ 意圖: filter_from_current (漸進式篩選)
│  │  │  │     └─ 操作: 只在 current_candidates 中篩選
│  │  │  │
│  │  │  └─ 否
│  │  │     └─ 檢查: 查詢中是否包含 "重新找"、"換一批" 等關鍵詞？
│  │  │        │
│  │  │        ├─ 是
│  │  │        │  └─ 意圖: new_search (新搜索)
│  │  │        │     └─ 操作: 清空 current_candidates，搜索全部
│  │  │        │
│  │  │        └─ 否
│  │  │           └─ 意圖: filter_new (新增條件)
│  │  │              └─ 操作: 在全部候選人中搜索
│  │  │
│  └─ 否 (沒有候選人)
│     └─ 意圖: new_search (新搜索)
│        └─ 操作: 在全部候選人中搜索
```

---

## 數據流向圖

```
前端 (用戶 A)                    後端                      資料庫
│                                │                         │
│ 1. 生成 Session ID             │                         │
│    session_abc123              │                         │
│                                │                         │
│ 2. 第一次查詢                  │                         │
│    "找溝通能力強的人"          │                         │
├────────────────────────────────>│                         │
│                                │ 3. 創建 Context         │
│                                │    session_abc123       │
│                                │                         │
│                                │ 4. LLM 分析查詢         │
│                                │    → 特質: 溝通能力     │
│                                │                         │
│                                │ 5. 查詢資料庫           │
│                                ├────────────────────────>│
│                                │<────────────────────────┤
│                                │    返回 10 位候選人     │
│                                │                         │
│                                │ 6. 保存到 Context       │
│                                │    current_candidates   │
│                                │    = [10 位]            │
│<────────────────────────────────┤                         │
│    返回 10 位候選人            │                         │
│                                │                         │
│ 7. 第二次查詢                  │                         │
│    "從這些人中找領導力強的"    │                         │
├────────────────────────────────>│                         │
│                                │ 8. 獲取 Context         │
│                                │    session_abc123       │
│                                │    current_candidates   │
│                                │    = [10 位]            │
│                                │                         │
│                                │ 9. 檢測意圖             │
│                                │    → filter_from_current│
│                                │                         │
│                                │ 10. 從 10 位中篩選      │
│                                │     (不查詢資料庫)      │
│                                │     → 返回 3 位         │
│                                │                         │
│                                │ 11. 更新 Context        │
│                                │     current_candidates  │
│                                │     = [3 位]            │
│<────────────────────────────────┤                         │
│    返回 3 位候選人             │                         │
│    (從 10 位中篩選出來的)      │                         │
│                                │                         │
```

---

## 並發處理示意圖

```
時間軸
│
├─ T1: 用戶 A 發送請求 (Session A)
│      ├─ 創建/獲取 Context A
│      ├─ 處理查詢
│      └─ 更新 Context A
│
├─ T2: 用戶 B 發送請求 (Session B) ← 同時進行
│      ├─ 創建/獲取 Context B
│      ├─ 處理查詢
│      └─ 更新 Context B
│
├─ T3: 用戶 A 發送第二個請求 (Session A)
│      ├─ 獲取 Context A (包含之前的狀態)
│      ├─ 從 Context A 的候選人中篩選
│      └─ 更新 Context A
│
├─ T4: 用戶 C 發送請求 (Session C)
│      ├─ 創建/獲取 Context C
│      ├─ 處理查詢
│      └─ 更新 Context C
│
└─ T5: 用戶 B 發送第二個請求 (Session B)
       ├─ 獲取 Context B (包含之前的狀態)
       ├─ 從 Context B 的候選人中篩選
       └─ 更新 Context B

✅ 每個請求都操作獨立的 Context
✅ 不同 Session 之間完全隔離
✅ FastAPI 的異步機制確保並發安全
```

---

## 關鍵代碼位置

### 前端

- **Session ID 生成**: `frontend/src/stores/talent.js` → `generateSessionId()`
- **API 請求**: `frontend/src/api/talent.js` → `searchTalents(query, sessionId)`
- **會話重置**: `frontend/src/stores/talent.js` → `resetSession()`

### 後端

- **會話管理**: `BackEnd/conversation_manager.py` → `ConversationManager`
- **上下文類**: `BackEnd/conversation_manager.py` → `ConversationContext`
- **意圖分析**: `BackEnd/conversation_manager.py` → `analyze_context_intent()`
- **API 端點**: `BackEnd/talent_search_api_v2.py` → `@app.post("/api/search")`
- **漸進式篩選**: `BackEnd/talent_search_api_v2.py` → `filter_candidates_by_traits()`

---

## 總結

這個架構通過以下機制確保多用戶多輪對話的連貫性：

1. **唯一會話 ID**：每個用戶有獨立的 Session ID
2. **獨立上下文**：每個 Session 維護獨立的對話歷史和候選人列表
3. **智能意圖識別**：根據上下文判斷是新搜索還是漸進式篩選
4. **會話隔離**：不同用戶的會話完全獨立，互不干擾
5. **異步安全**：FastAPI 的異步機制確保並發請求的安全性
