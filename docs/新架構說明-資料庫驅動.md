# 新架構說明 - 資料庫驅動的人才搜索

## 核心原則

### ✅ 原則 1: 特質分類必須來自資料庫

所有特質都從 `trait` 表中讀取，LLM 只能使用資料庫中存在的特質。

### ✅ 原則 2: LLM 生成精確的 SQL 查詢

LLM 的職責是理解用戶需求，並生成對應的 SQL WHERE 條件來查詢資料庫。

## 完整流程

```
用戶輸入
   ↓
"我需要一個善於溝通的銷售人員"
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 1: 系統啟動時載入資料庫特質                              │
│                                                              │
│ SELECT id, chinese_name, system_name, description           │
│ FROM trait;                                                  │
│                                                              │
│ 結果: 50 個特質                                               │
│ - 協調溝通 (Interpersonal Communication)                     │
│ - 分析性思考 (Analytical Thinking)                           │
│ - 創造性思考 (Creative Thinking)                             │
│ - ...                                                        │
└─────────────────────────────────────────────────────────────┘
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 2: LLM 接收用戶查詢 + 資料庫特質列表                     │
│                                                              │
│ System Prompt:                                               │
│ "你是人才搜索助手。以下是資料庫中可用的特質：                 │
│  - 協調溝通: 能有效理解他人需求...                            │
│  - 分析性思考: 能運用邏輯思維...                              │
│  - ...                                                       │
│                                                              │
│  請從這些特質中選擇最匹配的，並生成 SQL 條件。"               │
│                                                              │
│ User Query: "我需要一個善於溝通的銷售人員"                    │
└─────────────────────────────────────────────────────────────┘
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 3: LLM 返回結構化分析                                    │
│                                                              │
│ {                                                            │
│   "matched_traits": [                                        │
│     {                                                        │
│       "chinese_name": "協調溝通",                            │
│       "system_name": "Interpersonal Communication",          │
│       "min_score": 75                                        │
│     },                                                       │
│     {                                                        │
│       "chinese_name": "積極傾聽",                            │
│       "system_name": "Active Listening",                     │
│       "min_score": 70                                        │
│     }                                                        │
│   ],                                                         │
│   "sql_conditions": [                                        │
│     "(trait_results->>'協調溝通')::jsonb->>'score')::int >= 75",│
│     "(trait_results->>'積極傾聽')::jsonb->>'score')::int >= 70" │
│   ],                                                         │
│   "summary": "尋找具備優秀溝通能力的銷售人員"                  │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 4: 使用 LLM 生成的 SQL 查詢資料庫                        │
│                                                              │
│ SELECT                                                       │
│   ip.id, ip.name, ip.email,                                 │
│   itr.trait_results                                          │
│ FROM individual_profile ip                                  │
│ LEFT JOIN individual_test_result itr                        │
│   ON ip.id = itr.individual_id                              │
│ WHERE ip.name IS NOT NULL                                   │
│   AND itr.trait_results IS NOT NULL                         │
│   AND (                                                      │
│     (trait_results->>'協調溝通')::jsonb->>'score')::int >= 75 │
│     OR                                                       │
│     (trait_results->>'積極傾聽')::jsonb->>'score')::int >= 70 │
│   )                                                          │
│ LIMIT 50;                                                   │
│                                                              │
│ 結果: 符合條件的候選人列表                                    │
└─────────────────────────────────────────────────────────────┘
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 5: 計算精確的匹配分數                                    │
│                                                              │
│ for candidate in candidates:                                │
│   total_score = 0                                            │
│   max_score = 0                                              │
│                                                              │
│   for trait in matched_traits:                              │
│     max_score += 100                                         │
│     actual_score = candidate.trait_results[trait.name].score│
│                                                              │
│     if actual_score >= trait.min_score:                     │
│       total_score += actual_score                            │
│     else:                                                    │
│       total_score += actual_score * 0.5                      │
│                                                              │
│   match_score = total_score / max_score                     │
│                                                              │
│ 候選人 A: 協調溝通 85分, 積極傾聽 78分 → 81.5%               │
│ 候選人 B: 協調溝通 90分, 積極傾聽 65分 → 77.5%               │
└─────────────────────────────────────────────────────────────┘
   ↓
┌─────────────────────────────────────────────────────────────┐
│ 步驟 6: LLM 生成個性化推薦理由                                │
│                                                              │
│ 候選人 A (81.5%):                                            │
│ "在協調溝通方面表現優異（85分），積極傾聽能力良好（78分），   │
│  非常適合需要頻繁與客戶互動的銷售職位"                         │
└─────────────────────────────────────────────────────────────┘
```

## 關鍵代碼變更

### 1. LLM Service 初始化時載入資料庫特質

```python
class LLMService:
    def __init__(self, db_conn):
        self.db_conn = db_conn
        self.available_traits = self._load_traits_from_db()

    def _load_traits_from_db(self):
        """從資料庫載入所有可用的特質"""
        cursor = self.db_conn.cursor()
        cursor.execute("SELECT id, chinese_name, system_name, description FROM trait;")
        return cursor.fetchall()
```

### 2. System Prompt 包含資料庫特質

```python
def get_system_prompt(self, available_traits):
    traits_text = "\n".join([
        f"- {t['chinese_name']} ({t['system_name']}): {t['description']}"
        for t in available_traits
    ])

    return f"""
    你是人才搜索助手。

    **資料庫中可用的特質**：
    {traits_text}

    請從這些特質中選擇最匹配的，並生成 SQL 條件。
    """
```

### 3. LLM 返回 SQL 條件

```python
{
  "matched_traits": [
    {"chinese_name": "協調溝通", "min_score": 75}
  ],
  "sql_conditions": [
    "(trait_results->>'協調溝通')::jsonb->>'score')::int >= 75"
  ]
}
```

### 4. 使用 SQL 條件查詢

```python
def search_candidates(self, parsed_query):
    sql = """
        SELECT ip.*, itr.trait_results
        FROM individual_profile ip
        LEFT JOIN individual_test_result itr ON ip.id = itr.individual_id
        WHERE ip.name IS NOT NULL
    """

    # 添加 LLM 生成的條件
    if parsed_query.get('sql_conditions'):
        sql += " AND (" + " OR ".join(parsed_query['sql_conditions']) + ")"

    cursor.execute(sql)
    return cursor.fetchall()
```

### 5. 基於實際分數計算匹配度

```python
def calculate_match_score(self, candidate, parsed_query):
    total_score = 0
    max_score = 0

    for trait in parsed_query['matched_traits']:
        max_score += 100
        actual_score = candidate['trait_results'][trait['chinese_name']]['score']

        if actual_score >= trait['min_score']:
            total_score += actual_score
        else:
            total_score += actual_score * 0.5

    return total_score / max_score
```

## 優勢

### ✅ 1. 數據一致性

- 所有特質都來自資料庫
- 不會出現 LLM 幻覺的特質
- 確保查詢結果的準確性

### ✅ 2. 精確匹配

- 使用實際的測評分數
- SQL 直接過濾符合條件的候選人
- 避免在記憶體中處理大量無關數據

### ✅ 3. 可擴展性

- 新增特質只需更新資料庫
- LLM 自動學習新特質
- 無需修改代碼

### ✅ 4. 效能優化

- 資料庫層面過濾
- 減少網路傳輸
- 提升查詢速度

## 測試

執行測試腳本：

```cmd
cd BackEnd
venv\Scripts\activate
python test_new_search.py
```

預期輸出：

```
查詢: 我需要一個善於溝通的銷售人員

[步驟 1] LLM 解析查詢...
  匹配的特質: [{'chinese_name': '協調溝通', 'min_score': 75}]
  SQL 條件: ["(trait_results->>'協調溝通')::jsonb->>'score')::int >= 75"]
  摘要: 尋找具備優秀溝通能力的銷售人員

[步驟 2] 查詢資料庫...
  找到 15 位候選人

[步驟 3] 計算匹配分數...
  1. 王小明 - 匹配度: 85%
  2. 李美華 - 匹配度: 78%
  ...
```

## 總結

新架構確保：

1. ✅ **特質來源** - 100% 來自資料庫
2. ✅ **SQL 生成** - LLM 生成精確的查詢條件
3. ✅ **數據驅動** - 基於真實測評分數匹配
4. ✅ **可維護性** - 清晰的職責分離

這是一個真正的**資料庫驅動的 AI 人才搜索系統**！🎯
