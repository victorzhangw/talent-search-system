# 多輪對話功能說明

## ✅ 已完成的整合

### 後端更新

1. **整合對話管理器** (`talent_search_api_v2.py`)

   - ✅ 導入 `conversation_manager`
   - ✅ 在搜索 API 中添加會話 ID 支援
   - ✅ 自動追蹤對話上下文
   - ✅ 分析後續問題意圖
   - ✅ 生成智能建議

2. **新增 API 端點**

   - ✅ `GET /api/session/{session_id}/context` - 獲取會話上下文
   - ✅ `DELETE /api/session/{session_id}` - 清除會話

3. **增強對話管理器** (`conversation_manager.py`)
   - ✅ 添加篩選意圖識別
   - ✅ 支援 `filter`（再找）、`exclude`（排除）、`refine`（精確）

### 前端更新

1. **會話管理** (`frontend/src/stores/talent.js`)

   - ✅ 自動生成會話 ID
   - ✅ 在每次搜索時傳遞會話 ID
   - ✅ 添加 `resetSession()` 方法
   - ✅ 更新歡迎訊息，說明多輪對話功能

2. **API 客戶端** (`frontend/src/api/talent.js`)

   - ✅ 更新 `searchTalents()` 支援會話 ID

3. **UI 更新** (`frontend/src/components/ResultsArea.vue`)

   - ✅ 添加重置對話按鈕
   - ✅ 添加確認對話框

4. **樣式** (`frontend/src/assets/css/style.css`)
   - ✅ 重置按鈕樣式
   - ✅ 懸停動畫效果

## 🎯 功能特性

### 1. 會話追蹤

- 每個用戶會話有唯一 ID
- 自動記錄對話歷史
- 追蹤當前關注的候選人
- 記住候選人列表

### 2. 上下文感知

系統能理解以下後續問題：

#### 描述類

- "告訴我更多關於某某的資訊"
- "這個人怎麼樣？"
- "介紹一下他的特質"

#### 篩選類

- "再找一個類似的"
- "還要找其他的"
- "找另外一個"

#### 排除類

- "排除這個候選人"
- "不要這個"
- "去掉某某"

#### 比較類

- "比較這些候選人"
- "哪個更好？"
- "有什麼差異？"

#### 面試類

- "準備面試問題"
- "設計面試綱要"

### 3. 智能建議

系統會根據當前狀態生成建議：

- 找到多個候選人 → 建議"再找一個"、"排除某些"、"比較"
- 找到單個候選人 → 建議"告訴我更多"、"找類似的"
- 基於匹配特質 → 顯示匹配了哪些特質

### 4. 會話重置

- 點擊重置按鈕開始新對話
- 清除對話歷史和搜索結果
- 生成新的會話 ID

## 📝 使用範例

### 範例 1：基本搜索 + 後續提問

```
用戶: "找一個有創造力的產品經理"
系統: 找到 5 位符合條件的候選人
      建議: 再找一個類似的 | 排除某些候選人 | 比較這些候選人

用戶: "告訴我更多關於第一個的資訊"
系統: [顯示詳細的 AI 分析]

用戶: "再找一個類似的"
系統: [基於當前候選人特質搜索]
```

### 範例 2：逐步篩選

```
用戶: "找溝通能力強的人"
系統: 找到 12 位候選人

用戶: "排除經驗少於 3 年的"
系統: [基於上下文重新篩選]

用戶: "再找一個有領導力的"
系統: [在當前結果中進一步篩選]
```

### 範例 3：比較候選人

```
用戶: "找數據分析師"
系統: 找到 8 位候選人

用戶: "比較前三個"
系統: [生成比較分析]

用戶: "哪個更適合初創公司？"
系統: [基於特質分析給出建議]
```

## 🔧 技術實現

### 會話 ID 生成

```javascript
function generateSessionId() {
  return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
```

### 上下文分析流程

```
1. 接收用戶查詢 + 會話 ID
   ↓
2. 獲取會話上下文
   ↓
3. 分析是否為後續問題
   ↓
4. 如果是後續問題：
   - 識別意圖（描述/篩選/排除/比較）
   - 補充上下文資訊
   - 執行對應操作
   ↓
5. 如果是新查詢：
   - 執行智能搜索
   - 更新上下文
   ↓
6. 返回結果 + 智能建議
```

### 上下文儲存

```python
class ConversationContext:
    - messages: 對話歷史
    - current_candidate: 當前關注的候選人
    - current_candidates: 候選人列表
    - last_intent: 最後的意圖
    - last_query: 最後的查詢
```

## 🚀 啟動方式

### 重啟服務以應用更改

1. **停止當前服務**

   - 關閉後端和前端的 CMD 視窗

2. **重新啟動**

   ```bash
   START.bat
   ```

3. **驗證功能**
   - 訪問 http://localhost:3000
   - 嘗試多輪對話
   - 點擊重置按鈕測試

## 📊 API 變更

### 搜索 API

```json
// 請求
POST /api/search
{
  "query": "找一個有創造力的產品經理",
  "session_id": "session_1234567890_abc123",
  "filters": null
}

// 響應
{
  "candidates": [...],
  "total": 5,
  "query_understanding": "您正在尋找：創造力 優秀的人才...",
  "suggestions": [
    "已根據 2 個特質進行智能匹配",
    "再找一個類似的",
    "排除某些候選人",
    "比較這些候選人"
  ]
}
```

### 會話上下文 API

```json
// 請求
GET /api/session/{session_id}/context

// 響應
{
  "session_id": "session_1234567890_abc123",
  "message_count": 6,
  "current_candidate": {...},
  "candidates_count": 5,
  "last_intent": "search",
  "context_summary": "當前候選人列表: 張三, 李四, 王五",
  "conversation_history": [...]
}
```

## 💡 使用建議

1. **充分利用上下文**

   - 不需要重複完整的需求
   - 可以用簡短的後續問題
   - 系統會自動理解上下文

2. **使用智能建議**

   - 點擊建議快速操作
   - 建議基於當前狀態生成

3. **適時重置會話**

   - 開始新的搜索任務時
   - 上下文變得混亂時
   - 想要清空結果時

4. **結合 AI 分析**
   - 先搜索候選人
   - 再點擊"生成 AI 分析"
   - 獲得更深入的洞察

## 🐛 已知限制

1. **會話持久化**

   - 會話只存在於記憶體中
   - 重啟後端會清空所有會話
   - 未來可考慮使用 Redis 持久化

2. **會話過期**

   - 目前沒有自動過期機制
   - 長時間不活動的會話會佔用記憶體
   - 建議定期清理

3. **並發限制**
   - 每個會話 ID 獨立
   - 多個用戶需要不同的會話 ID
   - 前端自動處理

## 📈 未來擴展

1. **會話持久化**

   - 使用 Redis 儲存會話
   - 支援跨服務器會話

2. **更智能的意圖識別**

   - 使用 LLM 分析意圖
   - 支援更複雜的對話

3. **會話分享**

   - 生成分享連結
   - 團隊協作功能

4. **對話導出**
   - 導出對話歷史
   - 生成搜索報告

## ✅ 測試清單

- [ ] 基本搜索功能
- [ ] 後續提問（"告訴我更多"）
- [ ] 篩選功能（"再找一個"）
- [ ] 排除功能（"排除這個"）
- [ ] 比較功能（"比較這些"）
- [ ] 重置會話功能
- [ ] 智能建議顯示
- [ ] 會話 ID 自動生成
- [ ] 上下文追蹤
- [ ] AI 分析整合

---

**完成時間**: 2025-11-17  
**版本**: v2.2 - 多輪對話版
