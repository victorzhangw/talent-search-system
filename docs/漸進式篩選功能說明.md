# 漸進式篩選功能說明

## ✅ 已實現

### 核心功能

漸進式篩選允許用戶在當前搜索結果的基礎上，逐步縮小範圍，而不是每次都從全部候選人中重新搜索。

### 實現的改進

#### 1. 智能意圖識別

系統能自動識別以下意圖：

**從當前結果中篩選**：

- "從裡面找..."
- "從這些人中..."
- "從中篩選..."
- "其中..."
- "再篩選..."
- "進一步篩選..."
- "縮小範圍..."
- "過濾..."

**新搜索（清空之前的結果）**：

- "重新找..."
- "換一批..."
- "不要這些..."
- "清空..."
- "重新搜索..."

#### 2. 篩選邏輯

```python
# 漸進式篩選流程
1. 檢測篩選關鍵詞
   ↓
2. 獲取當前候選人列表（context.current_candidates）
   ↓
3. 使用 LLM 分析新的篩選條件
   ↓
4. 從當前列表中篩選符合條件的候選人
   ↓
5. 返回篩選後的結果
```

#### 3. 響應訊息優化

系統會明確告知篩選過程：

```
"從 17 位候選人中篩選出 5 位符合「內向型」條件的候選人"
```

而不是：

```
"找到 25 位候選人"  ❌
```

## 🎯 使用範例

### 範例 1：基本漸進式篩選

```
用戶: "有創造力的設計師"
系統: 找到 17 位符合條件的候選人
      [當前結果: 17 人]

用戶: "從裡面找出內向型的人"
系統: 從 17 位候選人中篩選出 5 位符合「內向型」條件的候選人
      [當前結果: 5 人] ✅

用戶: "從這些人中再找有領導力的"
系統: 從 5 位候選人中篩選出 2 位符合「領導力」條件的候選人
      [當前結果: 2 人] ✅
```

### 範例 2：重新搜索

```
用戶: "有創造力的設計師"
系統: 找到 17 位候選人
      [當前結果: 17 人]

用戶: "從裡面找出內向型的人"
系統: 從 17 位候選人中篩選出 5 位
      [當前結果: 5 人]

用戶: "重新找外向型的銷售"
系統: 找到 12 位符合條件的候選人
      [當前結果: 12 人] ← 清空之前的篩選 ✅
```

### 範例 3：多層篩選

```
第1層: "溝通能力強的人" → 20 人
第2層: "從這些人中找有領導力的" → 8 人
第3層: "從中篩選出有創造力的" → 3 人
第4層: "從裡面找內向型的" → 1 人
```

## 🔧 技術實現

### 後端實現

#### 1. 意圖識別 (conversation_manager.py)

```python
follow_up_patterns = {
    'filter_from_current': [
        '從裡面', '從這些', '從中', '其中',
        '再篩選', '進一步篩選', '縮小範圍', '過濾'
    ],
    'new_search': [
        '重新找', '換一批', '不要這些', '清空', '重新搜索'
    ],
}

# 返回分析結果
{
    'is_follow_up': True,
    'follow_up_intent': 'filter_from_current',
    'scope': 'current',  # 在當前結果中篩選
    'previous_count': 17
}
```

#### 2. 篩選方法 (talent_search_api_v2.py)

```python
def filter_candidates_by_traits(candidates, matched_traits):
    """從指定的候選人列表中篩選"""
    filtered = []
    for candidate in candidates:
        trait_results = candidate.get('trait_results', {})
        # 檢查是否符合任一特質條件
        for trait in matched_traits:
            if meets_criteria(trait_results, trait):
                filtered.append(candidate)
                break
    return filtered
```

#### 3. API 處理邏輯

```python
if follow_up_intent == 'filter_from_current':
    # 從當前結果中篩選
    current_candidates = context.current_candidates
    llm_result = await engine.llm_service.analyze_query(query_text)
    matched_traits = llm_result['analysis']['matched_traits']

    # 篩選
    filtered = engine.filter_candidates_by_traits(
        current_candidates,
        matched_traits
    )

    # 生成響應
    understanding = f"從 {len(current_candidates)} 位候選人中篩選出 {len(filtered)} 位"
```

### 前端實現

#### 1. 篩選歷史追蹤 (talent.js)

```javascript
const filterHistory = ref([]);

function addFilterStep(query, count) {
  filterHistory.value.push({
    query,
    count,
    timestamp: Date.now(),
  });
}
```

#### 2. 智能建議

```javascript
if (filter_mode === "progressive") {
  suggestions = ["從這些人中再篩選", "重新搜索（清空篩選）", "比較這些候選人"];
}
```

## 📊 對比

### 之前的行為（錯誤）

```
第1輪: "有創造力的設計師"
       → 從全部候選人搜索 → 17 人

第2輪: "從裡面找出內向型的人"
       → 從全部候選人搜索 → 25 人 ❌
       （結果變多了！）
```

### 現在的行為（正確）

```
第1輪: "有創造力的設計師"
       → 從全部候選人搜索 → 17 人

第2輪: "從裡面找出內向型的人"
       → 從這 17 人中篩選 → 5 人 ✅
       （結果變少了，符合預期）
```

## 🎨 用戶體驗

### 1. 明確的篩選提示

```
✅ "從 17 位候選人中篩選出 5 位符合「內向型」條件的候選人"
❌ "找到 25 位候選人"
```

### 2. 智能建議

系統會根據當前狀態提供建議：

- 篩選後：建議"從這些人中再篩選"或"重新搜索"
- 新搜索：建議"從這些人中篩選"

### 3. 篩選歷史（未來功能）

```
篩選路徑:
1. 有創造力的設計師 (17 人)
2. → 內向型 (5 人)
3. → 有領導力 (2 人)

[返回第1步] [返回第2步] [清空篩選]
```

## 🧪 測試案例

### 測試 1：基本篩選

```
輸入: "找溝通能力強的人"
預期: 找到 N 人

輸入: "從裡面找出有領導力的"
預期: 從 N 人中篩選出 M 人（M < N）
```

### 測試 2：多層篩選

```
輸入: "找創造力強的人" → 20 人
輸入: "從中找內向型的" → 8 人
輸入: "從這些人中找有領導力的" → 3 人
預期: 每次結果都在減少
```

### 測試 3：重新搜索

```
輸入: "找設計師" → 15 人
輸入: "從裡面找內向的" → 5 人
輸入: "重新找銷售人員" → 12 人
預期: 第3次是新搜索，不是從5人中篩選
```

### 測試 4：沒有當前結果

```
輸入: "從裡面找..."（但沒有之前的搜索）
預期: 執行新搜索
```

## 🐛 邊界情況處理

1. **沒有當前候選人列表**

   - 檢測到篩選意圖但沒有當前列表
   - 自動執行新搜索

2. **篩選後結果為空**

   - 返回空列表
   - 提示"沒有符合條件的候選人"
   - 建議放寬條件或重新搜索

3. **LLM 分析失敗**

   - 返回當前列表
   - 提示無法理解篩選條件

4. **模糊的意圖**
   - 使用 LLM 智能判斷
   - 優先選擇篩選模式（保守策略）

## 📈 效能優化

1. **記憶體優化**

   - 只保存當前候選人列表
   - 不保存完整的篩選歷史

2. **查詢優化**

   - 在記憶體中篩選，不重新查詢資料庫
   - 減少資料庫負載

3. **響應速度**
   - 篩選比新搜索快（不需要資料庫查詢）
   - 只需要 LLM 分析 + 記憶體篩選

## ✅ 完成清單

- [x] 增強意圖識別（篩選關鍵詞）
- [x] 實現篩選方法
- [x] 修改 API 處理邏輯
- [x] 優化響應訊息
- [x] 前端篩選歷史追蹤
- [x] 智能建議更新
- [ ] 顯示篩選路徑（UI）
- [ ] 返回上一步功能
- [ ] 視覺化篩選漏斗

## 🚀 下一步

1. **重啟服務**

   ```bash
   # 關閉當前服務
   # 執行
   START.bat
   ```

2. **測試功能**

   - 測試基本篩選
   - 測試多層篩選
   - 測試重新搜索

3. **驗證結果**
   - 確認結果數量遞減
   - 確認提示訊息正確
   - 確認建議合理

---

**完成時間**: 2025-11-17  
**版本**: v2.3 - 漸進式篩選版
