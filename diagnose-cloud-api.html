<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›²ç«¯ API è¨ºæ–·å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }

      .api-input {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
      }

      .api-input input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }

      .api-input input:focus {
        outline: none;
        border-color: #667eea;
      }

      .check-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #ddd;
      }

      .check-item.success {
        border-left-color: #28a745;
        background: #d4edda;
      }

      .check-item.error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }

      .check-item.warning {
        border-left-color: #ffc107;
        background: #fff3cd;
      }

      .check-item.info {
        border-left-color: #17a2b8;
        background: #d1ecf1;
      }

      .check-title {
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
      }

      .check-detail {
        font-size: 13px;
        color: #555;
        font-family: "Courier New", monospace;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        text-align: center;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .endpoint-section {
        margin-top: 30px;
      }

      .endpoint-section h2 {
        color: #667eea;
        margin-bottom: 16px;
        font-size: 20px;
      }

      .comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .comparison-item {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
      }

      .comparison-item h3 {
        color: #333;
        margin-bottom: 12px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” é›²ç«¯ API è¨ºæ–·å·¥å…·</h1>
      <p class="subtitle">è¨ºæ–·æœ¬åœ°å’Œé›²ç«¯ API çš„å·®ç•°</p>

      <div class="api-input">
        <input
          type="text"
          id="localApi"
          value="http://localhost:8000"
          placeholder="æœ¬åœ° API URL"
        />
        <input
          type="text"
          id="cloudApi"
          value="https://talent-search-api.onrender.com"
          placeholder="é›²ç«¯ API URL"
        />
        <button class="btn" onclick="runDiagnosis()" id="diagnosisBtn">
          é–‹å§‹è¨ºæ–·
        </button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      async function testEndpoint(
        apiUrl,
        endpoint,
        method = "GET",
        body = null
      ) {
        try {
          const options = {
            method: method,
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          const startTime = Date.now();
          const response = await fetch(`${apiUrl}${endpoint}`, options);
          const endTime = Date.now();
          const duration = endTime - startTime;

          let data = null;
          let contentType = response.headers.get("content-type");

          if (contentType && contentType.includes("application/json")) {
            data = await response.json();
          } else {
            data = await response.text();
          }

          return {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            data: data,
            duration: duration,
            headers: Object.fromEntries(response.headers.entries()),
          };
        } catch (error) {
          return {
            success: false,
            error: error.message,
            duration: 0,
          };
        }
      }

      function addCheckItem(title, detail, status) {
        const resultsDiv = document.getElementById("results");
        const item = document.createElement("div");
        item.className = `check-item ${status}`;

        let icon = "â³";
        if (status === "success") icon = "âœ…";
        if (status === "error") icon = "âŒ";
        if (status === "warning") icon = "âš ï¸";
        if (status === "info") icon = "â„¹ï¸";

        item.innerHTML = `
                <div class="check-title">
                    <span class="icon">${icon}</span>
                    ${title}
                </div>
                <div class="check-detail">${detail}</div>
            `;

        resultsDiv.appendChild(item);
      }

      function addSection(title) {
        const resultsDiv = document.getElementById("results");
        const section = document.createElement("div");
        section.className = "endpoint-section";
        section.innerHTML = `<h2>${title}</h2>`;
        resultsDiv.appendChild(section);
      }

      function formatJson(obj) {
        return JSON.stringify(obj, null, 2);
      }

      async function runDiagnosis() {
        const resultsDiv = document.getElementById("results");
        const btn = document.getElementById("diagnosisBtn");
        const localApi = document.getElementById("localApi").value;
        const cloudApi = document.getElementById("cloudApi").value;

        resultsDiv.innerHTML = "";
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> è¨ºæ–·ä¸­...';

        // æ¸¬è©¦ç«¯é»åˆ—è¡¨
        const endpoints = [
          { path: "/", method: "GET", name: "æ ¹è·¯å¾‘" },
          { path: "/health", method: "GET", name: "å¥åº·æª¢æŸ¥" },
          { path: "/api/traits", method: "GET", name: "ç‰¹è³ªå®šç¾©" },
          { path: "/api/candidates", method: "GET", name: "å€™é¸äººåˆ—è¡¨" },
          {
            path: "/api/search",
            method: "POST",
            name: "æœç´¢åŠŸèƒ½",
            body: { query: "åˆ—å‡ºæ‰€æœ‰å€™é¸äºº", filters: null },
          },
        ];

        // æ¸¬è©¦æ¯å€‹ç«¯é»
        for (const endpoint of endpoints) {
          addSection(`ğŸ“ æ¸¬è©¦ç«¯é»: ${endpoint.name} (${endpoint.path})`);

          // æ¸¬è©¦æœ¬åœ° API
          addCheckItem(
            `æœ¬åœ° API: ${localApi}${endpoint.path}`,
            "æ­£åœ¨æ¸¬è©¦...",
            "info"
          );

          const localResult = await testEndpoint(
            localApi,
            endpoint.path,
            endpoint.method,
            endpoint.body
          );

          if (localResult.success) {
            addCheckItem(
              `âœ… æœ¬åœ° API æˆåŠŸ`,
              `ç‹€æ…‹: ${localResult.status}\n` +
                `éŸ¿æ‡‰æ™‚é–“: ${localResult.duration}ms\n` +
                `æ•¸æ“š: ${formatJson(localResult.data).substring(0, 500)}...`,
              "success"
            );
          } else {
            addCheckItem(
              `âŒ æœ¬åœ° API å¤±æ•—`,
              `éŒ¯èª¤: ${localResult.error || localResult.statusText}\n` +
                `ç‹€æ…‹ç¢¼: ${localResult.status || "N/A"}`,
              "error"
            );
          }

          // æ¸¬è©¦é›²ç«¯ API
          addCheckItem(
            `é›²ç«¯ API: ${cloudApi}${endpoint.path}`,
            "æ­£åœ¨æ¸¬è©¦...",
            "info"
          );

          const cloudResult = await testEndpoint(
            cloudApi,
            endpoint.path,
            endpoint.method,
            endpoint.body
          );

          if (cloudResult.success) {
            addCheckItem(
              `âœ… é›²ç«¯ API æˆåŠŸ`,
              `ç‹€æ…‹: ${cloudResult.status}\n` +
                `éŸ¿æ‡‰æ™‚é–“: ${cloudResult.duration}ms\n` +
                `æ•¸æ“š: ${formatJson(cloudResult.data).substring(0, 500)}...`,
              "success"
            );
          } else {
            addCheckItem(
              `âŒ é›²ç«¯ API å¤±æ•—`,
              `éŒ¯èª¤: ${cloudResult.error || cloudResult.statusText}\n` +
                `ç‹€æ…‹ç¢¼: ${cloudResult.status || "N/A"}\n\n` +
                `å¯èƒ½åŸå› :\n` +
                `1. API æœå‹™æœªå•Ÿå‹•æˆ–å·²å´©æ½°\n` +
                `2. è·¯ç”±é…ç½®éŒ¯èª¤\n` +
                `3. CORS è¨­å®šå•é¡Œ\n` +
                `4. ç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºè¨­å®š\n` +
                `5. è³‡æ–™åº«é€£æ¥å¤±æ•—`,
              "error"
            );
          }

          // æ¯”è¼ƒçµæœ
          if (localResult.success && cloudResult.success) {
            // æ¯”è¼ƒæ•¸æ“š
            const localData = JSON.stringify(localResult.data);
            const cloudData = JSON.stringify(cloudResult.data);

            if (localData === cloudData) {
              addCheckItem(
                "âœ… æ•¸æ“šä¸€è‡´",
                "æœ¬åœ°å’Œé›²ç«¯è¿”å›çš„æ•¸æ“šå®Œå…¨ç›¸åŒ",
                "success"
              );
            } else {
              addCheckItem(
                "âš ï¸ æ•¸æ“šä¸ä¸€è‡´",
                `æœ¬åœ°æ•¸æ“šé•·åº¦: ${localData.length}\n` +
                  `é›²ç«¯æ•¸æ“šé•·åº¦: ${cloudData.length}\n\n` +
                  `å¯èƒ½åŸå› :\n` +
                  `1. è³‡æ–™åº«æ•¸æ“šä¸åŒæ­¥\n` +
                  `2. API ç‰ˆæœ¬ä¸åŒ\n` +
                  `3. ç’°å¢ƒé…ç½®å·®ç•°`,
                "warning"
              );
            }
          } else if (!localResult.success && !cloudResult.success) {
            addCheckItem(
              "âŒ å…©ç«¯éƒ½å¤±æ•—",
              "æœ¬åœ°å’Œé›²ç«¯ API éƒ½ç„¡æ³•è¨ªå•æ­¤ç«¯é»",
              "error"
            );
          } else {
            addCheckItem(
              "âš ï¸ è¡Œç‚ºä¸ä¸€è‡´",
              `æœ¬åœ°: ${localResult.success ? "æˆåŠŸ" : "å¤±æ•—"}\n` +
                `é›²ç«¯: ${cloudResult.success ? "æˆåŠŸ" : "å¤±æ•—"}`,
              "warning"
            );
          }
        }

        // ç¸½çµ
        addSection("ğŸ“Š è¨ºæ–·ç¸½çµ");
        addCheckItem(
          "è¨ºæ–·å®Œæˆ",
          "è«‹æŸ¥çœ‹ä¸Šæ–¹çš„è©³ç´°çµæœï¼Œæ‰¾å‡ºæœ¬åœ°å’Œé›²ç«¯çš„å·®ç•°ã€‚\n\n" +
            "å¸¸è¦‹å•é¡Œè§£æ±ºæ–¹æ¡ˆ:\n" +
            "1. 404 éŒ¯èª¤: æª¢æŸ¥ Render çš„å•Ÿå‹•å‘½ä»¤å’Œè·¯ç”±é…ç½®\n" +
            "2. CORS éŒ¯èª¤: æ›´æ–°å¾Œç«¯ CORS è¨­å®š\n" +
            "3. 500 éŒ¯èª¤: æª¢æŸ¥å¾Œç«¯æ—¥èªŒå’Œç’°å¢ƒè®Šæ•¸\n" +
            "4. æ•¸æ“šä¸ä¸€è‡´: ç¢ºèªè³‡æ–™åº«é€£æ¥å’Œæ•¸æ“šåŒæ­¥",
          "info"
        );

        btn.disabled = false;
        btn.innerHTML = "é‡æ–°è¨ºæ–·";
      }
    </script>
  </body>
</html>
