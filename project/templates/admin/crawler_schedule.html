{% extends 'base.html' %}
{% load static %}

{% block title %}æ’ç¨‹ç®¡ç†{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<li class="breadcrumb-item"><a href="{% url 'crawler_dashboard' %}">çˆ¬èŸ²ç®¡ç†</a></li>
<li class="breadcrumb-item active">æ’ç¨‹ç®¡ç†</li>
{% endblock %}

{% block content %}
<div class="crawler-schedule">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ“… æ’ç¨‹ç®¡ç†</h1>
        <div>
            <button type="button" class="btn btn-primary me-2" onclick="showCreateModal()">
                â• æ–°å¢æ’ç¨‹
            </button>
            <a href="{% url 'crawler_dashboard' %}" class="btn btn-outline-secondary">
                â¬…ï¸ è¿”å›å„€è¡¨æ¿
            </a>
        </div>
    </div>
    
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“Š ç¸½æ’ç¨‹ä»»å‹™</h5>
                    <h2 class="text-primary">{{ total_tasks }}</h2>
                    <p class="card-text">å·²è¨­å®šçš„æ’ç¨‹ä»»å‹™</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">âœ… å•Ÿç”¨ä¸­</h5>
                    <h2 class="text-success">{{ enabled_tasks }}</h2>
                    <p class="card-text">æ­£åœ¨é‹è¡Œçš„ä»»å‹™</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">â¸ï¸ å·²åœç”¨</h5>
                    <h2 class="text-warning">{{ disabled_tasks }}</h2>
                    <p class="card-text">æš«åœçš„ä»»å‹™</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ’ç¨‹ä»»å‹™åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">ğŸ•’ æ’ç¨‹ä»»å‹™åˆ—è¡¨</h5>
        </div>
        <div class="card-body">
            {% if crawler_tasks %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ä»»å‹™åç¨±</th>
                            <th>ä»»å‹™é¡å‹</th>
                            <th>æ’ç¨‹è¨­å®š</th>
                            <th>ç‹€æ…‹</th>
                            <th>æœ€å¾ŒåŸ·è¡Œ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in crawler_tasks %}
                        <tr>
                            <td>
                                <strong>{{ task.name }}</strong>
                                <br>
                                <small class="text-muted">{{ task.description|default:"" }}</small>
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    {% if 'crawl_all_pending' in task.task %}
                                        ğŸ•·ï¸ æ‰¹é‡çˆ¬å–
                                    {% elif 'cleanup' in task.task %}
                                        ğŸ§¹ æ—¥èªŒæ¸…ç†
                                    {% else %}
                                        ğŸ“‹ å…¶ä»–ä»»å‹™
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if task.crontab %}
                                    <div class="schedule-info">
                                        <code>
                                            {{ task.crontab.minute }} {{ task.crontab.hour }} 
                                            {{ task.crontab.day_of_month }} {{ task.crontab.month_of_year }} 
                                            {{ task.crontab.day_of_week }}
                                        </code>
                                        <br>
                                        <small class="text-muted">
                                            {% if task.crontab.minute == "0" and task.crontab.hour == "*/2" %}
                                                æ¯2å°æ™‚åŸ·è¡Œ
                                            {% elif task.crontab.minute == "30" and task.crontab.hour == "2" %}
                                                æ¯æ—¥å‡Œæ™¨2:30
                                            {% else %}
                                                è‡ªå®šç¾©æ’ç¨‹
                                            {% endif %}
                                        </small>
                                    </div>
                                {% else %}
                                    <span class="text-muted">ç„¡æ’ç¨‹</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if task.enabled %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if task.enabled %}
                                        âœ… å•Ÿç”¨ä¸­
                                    {% else %}
                                        â¸ï¸ å·²åœç”¨
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if task.last_run_at %}
                                    {{ task.last_run_at|date:"Y-m-d H:i" }}
                                    <br>
                                    <small class="text-muted">
                                        {% if task.total_run_count %}
                                            åŸ·è¡Œ {{ task.total_run_count }} æ¬¡
                                        {% endif %}
                                    </small>
                                {% else %}
                                    <span class="text-muted">å¾æœªåŸ·è¡Œ</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" 
                                            class="btn btn-outline-{% if task.enabled %}warning{% else %}success{% endif %}"
                                            onclick="toggleTask({{ task.id }}, {{ task.enabled|yesno:'true,false' }})">
                                        {% if task.enabled %}
                                            â¸ï¸ åœç”¨
                                        {% else %}
                                            â–¶ï¸ å•Ÿç”¨
                                        {% endif %}
                                    </button>
                                    <button type="button" 
                                            class="btn btn-outline-primary"
                                            onclick="editSchedule({{ task.id }}, '{{ task.name }}', '{{ task.crontab.minute|default:"*" }}', '{{ task.crontab.hour|default:"*" }}', '{{ task.crontab.day_of_month|default:"*" }}', '{{ task.crontab.month_of_year|default:"*" }}', '{{ task.crontab.day_of_week|default:"*" }}')">
                                        âš™ï¸ ç·¨è¼¯
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
                </div>
                <h4 class="text-muted">æš«ç„¡æ’ç¨‹ä»»å‹™</h4>
                <p class="text-muted">è«‹å…ˆè¨­å®š Celery Beat æ’ç¨‹ä»»å‹™ã€‚</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ–°å¢æ’ç¨‹ Modal -->
<div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢æ’ç¨‹ä»»å‹™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createScheduleForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_schedule">
                    
                    <div class="mb-3">
                        <label for="newTaskName" class="form-label">ä»»å‹™åç¨±</label>
                        <input type="text" class="form-control" id="newTaskName" name="task_name" required>
                        <div class="form-text">ä¾‹å¦‚ï¼šæ¯æ—¥å‚™ä»½ä»»å‹™</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskType" class="form-label">ä»»å‹™é¡å‹</label>
                        <select class="form-select" id="taskType" name="task_type" required>
                            <option value="">è«‹é¸æ“‡ä»»å‹™é¡å‹</option>
                            <option value="core.tasks.crawl_all_pending_results">ğŸ•·ï¸ æ‰¹é‡çˆ¬å–æ¸¬é©—çµæœ</option>
                            <option value="core.tasks.cleanup_old_crawl_logs">ğŸ§¹ æ¸…ç†èˆŠæ—¥èªŒ</option>
                            <option value="core.tasks.manual_crawl">ğŸ“‹ æ‰‹å‹•çˆ¬å–</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newMinute" class="form-label">åˆ†é˜ (0-59)</label>
                                <input type="text" class="form-control" id="newMinute" name="minute" placeholder="*" required>
                                <div class="form-text">* è¡¨ç¤ºä»»æ„å€¼</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newHour" class="form-label">å°æ™‚ (0-23)</label>
                                <input type="text" class="form-control" id="newHour" name="hour" placeholder="*" required>
                                <div class="form-text">*/2 è¡¨ç¤ºæ¯2å°æ™‚</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newDayOfMonth" class="form-label">æ—¥æœŸ (1-31)</label>
                                <input type="text" class="form-control" id="newDayOfMonth" name="day_of_month" placeholder="*" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newMonthOfYear" class="form-label">æœˆä»½ (1-12)</label>
                                <input type="text" class="form-control" id="newMonthOfYear" name="month_of_year" placeholder="*" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newDayOfWeek" class="form-label">æ˜ŸæœŸ (0-6, 0=æ˜ŸæœŸæ—¥)</label>
                        <input type="text" class="form-control" id="newDayOfWeek" name="day_of_week" placeholder="*" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">ä»»å‹™æè¿° (å¯é¸)</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="2" placeholder="æè¿°é€™å€‹ä»»å‹™çš„ç”¨é€”..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>å¸¸ç”¨è¨­å®šç¯„ä¾‹ï¼š</strong>
                        <ul class="mb-0">
                            <li><code>0 */2 * * *</code> - æ¯2å°æ™‚åŸ·è¡Œä¸€æ¬¡</li>
                            <li><code>30 2 * * *</code> - æ¯æ—¥å‡Œæ™¨2:30åŸ·è¡Œ</li>
                            <li><code>0 9 * * 1-5</code> - é€±ä¸€åˆ°é€±äº”æ—©ä¸Š9é»åŸ·è¡Œ</li>
                            <li><code>0 0 1 * *</code> - æ¯æœˆ1è™Ÿåˆå¤œåŸ·è¡Œ</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createSchedule()">å»ºç«‹æ’ç¨‹</button>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æ’ç¨‹ Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç·¨è¼¯æ’ç¨‹è¨­å®š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    {% csrf_token %}
                    <input type="hidden" id="taskId" name="task_id">
                    <input type="hidden" name="action" value="update_schedule">
                    
                    <div class="mb-3">
                        <label class="form-label">ä»»å‹™åç¨±</label>
                        <input type="text" class="form-control" id="taskName" readonly>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="minute" class="form-label">åˆ†é˜ (0-59)</label>
                                <input type="text" class="form-control" id="minute" name="minute" placeholder="*">
                                <div class="form-text">* è¡¨ç¤ºä»»æ„å€¼</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hour" class="form-label">å°æ™‚ (0-23)</label>
                                <input type="text" class="form-control" id="hour" name="hour" placeholder="*">
                                <div class="form-text">*/2 è¡¨ç¤ºæ¯2å°æ™‚</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="day_of_month" class="form-label">æ—¥æœŸ (1-31)</label>
                                <input type="text" class="form-control" id="day_of_month" name="day_of_month" placeholder="*">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="month_of_year" class="form-label">æœˆä»½ (1-12)</label>
                                <input type="text" class="form-control" id="month_of_year" name="month_of_year" placeholder="*">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="day_of_week" class="form-label">æ˜ŸæœŸ (0-6, 0=æ˜ŸæœŸæ—¥)</label>
                        <input type="text" class="form-control" id="day_of_week" name="day_of_week" placeholder="*">
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>å¸¸ç”¨è¨­å®šç¯„ä¾‹ï¼š</strong>
                        <ul class="mb-0">
                            <li><code>0 */2 * * *</code> - æ¯2å°æ™‚åŸ·è¡Œä¸€æ¬¡</li>
                            <li><code>30 2 * * *</code> - æ¯æ—¥å‡Œæ™¨2:30åŸ·è¡Œ</li>
                            <li><code>0 9 * * 1-5</code> - é€±ä¸€åˆ°é€±äº”æ—©ä¸Š9é»åŸ·è¡Œ</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleTask(taskId, currentEnabled) {
    const action = currentEnabled ? 'åœç”¨' : 'å•Ÿç”¨';
    
    if (confirm(`ç¢ºå®šè¦${action}æ­¤ä»»å‹™å—ï¼Ÿ`)) {
        fetch('{% url "crawler_schedule" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=toggle&task_id=${taskId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('æ“ä½œå¤±æ•—ï¼š' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
        });
    }
}

function editSchedule(taskId, taskName, minute, hour, dayOfMonth, monthOfYear, dayOfWeek) {
    document.getElementById('taskId').value = taskId;
    document.getElementById('taskName').value = taskName;
    document.getElementById('minute').value = minute === '*' ? '' : minute;
    document.getElementById('hour').value = hour === '*' ? '' : hour;
    document.getElementById('day_of_month').value = dayOfMonth === '*' ? '' : dayOfMonth;
    document.getElementById('month_of_year').value = monthOfYear === '*' ? '' : monthOfYear;
    document.getElementById('day_of_week').value = dayOfWeek === '*' ? '' : dayOfWeek;
    
    const modal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    modal.show();
}

function showCreateModal() {
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('createScheduleForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('createScheduleModal'));
    modal.show();
}

function createSchedule() {
    const form = document.getElementById('createScheduleForm');
    const formData = new FormData(form);
    
    // é©—è­‰å¿…å¡«æ¬„ä½
    const requiredFields = ['task_name', 'task_type', 'minute', 'hour', 'day_of_month', 'month_of_year', 'day_of_week'];
    let isValid = true;
    
    for (let field of requiredFields) {
        const value = formData.get(field);
        if (!value || value.trim() === '') {
            isValid = false;
            break;
        }
    }
    
    if (!isValid) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
        return;
    }
    
    fetch('{% url "crawler_schedule" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('å»ºç«‹å¤±æ•—ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
    });
}

function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    fetch('{% url "crawler_schedule" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
    });
}
</script>
{% endblock %}