{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}ç·¨è¼¯{% else %}æ–°å¢{% endif %}æ¸¬é©—é …ç›® - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
/* ä¸»è¦å€å¡Šé…è‰²è¨­è¨ˆ */
.section-basic {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
}

.section-fields {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(240, 147, 251, 0.2);
}

.section-categories {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(79, 172, 254, 0.2);
    position: relative;
}
.section-categories .section-header {
    position: sticky;
    top: 72px;
    z-index: 35;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(79, 172, 254, 0.2);
}

.section-traits {
    background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(250, 208, 196, 0.25);
    position: relative;
}

.section-traits .section-header {
    position: sticky;
    top: 72px;
    z-index: 40;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(249, 115, 115, 0.2);
}

.section-assignment {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(67, 233, 123, 0.2);
}

.sticky-action-bar {
    position: sticky;
    bottom: 1.5rem;
    z-index: 60;
    pointer-events: none;
    margin-top: 2rem;
}

.sticky-action-bar .action-card {
    border-radius: 18px;
    box-shadow: 0 12px 32px rgba(52, 73, 94, 0.25);
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.92);
    pointer-events: auto;
}

.sticky-action-bar .action-card .card-body {
    padding: 1.25rem 1.75rem;
}

#testProjectForm {
    padding-bottom: 6rem;
}

.section-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px 12px 0 0;
    padding: 1.5rem;
    border-bottom: 3px solid rgba(255, 255, 255, 0.3);
}

.section-body {
    background: rgba(255, 255, 255, 0.98);
    padding: 2rem;
    border-radius: 0 0 12px 12px;
}

.section-title {
    color: #2d3748;
    font-weight: 600;
    font-size: 1.3rem;
    margin: 0;
    display: flex;
    align-items: center;
}

.section-title i {
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 1.5rem;
    margin-right: 0.75rem;
}

/* åˆ†é¡é …ç›®ç¾åŒ– */
.category-item {
    border: none;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #f0f9ff 100%);
    border-left: 5px solid #3b82f6;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
}

.category-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.category-header {
    background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #6366f1;
}

.category-number-badge {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-block;
}

.project-traits-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.project-trait-item {
    border-radius: 12px;
    padding: 1.25rem;
    background: linear-gradient(135deg, #fff7f7 0%, #fff0f0 100%);
    border-left: 5px solid #f97373;
    box-shadow: 0 4px 20px rgba(249, 115, 115, 0.15);
    transition: all 0.3s ease;
}

.project-trait-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 26px rgba(249, 115, 115, 0.25);
}

.project-trait-header {
    background: linear-gradient(135deg, #ffe5e5 0%, #ffd1d1 100%);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #f87171;
}

.project-trait-number-badge {
    background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    color: #fff;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 600;
}

.highlight-flash {
    animation: traitPulse 1.4s ease-in-out 1;
    box-shadow: 0 0 0 4px rgba(249, 115, 115, 0.35), 0 12px 24px rgba(0, 0, 0, 0.12);
    position: relative;
}

.sticky-category-trait {
    position: -webkit-sticky;
    position: sticky;
    top: 164px;
    z-index: 25;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(10px);
    box-shadow: 0 6px 18px rgba(59, 130, 246, 0.2);
}

@keyframes traitPulse {
    0% { transform: scale(1); }
    40% { transform: scale(1.01); }
    80% { transform: scale(0.99); }
    100% { transform: scale(1); }
}

.project-trait-description-preview {
    background: rgba(255, 255, 255, 0.6);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.9rem;
    border: 1px dashed rgba(248, 113, 113, 0.4);
}

/* ç‰¹è³ªé …ç›®ç¾åŒ– */
.trait-item {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    transition: all 0.3s ease;
}

.trait-item:hover {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.trait-header {
    background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.85rem;
    font-weight: 600;
}

/* æŒ‰éˆ•ç¾åŒ– */
.btn-add-category {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    transition: all 0.3s ease;
}

.btn-add-category:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    color: white;
}

.btn-add-trait {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    color: white;
    font-weight: 500;
    font-size: 0.85rem;
    box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
    transition: all 0.3s ease;
}

.btn-add-trait:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    color: white;
}

.btn-remove {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    color: white;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
}

.btn-remove:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    color: white;
}

/* ç”¨æˆ¶é¸æ“‡å€åŸŸç¾åŒ– */
.user-selection-container {
    max-height: 350px;
    overflow-y: auto;
    border: 3px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
}

.user-checkbox-item {
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 10px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.user-checkbox-item:hover {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #3b82f6;
    transform: translateX(5px);
}

.enterprise-section {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 5px solid #f59e0b;
}

.individual-section {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 5px solid #10b981;
}

/* è¡¨å–®è¼¸å…¥æ¡†ç¾åŒ– */
.form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

/* é€²åº¦æŒ‡ç¤ºå™¨ */
.progress-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 3rem;
    padding: 2rem 1rem;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.progress-step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    transition: all 0.3s ease;
    position: relative;
    z-index: 3;
}

.progress-step.completed .progress-step-circle {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.progress-step.active .progress-step-circle {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    animation: pulse 2s infinite;
}

.progress-step.pending .progress-step-circle {
    background: #e2e8f0;
    color: #94a3b8;
    border: 3px solid #cbd5e1;
}

.progress-step-label {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
}

.progress-step.completed .progress-step-label {
    color: #10b981;
}

.progress-step.active .progress-step-label {
    color: #3b82f6;
}

.progress-step.pending .progress-step-label {
    color: #94a3b8;
}

.progress-line {
    flex: 1;
    height: 4px;
    margin: 0 1rem;
    border-radius: 2px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}

.progress-line.completed {
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

.progress-line.pending {
    background: #e2e8f0;
}

@keyframes pulse {
    0% {
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    50% {
        box-shadow: 0 4px 25px rgba(59, 130, 246, 0.5);
        transform: scale(1.05);
    }
    100% {
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 768px) {
    .section-body {
        padding: 1rem;
    }
    
    .category-item {
        padding: 1rem;
    }
    
    .user-selection-container {
        max-height: 250px;
        padding: 1rem;
    }
}

/* å‹•ç•«æ•ˆæœ */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.category-item {
    animation: slideInUp 0.5s ease-out;
}

.trait-item {
    animation: slideInUp 0.3s ease-out;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">å„€è¡¨æ¿</a></li>
<li class="breadcrumb-item"><a href="{% url 'test_project_list' %}">æ¸¬é©—é …ç›®ç®¡ç†</a></li>
<li class="breadcrumb-item active">{% if is_edit %}ç·¨è¼¯{% else %}æ–°å¢{% endif %}æ¸¬é©—é …ç›®</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
    <div class="progress-indicator">
        <div class="progress-step pending" id="step1">
            <div class="progress-step-circle">
                <i class="bi bi-info-circle"></i>
            </div>
            <div class="progress-step-label">åŸºæœ¬è³‡è¨Š</div>
        </div>
        
        <div class="progress-line pending"></div>
        
        <div class="progress-step pending" id="step2">
            <div class="progress-step-circle">
                <i class="bi bi-sliders"></i>
            </div>
            <div class="progress-step-label">æ¬„ä½è¨­å®š</div>
        </div>
        
        <div class="progress-line pending"></div>
        
        <div class="progress-step pending" id="step3">
            <div class="progress-step-circle">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="progress-step-label">åˆ†é¡ç®¡ç†</div>
        </div>
        
        <div class="progress-line pending"></div>
        
        <div class="progress-step pending" id="step4">
            <div class="progress-step-circle">
                <i class="bi bi-people"></i>
            </div>
            <div class="progress-step-label">ç”¨æˆ¶æŒ‡æ´¾</div>
        </div>
    </div>

    <form method="post" id="testProjectForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- 1. åŸºæœ¬è³‡è¨Šå€å¡Š -->
        <div class="section-basic">
            <div class="section-header">
                <h6 class="section-title">
                    <i class="bi bi-info-circle"></i>åŸºæœ¬è³‡è¨Š
                </h6>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label fw-bold">æ¸¬é©—åç¨± <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" id="name" name="name" 
                            value="{% if is_edit %}{{ project.name }}{% endif %}" required
                            placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„å®Œæ•´åç¨±">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="name_abbreviation" class="form-label fw-bold">æ¸¬é©—åç¨±ç¸®å¯«</label>
                        <input type="text" class="form-control form-control-lg" id="name_abbreviation" name="name_abbreviation"
                            value="{% if is_edit %}{{ project.name_abbreviation }}{% endif %}"
                            placeholder="è¼¸å…¥ç°¡çŸ­è­˜åˆ¥åç¨±ï¼Œåƒ…ä¾›ä¸‹è¼‰æª”åä½¿ç”¨">
                        <div class="form-text text-muted">åƒ…ä¾›ä¸‹è¼‰æª”åä½¿ç”¨ï¼Œä¾‹ï¼šAIæ½›èƒ½ã€CIAäººæ‰ç­‰ã€‚</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="test_link" class="form-label fw-bold">æ¸¬é©—é€£çµ <span class="text-danger">*</span></label>
                        <input type="url" class="form-control form-control-lg" id="test_link" name="test_link" 
                            value="{% if is_edit %}{{ project.test_link }}{% endif %}" required
                            placeholder="https://example.com/test">
                    </div>
                    
                    <!-- æ–°å¢ï¼šJob Role ç³»çµ±å°æ‡‰åç¨±æ¬„ä½ -->
                    <div class="col-md-12 mb-3">
                        <label for="job_role_system_name" class="form-label fw-bold">
                            <i class="bi bi-gear me-1"></i>Job Roleç³»çµ±å°æ‡‰åç¨±
                            <span class="badge bg-info ms-2">çˆ¬èŸ²ç¯©é¸</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="job_role_system_name" name="job_role_system_name" 
                            value="{% if is_edit %}{{ project.job_role_system_name }}{% endif %}"
                            placeholder="ä¾‹å¦‚ï¼šrecommended_job_roleã€job_positionã€career_match">
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            æ­¤æ¬„ä½ç”¨æ–¼çˆ¬èŸ²ç¨‹å¼è­˜åˆ¥å’Œç¯©é¸Job Roleç›¸é—œè³‡è¨Šï¼Œè«‹è¼¸å…¥æ¸¬é©—ç³»çµ±ä¸­å°æ‡‰çš„æ¬„ä½åç¨±
                        </div>
                    </div>

                    <div class="col-md-12 mb-4">
                        <label class="form-label fw-bold d-block">é›·é”åœ–æ¨¡å¼ <span class="text-danger">*</span></label>
                        <div class="d-flex flex-wrap gap-3">
                            {% for value, label in radar_mode_choices %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radar_mode" id="radar_mode_{{ value }}" value="{{ value }}"
                                       {% if current_radar_mode|default:'role' == value %}checked{% endif %}>
                                <label class="form-check-label" for="radar_mode_{{ value }}">{{ label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="form-text text-muted">
                            Role-based é©ç”¨è§’è‰²å‹å ±å‘Šï¼ˆä¾åˆ†é¡è§’è‰²åŠ æ¬Šï¼‰ï¼ŒScore-based é©ç”¨åˆ†æ•¸å‹å ±å‘Šï¼ˆä¾é¢å‘å¾—åˆ†å‘ˆç¾ï¼‰ã€‚
                        </div>
                    </div>

                    <div class="col-md-12 mb-3 {% if current_radar_mode|default:'role' != 'role' %}d-none{% endif %}" id="mixedRoleOption">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show_mixed_role" name="show_mixed_role"
                                   {% if current_show_mixed_role %}checked{% endif %}>
                            <label class="form-check-label fw-semibold" for="show_mixed_role">
                                é¡¯ç¤ºæ··åˆå‹è§’è‰²å»ºè­°
                            </label>
                        </div>
                        <div class="form-text text-muted">
                            å‹¾é¸å¾Œï¼Œè‹¥ç³»çµ±åˆ¤æ–·å…©å€‹è§’è‰²å·®è·æ¥è¿‘ï¼Œå°‡é¡¯ç¤ºã€Œæ··åˆå‹è§’è‰²ã€æç¤ºã€‚
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label for="description" class="form-label fw-bold">æ¸¬é©—æè¿°</label>
                        <textarea class="form-control" id="description" name="description" rows="4"
                                placeholder="è©³ç´°æè¿°æ­¤æ¸¬é©—é …ç›®çš„ç›®çš„ã€é©ç”¨å°è±¡ç­‰è³‡è¨Š">{% if is_edit %}{{ project.description }}{% endif %}</textarea>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="title_name" class="form-label fw-bold">æ¨™é¡Œåç¨±</label>
                        <input type="text" class="form-control" id="title_name" name="title_name" 
                            value="{% if is_edit %}{{ project.title_name }}{% endif %}"
                            placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„æ¨™é¡Œåç¨±">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="title_name_english" class="form-label fw-bold">æ¨™é¡Œåç¨±è‹±æ–‡</label>
                        <input type="text" class="form-control" id="title_name_english" name="title_name_english" 
                            value="{% if is_edit %}{{ project.title_name_english }}{% endif %}"
                            placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„è‹±æ–‡æ¨™é¡Œåç¨±">
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label for="introduction" class="form-label fw-bold">ç°¡ä»‹</label>
                        <textarea class="form-control" id="introduction" name="introduction" rows="3"
                                placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„ç°¡ä»‹">{% if is_edit %}{{ project.introduction }}{% endif %}</textarea>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label for="usage_guide" class="form-label fw-bold">ä½¿ç”¨æ–¹å¼</label>
                        <textarea class="form-control" id="usage_guide" name="usage_guide" rows="3"
                                placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„ä½¿ç”¨æ–¹å¼èªªæ˜">{% if is_edit %}{{ project.usage_guide }}{% endif %}</textarea>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label for="precautions" class="form-label fw-bold">æ³¨æ„äº‹é …</label>
                        <textarea class="form-control" id="precautions" name="precautions" rows="3"
                                placeholder="è¼¸å…¥æ¸¬é©—é …ç›®çš„æ³¨æ„äº‹é …">{% if is_edit %}{{ project.precautions }}{% endif %}</textarea>
                    </div>
                </div>
                
                <!-- é é¦–è³‡è¨Šå€å¡Š -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-layout-text-window-reverse me-2"></i>é é¦–è³‡è¨Š
                        </h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="header_logo" class="form-label fw-bold">Logoä¸Šå‚³</label>
                        <input type="file" class="form-control" id="header_logo" name="header_logo" accept="image/*">
                        {% if is_edit and project.header_logo %}
                            <div class="mt-2">
                                <small class="text-muted">ç›®å‰æª”æ¡ˆï¼š</small>
                                <a href="{{ project.header_logo.url }}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-image me-1"></i>æª¢è¦–ç›®å‰Logo
                                </a>
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            æ”¯æ´JPGã€PNGæ ¼å¼ï¼Œå»ºè­°å°ºå¯¸ï¼š200x80åƒç´ 
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="header_text_content" class="form-label fw-bold">é é¦–æ–‡å­—å…§å®¹</label>
                        <textarea class="form-control" id="header_text_content" name="header_text_content" rows="3"
                                placeholder="è¼¸å…¥é é¦–è¦é¡¯ç¤ºçš„æ–‡å­—å…§å®¹">{% if is_edit %}{{ project.header_text_content }}{% endif %}</textarea>
                    </div>
                </div>
                
                <!-- é å°¾è³‡è¨Šå€å¡Š -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-secondary mb-3">
                            <i class="bi bi-layout-text-window me-2"></i>é å°¾è³‡è¨Š
                        </h6>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="footer_text_content" class="form-label fw-bold">é å°¾æ–‡å­—å…§å®¹</label>
                        <textarea class="form-control" id="footer_text_content" name="footer_text_content" rows="3"
                                placeholder="è¼¸å…¥é å°¾è¦é¡¯ç¤ºçš„æ–‡å­—å…§å®¹">{% if is_edit %}{{ project.footer_text_content }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šå€‹äººåˆ†äº«å…±åŒè³‡è¨Šå€å¡Š -->
        <div class="section-basic" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
            <div class="section-header">
                <h6 class="section-title">
                    <i class="bi bi-share"></i>å€‹äººåˆ†äº«å…±åŒè³‡è¨Š
                </h6>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="personal_share_title" class="form-label fw-bold">æ¨™é¡Œåç¨±</label>
                        <input type="text" class="form-control form-control-lg" id="personal_share_title" name="personal_share_title" 
                            value="{% if is_edit %}{{ project.personal_share_title }}{% endif %}"
                            placeholder="è¼¸å…¥å€‹äººåˆ†äº«é é¢çš„æ¨™é¡Œ">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="personal_share_footer_content" class="form-label fw-bold">é å°¾å…§å®¹</label>
                        <textarea class="form-control" id="personal_share_footer_content" name="personal_share_footer_content" rows="3"
                                placeholder="è¼¸å…¥å€‹äººåˆ†äº«é é¢é å°¾è¦é¡¯ç¤ºçš„å…§å®¹">{% if is_edit %}{{ project.personal_share_footer_content }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. è©•åˆ†å’Œé æ¸¬æ¬„ä½å€å¡Š -->
        <div class="section-fields">
            <div class="section-header">
                <h6 class="section-title">
                    <i class="bi bi-sliders"></i>è©•åˆ†èˆ‡é æ¸¬æ¬„ä½è¨­å®š
                </h6>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>è©•åˆ†æ¬„ä½</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="score_field_chinese" class="form-label fw-bold">ä¸­æ–‡åç¨± <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="score_field_chinese" name="score_field_chinese" 
                                           value="{% if is_edit %}{{ project.score_field_chinese }}{% endif %}" required
                                           placeholder="ä¾‹å¦‚ï¼šç¸½åˆ†ã€èƒ½åŠ›åˆ†æ•¸">
                                </div>
                                <div class="mb-3">
                                    <label for="score_field_system" class="form-label fw-bold">ç³»çµ±åç¨± <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="score_field_system" name="score_field_system" 
                                           value="{% if is_edit %}{{ project.score_field_system }}{% endif %}" required
                                           placeholder="ä¾‹å¦‚ï¼štotal_scoreã€ability_score">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-target me-2"></i>é æ¸¬æ¬„ä½</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="prediction_field_chinese" class="form-label fw-bold">ä¸­æ–‡åç¨± <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="prediction_field_chinese" name="prediction_field_chinese" 
                                           value="{% if is_edit %}{{ project.prediction_field_chinese }}{% endif %}" required
                                           placeholder="ä¾‹å¦‚ï¼šé©åˆè·ä½ã€æ¨è–¦è§’è‰²">
                                </div>
                                <div class="mb-3">
                                    <label for="prediction_field_system" class="form-label fw-bold">ç³»çµ±åç¨± <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="prediction_field_system" name="prediction_field_system" 
                                           value="{% if is_edit %}{{ project.prediction_field_system }}{% endif %}" required
                                           placeholder="ä¾‹å¦‚ï¼šsuitable_positionã€recommended_role">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ç‰¹è³ªè¨­å®šå€å¡Š -->
        <div class="section-traits">
            <div class="section-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="section-title mb-0">
                        <i class="bi bi-stars"></i>ç‰¹è³ªè¨­å®š
                    </h6>
                    <button type="button" class="btn btn-add-trait" id="addProjectTraitBtn">
                        <i class="bi bi-plus me-1"></i>æ–°å¢ç‰¹è³ª
                    </button>
                </div>
            </div>
            <div class="section-body">
                <p class="text-muted mb-4 small">
                    å…ˆé¸æ“‡æ­¤æ¸¬é©—æœƒä½¿ç”¨çš„ç‰¹è³ªï¼Œå¿…è¦æ™‚å‹¾é¸è‡ªè¨‚æè¿°ã€‚åˆ†é¡ä¸­çš„ç‰¹è³ªæè¿°å°‡åŒæ­¥å¼•ç”¨æ­¤è™•è¨­å®šã€‚
                </p>
                <div id="projectTraitsContainer" class="project-traits-container"></div>
                <div id="noProjectTraitsHint" class="alert alert-warning mt-3" role="alert" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>å°šæœªè¨­å®šä»»ä½•ç‰¹è³ªï¼Œè«‹å…ˆæ–°å¢ä»¥ä¾›åˆ†é¡é¸æ“‡ã€‚
                </div>
            </div>
        </div>

        <!-- 4. åˆ†é¡è¨­å®šå€å¡Š -->
        <div class="section-categories">
            <div class="section-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="section-title mb-0">
                        <i class="bi bi-list-check"></i>åˆ†é¡è¨­å®š
                    </h6>
                    <button type="button" class="btn btn-add-category" id="addCategoryBtn">
                        <i class="bi bi-plus-circle me-2"></i>æ–°å¢åˆ†é¡
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="categoriesContainer">
                    <!-- å‹•æ…‹åˆ†é¡å°‡åœ¨é€™è£¡æ’å…¥ -->
                </div>
                <div class="text-center text-muted" id="noCategoriesHint">
                    <i class="bi bi-folder-plus" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢åˆ†é¡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ¸¬é©—åˆ†é¡</p>
                </div>
            </div>
        </div>

        <!-- 5. æŒ‡æ´¾è¨­å®šå€å¡Š -->
        <div class="section-assignment">
            <div class="section-header">
                <h6 class="section-title">
                    <i class="bi bi-people"></i>ç”¨æˆ¶æŒ‡æ´¾è¨­å®š
                </h6>
            </div>
            <div class="section-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="assignment_type" class="form-label fw-bold">æŒ‡æ´¾é¡å‹</label>
                        <select class="form-select form-select-lg" id="assignment_type" name="assignment_type">
                            <option value="">è«‹é¸æ“‡æŒ‡æ´¾é¡å‹</option>
                            <option value="all_open" {% if is_edit and project.assignment_type == 'all_open' %}selected{% endif %}>ğŸŒ å…¨éƒ¨é–‹æ”¾</option>
                            <option value="enterprise_only" {% if is_edit and project.assignment_type == 'enterprise_only' %}selected{% endif %}>ğŸ¢ åƒ…é–‹æ”¾çµ¦ä¼æ¥­</option>
                            <option value="individual_only" {% if is_edit and project.assignment_type == 'individual_only' %}selected{% endif %}>ğŸ‘¤ åƒ…é–‹æ”¾çµ¦å€‹äºº</option>
                            <option value="specific_assignment" {% if is_edit and project.assignment_type == 'specific_assignment' %}selected{% endif %}>ğŸ¯ æŒ‡å®šé–‹æ”¾</option>
                        </select>
                    </div>
                </div>
                
                <!-- ä¼æ¥­ç”¨æˆ¶é¸æ“‡ -->
                <div id="enterpriseSelection" style="display: none;">
                    <div class="enterprise-section">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-building me-2"></i>é¸æ“‡ä¼æ¥­ç”¨æˆ¶
                        </h6>
                        {% if enterprises %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="selectAllEnterprises">
                                <label class="form-check-label fw-bold" for="selectAllEnterprises">
                                    <i class="bi bi-check-all me-1"></i>å…¨é¸ä¼æ¥­ç”¨æˆ¶ ({{ enterprises.count }} å®¶)
                                </label>
                            </div>
                            <div class="user-selection-container">
                                {% for enterprise in enterprises %}
                                <div class="user-checkbox-item">
                                    <div class="form-check">
                                        <input class="form-check-input enterprise-checkbox" type="checkbox" 
                                               name="assigned_enterprises" value="{{ enterprise.id }}"
                                               id="enterprise_{{ enterprise.id }}"
                                               {% if is_edit and enterprise.id in assigned_enterprise_ids %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="enterprise_{{ enterprise.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong class="text-primary">{{ enterprise.enterprise_profile.company_name }}</strong>
                                                    <div class="small text-muted mt-1">
                                                        <i class="bi bi-person-badge me-1"></i>{{ enterprise.enterprise_profile.contact_person }}
                                                        <i class="bi bi-envelope ms-3 me-1"></i>{{ enterprise.email }}
                                                    </div>
                                                    <div class="small text-muted">
                                                        <i class="bi bi-building me-1"></i>çµ±ç·¨ï¼š{{ enterprise.enterprise_profile.tax_id }}
                                                    </div>
                                                </div>
                                                <span class="badge bg-warning">ä¼æ¥­</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                ç›®å‰æ²’æœ‰å·²å¯©æ ¸é€šéçš„ä¼æ¥­ç”¨æˆ¶å¯ä¾›æŒ‡æ´¾
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- å€‹äººç”¨æˆ¶é¸æ“‡ -->
                <div id="individualSelection" style="display: none;">
                    <div class="individual-section">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-person me-2"></i>é¸æ“‡å€‹äººç”¨æˆ¶
                        </h6>
                        {% if individuals %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="selectAllIndividuals">
                                <label class="form-check-label fw-bold" for="selectAllIndividuals">
                                    <i class="bi bi-check-all me-1"></i>å…¨é¸å€‹äººç”¨æˆ¶ ({{ individuals.count }} ä½)
                                </label>
                            </div>
                            <div class="user-selection-container">
                                {% for individual in individuals %}
                                <div class="user-checkbox-item">
                                    <div class="form-check">
                                        <input class="form-check-input individual-checkbox" type="checkbox" 
                                               name="assigned_individuals" value="{{ individual.id }}"
                                               id="individual_{{ individual.id }}"
                                               {% if is_edit and individual.id in assigned_individual_ids %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="individual_{{ individual.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong class="text-success">{{ individual.individual_profile.real_name }}</strong>
                                                    <div class="small text-muted mt-1">
                                                        <i class="bi bi-person-circle me-1"></i>{{ individual.username }}
                                                        <i class="bi bi-envelope ms-3 me-1"></i>{{ individual.email }}
                                                    </div>
                                                </div>
                                                <span class="badge bg-success">å€‹äºº</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                ç›®å‰æ²’æœ‰å·²é©—è­‰çš„å€‹äººç”¨æˆ¶å¯ä¾›æŒ‡æ´¾
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- éš±è—æ¬„ä½ -->
        <input type="hidden" id="project_traits_data" name="project_traits_data">
        <input type="hidden" id="categories_data" name="categories_data">
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="sticky-action-bar">
            <div class="card action-card">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row align-items-stretch align-items-md-center justify-content-md-between gap-3">
                        <a href="{% url 'test_project_list' %}" class="btn btn-outline-secondary btn-lg flex-fill flex-md-grow-0">
                            <i class="bi bi-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
                        </a>
                        <div class="d-flex justify-content-end gap-3 flex-fill flex-md-grow-0">
                            <button type="button" class="btn btn-outline-info btn-lg" id="previewBtn">
                                <i class="bi bi-eye me-2"></i>é è¦½è¨­å®š
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>
                                {% if is_edit %}æ›´æ–°æ¸¬é©—é …ç›®{% else %}å»ºç«‹æ¸¬é©—é …ç›®{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- æ¸¬é©—ç‰¹è³ªæ¨¡æ¿ -->
<template id="projectTraitTemplate">
    <div class="project-trait-item" data-project-trait-index="">
        <div class="project-trait-header d-flex justify-content-between align-items-center">
            <span class="project-trait-number-badge">ç‰¹è³ª <span class="project-trait-number"></span></span>
            <button type="button" class="btn btn-remove btn-sm" title="åˆªé™¤æ­¤ç‰¹è³ª">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="row g-3 align-items-start">
            <div class="col-md-6">
                <label class="form-label small fw-bold">é¸æ“‡ç‰¹è³ª <span class="text-danger">*</span></label>
                <select class="form-select project-trait-select">
                    <option value="">è«‹é¸æ“‡ç‰¹è³ª</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">ä¸­æ–‡åç¨±</label>
                <input type="text" class="form-control form-control-sm project-trait-chinese-name" readonly placeholder="--">
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">ç³»çµ±åç¨±</label>
                <input type="text" class="form-control form-control-sm project-trait-system-name" readonly placeholder="--">
            </div>
        </div>
        <div class="mt-3">
            <label class="form-label small fw-bold">ç‰¹è³ªæè¿°</label>
            <div class="project-trait-description-preview mb-2">
                <span class="text-muted">é è¨­æè¿°ï¼š</span>
                <span class="project-trait-default-description text-dark">å°šæœªé¸æ“‡ç‰¹è³ª</span>
            </div>
            <div class="form-check form-switch mb-2">
                <input class="form-check-input custom-desc-toggle" type="checkbox" role="switch">
                <label class="form-check-label small">ä½¿ç”¨è‡ªè¨‚æè¿°</label>
            </div>
            <textarea class="form-control project-trait-custom-description" rows="4" placeholder="è¼¸å…¥æ­¤æ¸¬é©—å°ˆå±¬çš„ç‰¹è³ªæè¿°" disabled></textarea>
            <div class="form-text">åˆ†é¡ä¸­ç›¸åŒç‰¹è³ªçš„æè¿°æœƒåŒæ­¥å¼•ç”¨æ­¤è™•è¨­å®šã€‚</div>
        </div>
    </div>
</template>

<!-- åˆ†é¡æ¨¡æ¿ -->
<template id="categoryTemplate">
    <div class="category-item" data-category-index="">
        <div class="category-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="category-number-badge">åˆ†é¡ <span class="category-number"></span></span>
                </div>
                <button type="button" class="btn btn-remove" onclick="removeCategory(this)" title="åˆªé™¤æ­¤åˆ†é¡">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">åˆ†é¡å®Œæ•´åç¨± <span class="text-danger">*</span></label>
                <input type="text" class="form-control category-name" required
                    placeholder="è¼¸å…¥åˆ†é¡çš„å®Œæ•´åç¨±">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">è‹±æ–‡åç¨±</label>
                <input type="text" class="form-control category-english-name"
                    placeholder="è¼¸å…¥åˆ†é¡çš„è‹±æ–‡åç¨±">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-12 mb-3">
                <label class="form-label fw-bold">èªªæ˜</label>
                <textarea class="form-control category-description" rows="3"
                    placeholder="è¼¸å…¥åˆ†é¡çš„è©³ç´°èªªæ˜"></textarea>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šè§’è‰²ç›¸é—œæ¬„ä½ -->
        <div class="row mb-3">
            <div class="col-12">
                <h6 class="text-info mb-3">
                    <i class="bi bi-person-badge me-2"></i>è§’è‰²è³‡è¨Š
                </h6>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">è§’è‰²åç¨±</label>
                <input type="text" class="form-control role-name"
                    placeholder="è¼¸å…¥è§’è‰²åç¨±">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Tagæ–‡å­—</label>
                <input type="text" class="form-control tag-text"
                    placeholder="è¼¸å…¥æ¨™ç±¤æ–‡å­—">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">åˆ†æ•¸é¡å‹åç¨±</label>
                <input type="text" class="form-control score-type-name"
                    placeholder="è¼¸å…¥åˆ†æ•¸é¡å‹åç¨±">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">è§’è‰²åœ–ç‰‡</label>
                <input type="file" class="form-control role-image" accept="image/*">
                <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    æ”¯æ´JPGã€PNGæ ¼å¼ï¼Œå»ºè­°å°ºå¯¸ï¼š300x300åƒç´ 
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">å…§å®¹</label>
                <textarea class="form-control category-content" rows="3"
                          placeholder="æè¿°æ­¤è§’è‰²çš„è©³ç´°å…§å®¹"></textarea>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">å„ªå‹¢å»ºè­°</label>
                <textarea class="form-control advantage-suggestions" rows="3"
                          placeholder="æè¿°æ­¤è§’è‰²çš„å„ªå‹¢å»ºè­°"></textarea>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">ç™¼å±•æ–¹å‘</label>
                <textarea class="form-control development-direction" rows="3"
                          placeholder="æè¿°æ­¤è§’è‰²çš„ç™¼å±•æ–¹å‘"></textarea>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold text-success">å„ªå‹¢åˆ†æèªªæ˜</label>
                <textarea class="form-control advantage-analysis" rows="4"
                          placeholder="æè¿°æ­¤åˆ†é¡çš„å„ªå‹¢ç‰¹é»å’Œæ­£é¢è¡¨ç¾"></textarea>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold text-warning">åŠ£å‹¢åˆ†æèªªæ˜</label>
                <textarea class="form-control disadvantage-analysis" rows="4"
                          placeholder="æè¿°æ­¤åˆ†é¡çš„åŠ£å‹¢ç‰¹é»å’Œéœ€è¦æ”¹é€²çš„åœ°æ–¹"></textarea>
            </div>
        </div>
        
        <!-- ç™¼å±•å»ºè­°åƒæ•¸è¨­å®š -->
        <div class="row mb-3">
            <div class="col-12">
                <h6 class="text-primary fw-bold mb-3">
                    <i class="bi bi-lightbulb me-2"></i>ç™¼å±•å»ºè­°åƒæ•¸è¨­å®š
                </h6>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold text-info">åƒæ•¸åç¨±</label>
                <input type="text" class="form-control development-parameter-name" 
                       placeholder="ä¾‹å¦‚ï¼šç™¼å±•æ¨è–¦ã€æ”¹å–„å»ºè­°ç­‰">
                <div class="form-text">æ­¤æ¬„ä½åç¨±æœƒé¡¯ç¤ºåœ¨æ¸¬é©—çµæœä¸­ä½œç‚ºæ¨™é¡Œ</div>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold text-info">å…§å®¹</label>
                <textarea class="form-control development-parameter-content" rows="3"
                          placeholder="è¼¸å…¥è©²åƒæ•¸çš„å…·é«”å…§å®¹å’Œå»ºè­°"></textarea>
                <div class="form-text">æ­¤å…§å®¹æœƒåœ¨è©²åˆ†é¡ç‚ºæœ€é«˜åˆ†æ™‚é¡¯ç¤ºçµ¦å—æ¸¬è€…</div>
            </div>
        </div>
        
        <!-- ç‰¹è³ªå€åŸŸ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3 sticky-category-trait">
                <h6 class="mb-0 text-secondary d-flex align-items-center gap-2">
                    <i class="bi bi-tags"></i><span>ç‰¹è³ªè¨­å®š</span>
                </h6>
                <button type="button" class="btn btn-add-trait btn-sm" onclick="addTrait(this)">
                    <i class="bi bi-plus me-1"></i>æ–°å¢ç‰¹è³ª
                </button>
            </div>
            <div class="traits-container">
                <!-- ç‰¹è³ªå°‡åœ¨é€™è£¡æ’å…¥ -->
            </div>
        </div>
    </div>
</template>

<!-- ç‰¹è³ªæ¨¡æ¿ -->
<template id="traitTemplate">
    <div class="trait-item" data-trait-index="">
        <div class="trait-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>ç‰¹è³ª <span class="trait-number"></span></span>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="removeTrait(this)" title="åˆªé™¤æ­¤ç‰¹è³ª">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        
        <div class="row g-2 align-items-start">
            <div class="col-md-8 mb-2">
                <label class="form-label small fw-bold">é¸æ“‡ç‰¹è³ª <span class="text-danger">*</span></label>
                <select class="form-select form-select-sm trait-select">
                    <option value="">è«‹é¸æ“‡ç‰¹è³ª</option>
                </select>
                <div class="form-text">é¸æ“‡å¾Œå°‡è‡ªå‹•å¸¶å‡ºç‰¹è³ªè³‡è¨Š</div>
            </div>
            <div class="col-md-4 mb-2">
                <label class="form-label small fw-bold">æ¬Šé‡</label>
                <input type="number" class="form-control form-control-sm trait-weight" step="0.01"
                       value="1" placeholder="è¨­å®šæ­¤ç‰¹è³ªçš„æ¬Šé‡">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label small fw-bold">ä¸­æ–‡ç‰¹è³ªåç¨±</label>
                <input type="text" class="form-control form-control-sm trait-chinese-name" readonly placeholder="--">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label small fw-bold">ç³»çµ±å°æ‡‰åç¨±</label>
                <input type="text" class="form-control form-control-sm trait-system-name" readonly placeholder="--">
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-2">
                <label class="form-label small fw-bold">ç‰¹è³ªæè¿°</label>
                <textarea class="form-control form-control-sm trait-description" rows="6" readonly
                          placeholder="é¸æ“‡ç‰¹è³ªå¾Œæœƒé¡¯ç¤ºæè¿°"></textarea>
            </div>
        </div>
    </div>
</template>

<script>
// å…¨å±€è®Šé‡
let categoryIndex = 0;
let categoriesData = {% if is_edit %}{{ categories_json|safe }}{% else %}[]{% endif %};
let projectTraitsData = {{ project_traits_json|default:"[]"|safe }};
let availableTraits = {{ available_traits_json|default:"[]"|safe }};

if (!Array.isArray(categoriesData)) {
    categoriesData = [];
}
if (!Array.isArray(projectTraitsData)) {
    projectTraitsData = [];
}
if (!Array.isArray(availableTraits)) {
    availableTraits = [];
}

const traitLookup = new Map();
availableTraits.forEach(trait => {
    const key = String(trait.id);
    traitLookup.set(key, trait);
});

let projectTraitSelectionMap = new Map();
const SCROLL_OFFSET_DEFAULT = 220;
const SCROLL_OFFSET_PROJECT_TRAIT = 140;
const SCROLL_STORAGE_KEY = 'testProjectFormScroll_' + window.location.pathname;
let pendingScrollPosition = null;
let scrollRestored = false;

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');

    const savedScroll = sessionStorage.getItem(SCROLL_STORAGE_KEY);
    if (savedScroll !== null) {
        const target = parseInt(savedScroll, 10);
        if (!Number.isNaN(target)) {
            pendingScrollPosition = target;
        }
        sessionStorage.removeItem(SCROLL_STORAGE_KEY);
    }

    setTimeout(function() {
        initializeTinyMCE();
    }, 1000);

    initializeProjectTraitsSection();

    const addProjectTraitBtn = document.getElementById('addProjectTraitBtn');
    if (addProjectTraitBtn) {
        addProjectTraitBtn.addEventListener('click', function() {
            const newTraitElement = addProjectTrait(null, { focus: true });
            refreshProjectTraitOptions();
            if (newTraitElement) {
                flashHighlight(newTraitElement);
            }
        });
    }

    // Trait options must be ready before loading categories
    refreshProjectTraitOptions();

    const addCategoryBtn = document.getElementById('addCategoryBtn');
    if (addCategoryBtn) {
        addCategoryBtn.addEventListener('click', function() {
            const newCategoryElement = addCategory(null, { focus: true });
            if (newCategoryElement) {
                flashHighlight(newCategoryElement);
            }

            setTimeout(function() {
                initializeCategoryTinyMCE(categoryIndex - 1);
            }, 500);
        });
    }

    if (categoriesData.length > 0) {
        categoriesData.forEach(function(categoryData) {
            addCategory(categoryData);
        });
        updateNoContentHint();
        scheduleScrollRestore();
    } else {
        updateNoContentHint();
        scheduleScrollRestore();
    }

    const assignmentTypeSelect = document.getElementById('assignment_type');
    if (assignmentTypeSelect) {
        assignmentTypeSelect.addEventListener('change', function() {
            toggleAssignmentSelection();
            updateProgressSteps();
        });
        toggleAssignmentSelection();
    }

    const radarModeRadios = document.querySelectorAll('input[name="radar_mode"]');
    const mixedRoleOption = document.getElementById('mixedRoleOption');

    function updateMixedRoleVisibility() {
        if (!mixedRoleOption) {
            return;
        }
        const selected = document.querySelector('input[name="radar_mode"]:checked');
        const isRoleMode = selected && selected.value === 'role';
        mixedRoleOption.classList.toggle('d-none', !isRoleMode);
        if (!isRoleMode) {
            const checkbox = mixedRoleOption.querySelector('#show_mixed_role');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    }

    radarModeRadios.forEach(radio => {
        radio.addEventListener('change', updateMixedRoleVisibility);
    });
    updateMixedRoleVisibility();

    const selectAllEnterprises = document.getElementById('selectAllEnterprises');
    if (selectAllEnterprises) {
        selectAllEnterprises.addEventListener('change', function() {
            document.querySelectorAll('.enterprise-checkbox').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    const selectAllIndividuals = document.getElementById('selectAllIndividuals');
    if (selectAllIndividuals) {
        selectAllIndividuals.addEventListener('change', function() {
            document.querySelectorAll('.individual-checkbox').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    document.getElementById('name').addEventListener('input', updateProgressSteps);
    document.getElementById('test_link').addEventListener('input', updateProgressSteps);
    document.getElementById('job_role_system_name').addEventListener('input', updateProgressSteps);
    document.getElementById('description').addEventListener('input', updateProgressSteps);
    document.getElementById('score_field_chinese').addEventListener('input', updateProgressSteps);
    document.getElementById('score_field_system').addEventListener('input', updateProgressSteps);
    document.getElementById('prediction_field_chinese').addEventListener('input', updateProgressSteps);
    document.getElementById('prediction_field_system').addEventListener('input', updateProgressSteps);

    const testProjectForm = document.getElementById('testProjectForm');
    if (testProjectForm) {
        testProjectForm.addEventListener('submit', function() {
            try {
                const currentScroll = window.scrollY || window.pageYOffset || 0;
                sessionStorage.setItem(SCROLL_STORAGE_KEY, String(currentScroll));
            } catch (error) {
                console.warn('ä¿å­˜å·è»¸ä½ç½®å¤±æ•—:', error);
            }
            collectProjectTraitsData();
            collectCategoriesData();
        });
    }

    const previewBtn = document.getElementById('previewBtn');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            collectProjectTraitsData();
            collectCategoriesData();
            showPreviewModal();
        });
    }

    setTimeout(updateProgressSteps, 100);
});

// æ›´æ–°é€²åº¦æŒ‡ç¤ºå™¨
function updateProgressSteps() {
    const steps = document.querySelectorAll('.progress-step');
    const lines = document.querySelectorAll('.progress-line');
    
    // æª¢æŸ¥å„æ­¥é©Ÿå®Œæˆç‹€æ…‹
    const step1Complete = document.getElementById('name').value.trim() !== '' && 
                          document.getElementById('test_link').value.trim() !== '' && 
                          document.getElementById('job_role_system_name').value.trim() !== '';
    const step2Complete = document.getElementById('score_field_chinese').value.trim() !== '' && 
                          document.getElementById('prediction_field_chinese').value.trim() !== '';
    
    // åªæœ‰ç•¶åˆ†é¡æœ‰å¯¦éš›å…§å®¹æ‰ç®—å®Œæˆï¼ˆä¸åªæ˜¯æ•¸é‡ï¼‰
    const categoryItems = document.querySelectorAll('.category-item');
    let step3Complete = false;

    if (categoryItems.length > 0) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•åˆ†é¡å¡«å¯«äº†åç¨±æˆ–é€£çµ
        step3Complete = Array.from(categoryItems).some(item => {
            const name = item.querySelector('.category-name')?.value?.trim();
            const link = item.querySelector('.category-link')?.value?.trim();
            return name || link;
        });
    }
    
    // æ­¥é©Ÿ4ï¼šæª¢æŸ¥æŒ‡æ´¾é¡å‹æ˜¯å¦æœ‰é¸æ“‡ï¼ˆä¸èƒ½æ˜¯ç©ºå€¼ï¼‰
    const assignmentTypeValue = document.getElementById('assignment_type').value;
    const step4Complete = assignmentTypeValue !== '';
    
    const completionStates = [step1Complete, step2Complete, step3Complete, step4Complete];
    
    console.log('é€²åº¦æª¢æŸ¥:', {
        step1: step1Complete,
        step2: step2Complete, 
        step3: step3Complete,
        step4: step4Complete,
        assignmentTypeValue: assignmentTypeValue
    });
    
    // æ›´æ–°æ­¥é©Ÿç‹€æ…‹ - é‡è¦ï¼šåªæœ‰å‰ä¸€æ­¥å®Œæˆæ‰èƒ½é€²å…¥ä¸‹ä¸€æ­¥
    steps.forEach((step, index) => {
        const circle = step.querySelector('.progress-step-circle');
        const isComplete = completionStates[index];
        
        // ä¿®æ”¹é‚è¼¯ï¼šåªæœ‰å‰é¢æ‰€æœ‰æ­¥é©Ÿéƒ½å®Œæˆï¼Œç•¶å‰æ­¥é©Ÿæ‰èƒ½æ˜¯ active
        const canBeActive = index === 0 || completionStates.slice(0, index).every(state => state);
        const isActive = !isComplete && canBeActive;
        
        step.classList.remove('completed', 'active', 'pending');
        
        if (isComplete && canBeActive) {
            step.classList.add('completed');
            circle.innerHTML = '<i class="bi bi-check"></i>';
        } else if (isActive) {
            step.classList.add('active');
            // æ ¹æ“šæ­¥é©Ÿè¨­ç½®ä¸åŒåœ–æ¨™
            const icons = ['bi-info-circle', 'bi-sliders', 'bi-list-check', 'bi-people'];
            circle.innerHTML = `<i class="bi ${icons[index]}"></i>`;
        } else {
            step.classList.add('pending');
            const icons = ['bi-info-circle', 'bi-sliders', 'bi-list-check', 'bi-people'];
            circle.innerHTML = `<i class="bi ${icons[index]}"></i>`;
        }
    });
    
    // æ›´æ–°é€£æ¥ç·šç‹€æ…‹ - åªæœ‰ç•¶å‰æ­¥é©Ÿå’Œå‰ä¸€æ­¥éƒ½å®Œæˆæ™‚ï¼Œç·šæ‰è®Šç¶ 
    lines.forEach((line, index) => {
        line.classList.remove('completed', 'pending');
        if (completionStates[index] && (index === 0 || completionStates.slice(0, index).every(state => state))) {
            line.classList.add('completed');
        } else {
            line.classList.add('pending');
        }
    });
}

function updateStepStatus(stepElement, isComplete, canActivate) {
    // é€™å€‹å‡½æ•¸å·²ç¶“è¢«ä¸Šé¢çš„ updateProgressSteps å–ä»£ï¼Œå¯ä»¥ç§»é™¤
}

// åˆ‡æ›æŒ‡æ´¾é¸æ“‡é¡¯ç¤º
function toggleAssignmentSelection() {
    const assignmentType = document.getElementById('assignment_type').value;
    const enterpriseSelection = document.getElementById('enterpriseSelection');
    const individualSelection = document.getElementById('individualSelection');
    
    console.log('æŒ‡æ´¾é¡å‹è®Šæ›´ç‚º:', assignmentType);
    
    // éš±è—æ‰€æœ‰é¸æ“‡å€åŸŸ
    if (enterpriseSelection) enterpriseSelection.style.display = 'none';
    if (individualSelection) individualSelection.style.display = 'none';
    
    if (assignmentType === 'specific_assignment') {
        // æŒ‡å®šé–‹æ”¾æ™‚ï¼Œé¡¯ç¤ºä¼æ¥­å’Œå€‹äººé¸æ“‡
        console.log('é¡¯ç¤ºä¼æ¥­å’Œå€‹äººé¸æ“‡');
        if (enterpriseSelection) enterpriseSelection.style.display = 'block';
        if (individualSelection) individualSelection.style.display = 'block';
    }
}

// ====== æ¸¬é©—ç‰¹è³ªè¨­å®šç›¸é—œå‡½æ•¸ ======
function initializeProjectTraitsSection() {
    const container = document.getElementById('projectTraitsContainer');
    if (!container) {
        return;
    }

    projectTraitsData.sort((a, b) => {
        const orderA = typeof a.sort_order === 'number' ? a.sort_order : 0;
        const orderB = typeof b.sort_order === 'number' ? b.sort_order : 0;
        return orderA - orderB;
    });

    if (projectTraitsData.length > 0) {
        projectTraitsData.forEach(data => addProjectTrait(data));
    } else {
        updateProjectTraitsHint();
    }
}

function updateProjectTraitsHint() {
    const container = document.getElementById('projectTraitsContainer');
    const hint = document.getElementById('noProjectTraitsHint');
    if (!hint) {
        return;
    }
    const hasItems = container && container.children.length > 0;
    hint.style.display = hasItems ? 'none' : 'block';
}

function addProjectTrait(traitData = null, options = {}) {
    const template = document.getElementById('projectTraitTemplate');
    const container = document.getElementById('projectTraitsContainer');
    const focusNewItem = Boolean(options.focus);

    if (!template || !container) {
        console.error('æ‰¾ä¸åˆ°ç‰¹è³ªè¨­å®šæ¨¡æ¿æˆ–å®¹å™¨');
        return;
    }

    const clone = template.content.cloneNode(true);
    const traitItem = clone.querySelector('.project-trait-item');
    const traitNumber = clone.querySelector('.project-trait-number');
    const currentIndex = container.children.length;

    traitItem.setAttribute('data-project-trait-index', currentIndex);
    if (traitNumber) {
        traitNumber.textContent = currentIndex + 1;
    }

    const select = clone.querySelector('.project-trait-select');
    const toggle = clone.querySelector('.custom-desc-toggle');
    const textarea = clone.querySelector('.project-trait-custom-description');
    const removeBtn = clone.querySelector('.btn-remove');

    const presetTraitId = traitData && traitData.trait_id ? String(traitData.trait_id) : '';

    if (select) {
        populateProjectTraitSelect(select, presetTraitId);
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            traitItem.dataset.selectedTraitId = String(selectedValue || '');
            if (toggle) {
                toggle.checked = false;
            }
            if (textarea) {
                textarea.value = '';
                textarea.disabled = true;
            }
            updateProjectTraitDetails(traitItem, selectedValue);
            refreshProjectTraitOptions();
        });
    }

    if (toggle) {
        toggle.addEventListener('change', function() {
            if (textarea) {
                textarea.disabled = !this.checked;
            }
            refreshProjectTraitOptions();
        });
    }

    if (textarea) {
        textarea.addEventListener('input', function() {
            refreshProjectTraitOptions();
        });
    }

    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            removeProjectTrait(this);
        });
    }

    container.appendChild(clone);

    const appendedItem = container.lastElementChild;
    const appendedSelect = appendedItem.querySelector('.project-trait-select');
    const appendedToggle = appendedItem.querySelector('.custom-desc-toggle');
    const appendedTextarea = appendedItem.querySelector('.project-trait-custom-description');

    if (presetTraitId && appendedSelect) {
        appendedSelect.value = presetTraitId;
        appendedItem.dataset.selectedTraitId = presetTraitId;
    }

    if (appendedToggle && appendedTextarea) {
        const useCustom = traitData ? Boolean(traitData.use_custom_description) : false;
        appendedToggle.checked = useCustom;
        appendedTextarea.disabled = !useCustom;
        appendedTextarea.value = traitData && traitData.custom_description ? traitData.custom_description : '';
    }

    updateProjectTraitDetails(appendedItem, presetTraitId);
    updateProjectTraitNumbers();
    updateProjectTraitsHint();
    refreshProjectTraitOptions();

    if (focusNewItem && appendedItem) {
        scrollIntoViewWithOffset(appendedItem, SCROLL_OFFSET_PROJECT_TRAIT);
    }

    return appendedItem;
}

function removeProjectTrait(button) {
    const traitItem = button.closest('.project-trait-item');
    if (!traitItem) {
        return;
    }

    if (traitItem.dataset.deleting === '1') {
        return;
    }

    const traitId = traitItem.dataset.selectedTraitId;
    let traitName = traitItem.querySelector('.project-trait-chinese-name')?.value?.trim() || '';
    if (!traitName && traitId) {
        const lookupData = traitLookup.get(String(traitId));
        traitName = lookupData?.chinese_name || lookupData?.system_name || traitName;
    }

    if (traitId) {
        const relatedItems = Array.from(document.querySelectorAll('#categoriesContainer .trait-item'))
            .filter(item => {
                const select = item.querySelector('.trait-select');
                return select && select.value === String(traitId);
            });

        if (relatedItems.length > 0) {
            const firstRelated = relatedItems[0];
            flashHighlight(firstRelated);
            scrollIntoViewWithOffset(firstRelated);

            const confirmationName = traitName ? `ç‰¹è³ªã€Œ${traitName}ã€` : 'æ­¤ç‰¹è³ª';
            const shouldRemove = window.confirm(`${confirmationName}å·²è¢«ä½¿ç”¨ï¼Œç¢ºå®šåˆªé™¤å—ï¼Ÿ`);
            if (!shouldRemove) {
                return;
            }

            traitItem.dataset.deleting = '1';

            const containersToUpdate = new Set();
            relatedItems.forEach(item => {
                const container = item.closest('.traits-container');
                item.remove();
                if (container) {
                    containersToUpdate.add(container);
                }
            });
            containersToUpdate.forEach(container => updateTraitNumbers(container));
        } else {
            traitItem.dataset.deleting = '1';
        }
    } else {
        traitItem.dataset.deleting = '1';
    }

    traitItem.remove();
    updateProjectTraitNumbers();
    updateProjectTraitsHint();
    refreshProjectTraitOptions();
}

function updateProjectTraitNumbers() {
    const container = document.getElementById('projectTraitsContainer');
    if (!container) {
        return;
    }
    const items = container.querySelectorAll('.project-trait-item');
    items.forEach((item, index) => {
        item.setAttribute('data-project-trait-index', index);
        const number = item.querySelector('.project-trait-number');
        if (number) {
            number.textContent = index + 1;
        }
    });
}

function populateProjectTraitSelect(select, selectedId = '') {
    if (!select) {
        return;
    }

    const usedIds = new Set();
    document.querySelectorAll('.project-trait-select').forEach(otherSelect => {
        const value = otherSelect.value;
        if (value) {
            usedIds.add(String(value));
        }
    });

    if (selectedId) {
        usedIds.delete(String(selectedId));
    }

    select.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = availableTraits.length > 0 ? 'è«‹é¸æ“‡ç‰¹è³ª' : 'å°šæœªå»ºç«‹ç‰¹è³ª';
    select.appendChild(placeholder);

    if (availableTraits.length === 0) {
        select.disabled = true;
        return;
    }

    availableTraits.forEach(trait => {
        const option = document.createElement('option');
        const value = String(trait.id);
        option.value = value;
        option.textContent = `${trait.chinese_name} (${trait.system_name})`;
        if (usedIds.has(value)) {
            option.disabled = true;
        }
        select.appendChild(option);
    });

    select.disabled = false;
    if (selectedId) {
        select.value = String(selectedId);
    }
}

function updateProjectTraitDetails(traitItem, traitId) {
    const chineseInput = traitItem.querySelector('.project-trait-chinese-name');
    const systemInput = traitItem.querySelector('.project-trait-system-name');
    const defaultDescription = traitItem.querySelector('.project-trait-default-description');
    const toggle = traitItem.querySelector('.custom-desc-toggle');
    const textarea = traitItem.querySelector('.project-trait-custom-description');

    const key = String(traitId || '');
    const traitData = traitLookup.get(key);

    if (traitData) {
        if (chineseInput) {
            chineseInput.value = traitData.chinese_name || '';
        }
        if (systemInput) {
            systemInput.value = traitData.system_name || '';
        }
        if (defaultDescription) {
            defaultDescription.textContent = traitData.description ? traitData.description : 'æ­¤ç‰¹è³ªæ²’æœ‰æè¿°';
        }
    } else {
        if (chineseInput) {
            chineseInput.value = '';
        }
        if (systemInput) {
            systemInput.value = '';
        }
        if (defaultDescription) {
            defaultDescription.textContent = 'å°šæœªé¸æ“‡ç‰¹è³ª';
        }
    }

    if (textarea) {
        textarea.disabled = !(toggle && toggle.checked);
    }
}

function getProjectTraitSelections() {
    const selections = [];
    const container = document.getElementById('projectTraitsContainer');
    if (!container) {
        return selections;
    }

    container.querySelectorAll('.project-trait-item').forEach((item, index) => {
        const select = item.querySelector('.project-trait-select');
        if (!select || !select.value) {
            return;
        }

        const traitId = parseInt(select.value, 10);
        if (isNaN(traitId)) {
            return;
        }

        const baseData = traitLookup.get(String(select.value));
        const toggle = item.querySelector('.custom-desc-toggle');
        const textarea = item.querySelector('.project-trait-custom-description');

        const useCustom = toggle ? toggle.checked : false;
        const customDescription = textarea ? textarea.value : '';
        const defaultDescription = baseData ? (baseData.description || '') : '';
        const effectiveDescription = useCustom && customDescription ? customDescription : defaultDescription;

        selections.push({
            trait_id: traitId,
            chinese_name: baseData ? baseData.chinese_name : '',
            system_name: baseData ? baseData.system_name : '',
            default_description: defaultDescription,
            use_custom_description: useCustom,
            custom_description: customDescription,
            description: effectiveDescription,
            sort_order: index
        });
    });

    return selections;
}

function flashHighlight(element) {
    if (!element) {
        return;
    }
    element.classList.add('highlight-flash');
    setTimeout(() => {
        element.classList.remove('highlight-flash');
    }, 1500);
}

function scrollIntoViewWithOffset(element, offset = SCROLL_OFFSET_DEFAULT) {
    if (!element) {
        return;
    }

    window.requestAnimationFrame(() => {
        const rect = element.getBoundingClientRect();
        const absoluteTop = window.pageYOffset + rect.top;
        window.scrollTo({
            top: Math.max(absoluteTop - offset, 0),
            behavior: 'smooth',
        });
    });
}

function refreshProjectTraitOptions() {
    const selections = getProjectTraitSelections();
    projectTraitSelectionMap = new Map();
    selections.forEach(item => {
        projectTraitSelectionMap.set(String(item.trait_id), item);
    });

    document.querySelectorAll('.project-trait-select').forEach(select => {
        const currentValue = select.value;
        populateProjectTraitSelect(select, currentValue);
        if (currentValue) {
            select.value = currentValue;
        }
    });

    document.querySelectorAll('.trait-item').forEach(traitItem => {
        const select = traitItem.querySelector('.trait-select');
        if (!select) {
            return;
        }
        const currentValue = select.value;
        populateCategoryTraitSelect(select);
        if (currentValue && projectTraitSelectionMap.has(String(currentValue))) {
            select.value = currentValue;
        } else {
            select.value = '';
        }
        updateTraitDetails(traitItem, select.value);
    });

    updateProjectTraitsHint();
}

function collectProjectTraitsData() {
    const selections = getProjectTraitSelections();
    const input = document.getElementById('project_traits_data');
    if (!input) {
        return selections;
    }
    const payload = selections.map(item => ({
        trait_id: item.trait_id,
        use_custom_description: item.use_custom_description,
        custom_description: item.custom_description,
        sort_order: item.sort_order
    }));
    input.value = JSON.stringify(payload);
    return selections;
}

// æ›´æ–°ç„¡å…§å®¹æç¤º
function updateNoContentHint() {
    const container = document.getElementById('categoriesContainer');
    const hint = document.getElementById('noCategoriesHint');
    const hasCategories = container.children.length > 0;
    
    if (hint) {
        hint.style.display = hasCategories ? 'none' : 'block';
    }
}

// æ–°å¢åˆ†é¡
// æ–°å¢åˆ†é¡
function addCategory(categoryData = null, options = {}) {
    console.log('åŸ·è¡Œæ–°å¢åˆ†é¡å‡½æ•¸ï¼Œæ•¸æ“šï¼š', categoryData);
    const focusNewCategory = Boolean(options.focus);
    
    const template = document.getElementById('categoryTemplate');
    if (!template) {
        console.error('æ‰¾ä¸åˆ°åˆ†é¡æ¨¡æ¿');
        return;
    }
    
    const clone = template.content.cloneNode(true);
    
    // è¨­ç½®åˆ†é¡ç´¢å¼•
    const categoryDiv = clone.querySelector('.category-item');
    categoryDiv.setAttribute('data-category-index', categoryIndex);
    if (categoryData && typeof categoryData.id !== 'undefined' && categoryData.id !== null) {
        categoryDiv.setAttribute('data-category-id', categoryData.id);
    } else {
        categoryDiv.removeAttribute('data-category-id');
    }
    
    // æ›´æ–°åˆ†é¡ç·¨è™Ÿ
    clone.querySelector('.category-number').textContent = categoryIndex + 1;
    
    // ç‚º textarea è¨­ç½®å”¯ä¸€ ID
    const advantageTextarea = clone.querySelector('.advantage-analysis');
    const disadvantageTextarea = clone.querySelector('.disadvantage-analysis');
    
    if (advantageTextarea) {
        advantageTextarea.id = 'advantage-' + categoryIndex;
    }
    if (disadvantageTextarea) {
        disadvantageTextarea.id = 'disadvantage-' + categoryIndex;
    }
    
    // å¦‚æœæœ‰æ•¸æ“šï¼Œå¡«å…¥è¡¨å–®
    if (categoryData) {
        clone.querySelector('.category-name').value = categoryData.name || '';
        clone.querySelector('.category-english-name').value = categoryData.english_name || '';
        clone.querySelector('.category-description').value = categoryData.description || '';
        clone.querySelector('.role-name').value = categoryData.role_name || '';
        clone.querySelector('.tag-text').value = categoryData.tag_text || '';
        clone.querySelector('.score-type-name').value = categoryData.score_type_name || '';
        clone.querySelector('.category-content').value = categoryData.content || '';
        clone.querySelector('.advantage-suggestions').value = categoryData.advantage_suggestions || '';
        clone.querySelector('.development-direction').value = categoryData.development_direction || '';
        clone.querySelector('.development-parameter-name').value = categoryData.development_parameter_name || '';
        clone.querySelector('.development-parameter-content').value = categoryData.development_parameter_content || '';
        if (advantageTextarea) advantageTextarea.value = categoryData.advantage_analysis || '';
        if (disadvantageTextarea) disadvantageTextarea.value = categoryData.disadvantage_analysis || '';
    }
    
    // æ’å…¥åˆ°å®¹å™¨
    const container = document.getElementById('categoriesContainer');
    if (!container) {
        console.error('æ‰¾ä¸åˆ°åˆ†é¡å®¹å™¨');
        return;
    }
    container.appendChild(clone);
    
    // ç‚ºæ–°åˆ†é¡çš„ç‰¹è³ªé è¨­æ–°å¢ä¸€å€‹
    const categoryElement = categoryDiv;
    if (categoryElement) {
        const traitsContainer = categoryElement.querySelector('.traits-container');

        if (categoryData && categoryData.traits) {
            categoryData.traits.forEach(function(traitData) {
                addTrait(traitsContainer, traitData);
            });
        } else {
            addTrait(traitsContainer);
        }

        const nameInput = categoryElement.querySelector('.category-name');
        if (nameInput) nameInput.addEventListener('input', updateProgressSteps);
    }
    
    // å¢åŠ ç´¢å¼•
    categoryIndex++;
    
    // æ›´æ–°æç¤ºé¡¯ç¤ºå’Œé€²åº¦
    updateNoContentHint();
    updateProgressSteps();
    scheduleScrollRestore();
    
    if (focusNewCategory && categoryElement) {
        scrollIntoViewWithOffset(categoryElement);
    }
    
    console.log('åˆ†é¡æ–°å¢å®Œæˆï¼Œç•¶å‰ç´¢å¼•ï¼š', categoryIndex);
    return categoryElement;
}

// ç§»é™¤åˆ†é¡
function removeCategory(button) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤æ‰€æœ‰ç›¸é—œçš„ç‰¹è³ªè¨­å®šã€‚')) {
        const categoryItem = button.closest('.category-item');
        if (categoryItem) {
            // æ·»åŠ åˆªé™¤å‹•ç•«
            categoryItem.style.animation = 'slideOutUp 0.3s ease-in';
            setTimeout(() => {
                categoryItem.remove();
                updateCategoryNumbers();
                updateNoContentHint();
                updateProgressSteps();
            }, 300);
        }
    }
}

// æ–°å¢ç‰¹è³ª
function addTrait(container, traitData = null, options = {}) {
    console.log('åŸ·è¡Œæ–°å¢ç‰¹è³ªå‡½æ•¸ï¼Œå®¹å™¨ï¼š', container, 'æ•¸æ“šï¼š', traitData);

    let triggeredByButton = false;
    if (container && container.tagName === 'BUTTON') {
        triggeredByButton = true;
        container = container.closest('.category-item').querySelector('.traits-container');
    }

    if (!container) {
        console.error('æ‰¾ä¸åˆ°ç‰¹è³ªå®¹å™¨');
        return;
    }

    const template = document.getElementById('traitTemplate');
    if (!template) {
        console.error('æ‰¾ä¸åˆ°ç‰¹è³ªæ¨¡æ¿');
        return;
    }

    const clone = template.content.cloneNode(true);
    const traitDiv = clone.querySelector('.trait-item');
    const traitCount = container.children.length;

    traitDiv.setAttribute('data-trait-index', traitCount);
    if (traitData && typeof traitData.relation_id !== 'undefined' && traitData.relation_id !== null) {
        traitDiv.setAttribute('data-category-trait-id', traitData.relation_id);
    } else {
        traitDiv.removeAttribute('data-category-trait-id');
    }
    clone.querySelector('.trait-number').textContent = traitCount + 1;

    const select = traitDiv.querySelector('.trait-select');
    const weightInput = traitDiv.querySelector('.trait-weight');

    populateCategoryTraitSelect(select);

    if (projectTraitSelectionMap.size === 0 && triggeredByButton) {
        alert('å°šæœªè¨­å®šä»»ä½•ç‰¹è³ªï¼Œè«‹å…ˆåœ¨ã€Œç‰¹è³ªè¨­å®šã€å€å¡Šæ–°å¢ç‰¹è³ªã€‚');
    }

    if (traitData && traitData.weight !== undefined && weightInput) {
        weightInput.value = traitData.weight;
    } else if (weightInput) {
        weightInput.value = 1;
    }

    if (select) {
        select.addEventListener('change', function() {
            updateTraitDetails(traitDiv, this.value);
        });

        if (traitData && traitData.trait_id) {
            select.value = String(traitData.trait_id);
        }

        updateTraitDetails(traitDiv, select.value);
    }

    container.appendChild(clone);
    updateTraitNumbers(container);
    refreshProjectTraitOptions();

    const appendedItem = container.lastElementChild;
    const shouldFocus = triggeredByButton || Boolean(options.focus);
    if (shouldFocus && appendedItem) {
        scrollIntoViewWithOffset(appendedItem);
        setTimeout(() => flashHighlight(appendedItem), 60);
    }

    console.log('ç‰¹è³ªæ–°å¢å®Œæˆ');
    return appendedItem;
}

function populateCategoryTraitSelect(select) {
    if (!select) return;

    select.innerHTML = '';

    const selections = Array.from(projectTraitSelectionMap.values()).sort((a, b) => a.sort_order - b.sort_order);

    if (selections.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'è«‹å…ˆåœ¨ç‰¹è³ªè¨­å®šä¸­é¸æ“‡ç‰¹è³ª';
        option.disabled = true;
        select.appendChild(option);
        select.disabled = true;
        return;
    }

    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = 'è«‹é¸æ“‡ç‰¹è³ª';
    select.appendChild(placeholderOption);

    selections.forEach(function(item) {
        const option = document.createElement('option');
        option.value = String(item.trait_id);
        option.textContent = `${item.chinese_name} (${item.system_name})`;
        select.appendChild(option);
    });

    select.disabled = false;
}

function updateTraitDetails(traitElement, traitId) {
    if (!traitElement) return;

    const key = String(traitId || '');
    const selectedData = projectTraitSelectionMap.get(key);
    const traitData = selectedData || traitLookup.get(key);

    const chineseInput = traitElement.querySelector('.trait-chinese-name');
    const systemInput = traitElement.querySelector('.trait-system-name');
    const descriptionInput = traitElement.querySelector('.trait-description');

    if (traitData) {
        const chineseName = selectedData ? selectedData.chinese_name : (traitData.chinese_name || '');
        const systemName = selectedData ? selectedData.system_name : (traitData.system_name || '');
        const description = selectedData ? (selectedData.description || '') : (traitData.description || '');
        if (chineseInput) chineseInput.value = chineseName;
        if (systemInput) systemInput.value = systemName;
        if (descriptionInput) descriptionInput.value = description;
    } else {
        if (chineseInput) chineseInput.value = '';
        if (systemInput) systemInput.value = '';
        if (descriptionInput) descriptionInput.value = '';
    }
}

// ç§»é™¤ç‰¹è³ª
function removeTrait(button) {
    const traitsContainer = button.closest('.traits-container');
    const traitCount = traitsContainer.children.length;
    
    if (traitCount <= 1) {
        alert('æ¯å€‹åˆ†é¡è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç‰¹è³ªè¨­å®šï¼');
        return;
    }
    
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç‰¹è³ªå—ï¼Ÿ')) {
        const traitItem = button.closest('.trait-item');
        const container = button.closest('.traits-container');
        if (traitItem) {
            // æ·»åŠ åˆªé™¤å‹•ç•«
            traitItem.style.animation = 'slideOutUp 0.2s ease-in';
            setTimeout(() => {
                traitItem.remove();
                updateTraitNumbers(container);
            }, 200);
        }
    }
}

// æ›´æ–°åˆ†é¡ç·¨è™Ÿ
function updateCategoryNumbers() {
    const categoryItems = document.querySelectorAll('#categoriesContainer .category-item');
    categoryItems.forEach(function(item, index) {
        const numberSpan = item.querySelector('.category-number');
        if (numberSpan) {
            numberSpan.textContent = index + 1;
        }
        item.setAttribute('data-category-index', index);
    });
}

// æ›´æ–°ç‰¹è³ªç·¨è™Ÿ
function updateTraitNumbers(container) {
    if (!container) return;
    
    const traitItems = container.querySelectorAll('.trait-item');
    traitItems.forEach(function(item, index) {
        const numberSpan = item.querySelector('.trait-number');
        if (numberSpan) {
            numberSpan.textContent = index + 1;
        }
        item.setAttribute('data-trait-index', index);
    });
}

// æ”¶é›†åˆ†é¡æ•¸æ“š
function collectCategoriesData() {
    const categories = [];
    
    const categoryItems = document.querySelectorAll('#categoriesContainer .category-item');
    categoryItems.forEach(function(categoryItem, index) {
        const traits = [];
        
        // æ”¶é›†ç‰¹è³ªæ•¸æ“š
        const traitItems = categoryItem.querySelectorAll('.trait-item');
        traitItems.forEach(function(traitItem, traitIndex) {
            const select = traitItem.querySelector('.trait-select');
            if (!select) {
                return;
            }

            const traitIdValue = select.value;
            if (!traitIdValue) {
                return;
            }

            const parsedId = parseInt(traitIdValue, 10);
            if (isNaN(parsedId)) {
                return;
            }

            let weight = 1;
            const weightInput = traitItem.querySelector('.trait-weight');
            if (weightInput) {
                const parsedWeight = parseFloat(weightInput.value);
                if (!isNaN(parsedWeight)) {
                    weight = parsedWeight;
                }
            }

            const relationIdAttr = traitItem.getAttribute('data-category-trait-id');
            const relationId = relationIdAttr ? parseInt(relationIdAttr, 10) : null;

            traits.push({
                relation_id: !isNaN(relationId) ? relationId : null,
                trait_id: parsedId,
                weight: weight,
                sort_order: traitIndex
            });
        });
        
        // æ”¶é›†åˆ†é¡æ•¸æ“š
        const categoryName = categoryItem.querySelector('.category-name').value || '';
        const categoryEnglishName = categoryItem.querySelector('.category-english-name').value || '';
        const categoryDescription = categoryItem.querySelector('.category-description').value || '';
        const roleName = categoryItem.querySelector('.role-name').value || '';
        const tagText = categoryItem.querySelector('.tag-text').value || '';
        const scoreTypeName = categoryItem.querySelector('.score-type-name').value || '';
        const content = categoryItem.querySelector('.category-content').value || '';
        const advantageSuggestions = categoryItem.querySelector('.advantage-suggestions').value || '';
        const developmentDirection = categoryItem.querySelector('.development-direction').value || '';
        
        // ç²å–å¯Œæ–‡æœ¬å…§å®¹
        const advantageTextarea = categoryItem.querySelector('.advantage-analysis');
        const disadvantageTextarea = categoryItem.querySelector('.disadvantage-analysis');
        
        let advantageContent = '';
        let disadvantageContent = '';
        
        if (advantageTextarea) {
            const advantageEditor = tinymce.get(advantageTextarea.id);
            advantageContent = advantageEditor ? advantageEditor.getContent() : advantageTextarea.value;
        }
        
        if (disadvantageTextarea) {
            const disadvantageEditor = tinymce.get(disadvantageTextarea.id);
            disadvantageContent = disadvantageEditor ? disadvantageEditor.getContent() : disadvantageTextarea.value;
        }
        
        // ç²å–ç™¼å±•å»ºè­°åƒæ•¸
        const developmentParameterName = categoryItem.querySelector('.development-parameter-name').value || '';
        const developmentParameterContent = categoryItem.querySelector('.development-parameter-content').value || '';
        
        // è™•ç†è§’è‰²åœ–ç‰‡ä¸Šå‚³ - è¨­å®šæ­£ç¢ºçš„nameå±¬æ€§
        const roleImageInput = categoryItem.querySelector('.role-image');
        if (roleImageInput) {
            roleImageInput.name = `role_image_${index}`;
        }
        
        if (categoryName.trim()) {  // åªæª¢æŸ¥åç¨±
            categories.push({
                id: categoryItem.getAttribute('data-category-id') || null,
                name: categoryName,
                english_name: categoryEnglishName,
                description: categoryDescription,
                test_link: '',  // è¨­ç‚ºç©ºå­—ç¬¦ä¸²
                advantage_analysis: advantageContent,
                disadvantage_analysis: disadvantageContent,
                development_parameter_name: developmentParameterName,
                development_parameter_content: developmentParameterContent,
                // æ–°å¢è§’è‰²ç›¸é—œæ¬„ä½
                role_name: roleName,
                tag_text: tagText,
                content: content,
                advantage_suggestions: advantageSuggestions,
                development_direction: developmentDirection,
                score_type_name: scoreTypeName,
                traits: traits
            });
        }
    });
    
    // å°‡æ•¸æ“šè½‰ç‚ºJSONå­—ç¬¦ä¸²
    const categoriesDataInput = document.getElementById('categories_data');
    if (categoriesDataInput) {
        categoriesDataInput.value = JSON.stringify(categories);
    }
    console.log('æ”¶é›†çš„åˆ†é¡æ•¸æ“šï¼š', categories);
}

function scheduleScrollRestore() {
    if (pendingScrollPosition === null || scrollRestored) {
        return;
    }
    window.requestAnimationFrame(function() {
        window.requestAnimationFrame(function() {
            window.scrollTo({ top: pendingScrollPosition, behavior: 'auto' });
            scrollRestored = true;
        });
    });
}

// é¡¯ç¤ºé è¦½æ¨¡æ…‹æ¡†
function showPreviewModal() {
    const name = document.getElementById('name').value;
    const description = document.getElementById('description').value;
    const assignmentType = document.getElementById('assignment_type');
    const selectedText = assignmentType.options[assignmentType.selectedIndex].text;
    
    const categoryCount = document.querySelectorAll('.category-item').length;
    let traitCount = 0;
    document.querySelectorAll('.trait-item').forEach(() => traitCount++);
    
    let assignmentInfo = selectedText;
    if (assignmentType.value === 'specific_assignment') {
        const enterpriseCount = document.querySelectorAll('.enterprise-checkbox:checked').length;
        const individualCount = document.querySelectorAll('.individual-checkbox:checked').length;
        assignmentInfo += ` (ä¼æ¥­: ${enterpriseCount} å®¶, å€‹äºº: ${individualCount} ä½)`;
    }
    
    const previewContent = `
        <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-eye me-2"></i>æ¸¬é©—é …ç›®é è¦½
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">åŸºæœ¬è³‡è¨Š</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td class="fw-bold">æ¸¬é©—åç¨±ï¼š</td><td>${name || 'æœªå¡«å¯«'}</td></tr>
                                    <tr><td class="fw-bold">æè¿°ï¼š</td><td>${description || 'æœªå¡«å¯«'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">çµ±è¨ˆè³‡è¨Š</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td class="fw-bold">åˆ†é¡æ•¸é‡ï¼š</td><td>${categoryCount} å€‹</td></tr>
                                    <tr><td class="fw-bold">ç‰¹è³ªç¸½æ•¸ï¼š</td><td>${traitCount} å€‹</td></tr>
                                    <tr><td class="fw-bold">æŒ‡æ´¾æ–¹å¼ï¼š</td><td>${assignmentInfo}</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤ç¾æœ‰çš„æ¨¡æ…‹æ¡†
    const existingModal = document.getElementById('previewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // æ·»åŠ æ–°çš„æ¨¡æ…‹æ¡†
    document.body.insertAdjacentHTML('beforeend', previewContent);
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// æ·»åŠ æ»‘å‡ºå‹•ç•«çš„CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideOutUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-30px);
        }
    }
`;
document.head.appendChild(style);

// TinyMCE ç›¸é—œå‡½æ•¸
function initializeTinyMCE() {
    // åˆå§‹åŒ–ç¾æœ‰çš„ textarea
    const existingTextareas = document.querySelectorAll('.advantage-analysis, .disadvantage-analysis');
    existingTextareas.forEach(function(textarea, index) {
        if (!textarea.id) {
            textarea.id = 'tinymce-' + Date.now() + '-' + index;
        }
        
        if (!tinymce.get(textarea.id)) {
            tinymce.init({
                target: textarea,
                height: 200,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap',
                    'searchreplace', 'visualblocks', 'table', 'help'
                ],
                toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist | link | removeformat | help',
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px }',
                setup: function(editor) {
                    editor.on('change', function() {
                        updateProgressSteps();
                    });
                }
            });
        }
    });
}

function initializeCategoryTinyMCE(categoryIndex) {
    const categoryElement = document.querySelector(`[data-category-index="${categoryIndex}"]`);
    if (categoryElement) {
        const textareas = categoryElement.querySelectorAll('.advantage-analysis, .disadvantage-analysis');
        textareas.forEach(function(textarea, index) {
            if (!textarea.id) {
                textarea.id = 'category-' + categoryIndex + '-textarea-' + index;
            }
            
            if (!tinymce.get(textarea.id)) {
                tinymce.init({
                    target: textarea,
                    height: 200,
                    menubar: false,
                    plugins: [
                        'advlist', 'autolink', 'lists', 'link', 'charmap',
                        'searchreplace', 'visualblocks', 'table', 'help'
                    ],
                    toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist | link | removeformat | help',
                    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px }',
                    setup: function(editor) {
                        editor.on('change', function() {
                            updateProgressSteps();
                        });
                    }
                });
            }
        });
    }
}
</script>
{% endblock %}
