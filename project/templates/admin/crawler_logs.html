{% extends 'base.html' %}
{% load static %}

{% block title %}çˆ¬èŸ²åŸ·è¡Œæ—¥èªŒ{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<li class="breadcrumb-item"><a href="{% url 'crawler_dashboard' %}">çˆ¬èŸ²ç®¡ç†</a></li>
<li class="breadcrumb-item active">åŸ·è¡Œæ—¥èªŒ</li>
{% endblock %}

{% block content %}
<div class="crawler-logs">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ“‹ çˆ¬èŸ²åŸ·è¡Œæ—¥èªŒ</h1>
        <div>
            <a href="{% url 'crawler_dashboard' %}" class="btn btn-outline-secondary">
                â¬…ï¸ è¿”å›å„€è¡¨æ¿
            </a>
        </div>
    </div>
    
    <!-- æœå°‹å’Œéæ¿¾ -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">æœå°‹é—œéµå­—</label>
                    <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}" placeholder="æœå°‹è¨Šæ¯æˆ–éŒ¯èª¤...">
                </div>
                <div class="col-md-3">
                    <label for="task" class="form-label">ä»»å‹™é¡å‹</label>
                    <select class="form-select" id="task" name="task">
                        <option value="">å…¨éƒ¨ä»»å‹™</option>
                        {% for choice in task_choices %}
                            <option value="{{ choice.0 }}" {% if task_filter == choice.0 %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">åŸ·è¡Œç‹€æ…‹</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        {% for choice in status_choices %}
                            <option value="{{ choice.0 }}" {% if status_filter == choice.0 %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">ğŸ” æœå°‹</button>
                        <a href="{% url 'crawler_logs' %}" class="btn btn-outline-secondary">æ¸…é™¤</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ—¥èªŒåˆ—è¡¨ -->
    {% if page_obj %}
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>åŸ·è¡Œæ™‚é–“</th>
                            <th>ä»»å‹™é¡å‹</th>
                            <th>ç‹€æ…‹</th>
                            <th>çµæœçµ±è¨ˆ</th>
                            <th>æˆåŠŸç‡</th>
                            <th>åŸ·è¡Œæ™‚é•·</th>
                            <th>è¨Šæ¯</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in page_obj %}
                        <tr>
                            <td>
                                <small class="text-muted">{{ log.executed_at|date:"Y-m-d" }}</small><br>
                                <strong>{{ log.executed_at|date:"H:i:s" }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ log.get_task_name_display }}</span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if log.status == 'completed' %}bg-success
                                    {% elif log.status == 'failed' %}bg-danger
                                    {% elif log.status == 'running' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ log.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <small>
                                    âœ… {{ log.success_count }} / 
                                    âŒ {{ log.fail_count }} / 
                                    ğŸ“Š {{ log.total_count }}
                                </small>
                            </td>
                            <td>
                                <span class="fw-bold" style="color: 
                                    {% if log.success_rate >= 90 %}green
                                    {% elif log.success_rate >= 70 %}orange
                                    {% else %}red{% endif %};">
                                    {{ log.success_rate }}%
                                </span>
                            </td>
                            <td>
                                {% if log.duration %}
                                    {{ log.duration|floatformat:1 }}s
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                    {{ log.message|truncatechars:50 }}
                                </div>
                            </td>
                            <td>
                                <a href="{% url 'crawler_log_details' log.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>è©³æƒ…
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é  -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="æ—¥èªŒåˆ†é ">
                <ul class="pagination justify-content-center mt-4">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if task_filter %}&task={{ task_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">ä¸Šä¸€é </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if task_filter %}&task={{ task_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if task_filter %}&task={{ task_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">ä¸‹ä¸€é </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="mb-3">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
        </div>
        <h4 class="text-muted">æš«ç„¡åŸ·è¡Œæ—¥èªŒ</h4>
        <p class="text-muted">ç•¶çˆ¬èŸ²ä»»å‹™åŸ·è¡Œå¾Œï¼Œç›¸é—œæ—¥èªŒæœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
    </div>
    {% endif %}
</div>

<!-- æ—¥èªŒè©³æƒ…Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åŸ·è¡Œæ—¥èªŒè©³æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logDetailContent">
                    <!-- è©³æƒ…å…§å®¹æœƒé€šéJavaScriptå¡«å…¥ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
function showLogDetail(id, taskName, executedAt, message, errorDetails) {
    const content = document.getElementById('logDetailContent');
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-3"><strong>ä»»å‹™é¡å‹ï¼š</strong></div>
            <div class="col-md-9">${taskName}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><strong>åŸ·è¡Œæ™‚é–“ï¼š</strong></div>
            <div class="col-md-9">${executedAt}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><strong>åŸ·è¡Œè¨Šæ¯ï¼š</strong></div>
            <div class="col-md-9">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">${message || 'ç„¡è¨Šæ¯'}</div>
            </div>
        </div>
    `;
    
    if (errorDetails && errorDetails.trim()) {
        html += `
            <div class="row mb-3">
                <div class="col-md-3"><strong>éŒ¯èª¤è©³æƒ…ï¼š</strong></div>
                <div class="col-md-9">
                    <div class="bg-danger-subtle p-3 rounded" style="white-space: pre-wrap; color: #842029;">${errorDetails}</div>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
    modal.show();
}
</script>
{% endblock %}