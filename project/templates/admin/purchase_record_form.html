{% extends 'base.html' %}

{% block title %}新增企業購買紀錄 - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">儀表板</a></li>
<li class="breadcrumb-item active">新增企業購買紀錄</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bag-plus me-2"></i>新增企業購買紀錄</h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">公司名稱</label>
                                <input type="text" id="enterpriseSearch" class="form-control mb-2" placeholder="快速搜尋公司或聯絡人">
                                {{ form.enterprise_user }}
                                {% if form.enterprise_user.errors %}
                                    <div class="text-danger small">{{ form.enterprise_user.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">訂單編號</label>
                                {{ form.order_number }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">購買評鑑項目</label>
                                {{ form.test_project }}
                                {% if form.test_project.errors %}
                                    <div class="text-danger small">{{ form.test_project.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">購買份數</label>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                    <div class="text-danger small">{{ form.quantity.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">付款日期</label>
                                {{ form.payment_date }}
                                {% if form.payment_date.errors %}
                                    <div class="text-danger small">{{ form.payment_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">付款方式</label>
                                {{ form.payment_method }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">付款金額</label>
                                {{ form.payment_amount }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">優惠券</label>
                                {{ form.coupon_code }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">發票號碼</label>
                                {{ form.invoice_number }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">發票隨機碼</label>
                                {{ form.invoice_random_code }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">發票資訊</label>
                                {{ form.invoice_info }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">備註</label>
                                {{ form.notes }}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>返回儀表板</a>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>儲存紀錄</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('enterpriseSearch');
        const selectField = document.getElementById('{{ form.enterprise_user.auto_id }}');

        if (!searchInput || !selectField) {
            return;
        }

        const options = Array.from(selectField.options);

        searchInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();

            options.forEach(option => {
                if (!option.value) {
                    option.hidden = false;
                    return;
                }
                const match = option.text.toLowerCase().includes(query);
                option.hidden = !match;
            });

            const visibleOptions = options.filter(option => !option.hidden && option.value);
            if (selectField.value && selectField.options[selectField.selectedIndex]?.hidden) {
                selectField.value = '';
            }
            if (!selectField.value && visibleOptions.length === 1) {
                selectField.value = visibleOptions[0].value;
            }
        });
    });
</script>
{% endblock %}
