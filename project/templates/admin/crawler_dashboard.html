{% extends 'base.html' %}
{% load static %}

{% block title %}çˆ¬èŸ²ç®¡ç†å„€è¡¨æ¿{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<li class="breadcrumb-item active">çˆ¬èŸ²ç®¡ç†å„€è¡¨æ¿</li>
{% endblock %}

{% block content %}
<div class="crawler-dashboard">
    <h1>ğŸ•·ï¸ çˆ¬èŸ²ç®¡ç†å„€è¡¨æ¿</h1>
    
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row" style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div class="stats-card">
            <h3>å¾…çˆ¬å–é‚€è«‹</h3>
            <div class="stat-number" style="color: #ff6b35;">{{ pending_invitations }}</div>
            <p>å€‹é‚€è«‹å¾…è™•ç†</p>
        </div>
        
        <div class="stats-card">
            <h3>30å¤©åŸ·è¡Œæ¬¡æ•¸</h3>
            <div class="stat-number" style="color: #007bff;">{{ stats.total_executions }}</div>
            <p>æ¬¡è‡ªå‹•åŸ·è¡Œ</p>
        </div>
        
        <div class="stats-card">
            <h3>æˆåŠŸç‡</h3>
            <div class="stat-number" style="color: #28a745;">
                {% if stats.total_executions > 0 %}
                    {{ stats.successful_executions|floatformat:0 }}/{{ stats.total_executions }}
                {% else %}
                    -
                {% endif %}
            </div>
            <p>åŸ·è¡ŒæˆåŠŸç‡</p>
        </div>
        
        <div class="stats-card">
            <h3>çˆ¬å–æˆåŠŸ</h3>
            <div class="stat-number" style="color: #17a2b8;">{{ stats.total_crawled }}</div>
            <p>å€‹çµæœå·²çˆ¬å–</p>
        </div>
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="actions" style="margin-bottom: 30px;">
        <form method="post" action="{% url 'trigger_crawler' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" id="trigger-btn">
                ğŸš€ æ‰‹å‹•è§¸ç™¼çˆ¬èŸ²
            </button>
        </form>
        
        <a href="{% url 'crawler_logs' %}" class="btn btn-outline-secondary">
            ğŸ“‹ æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ
        </a>
        
        <a href="{% url 'crawler_settings' %}" class="btn btn-outline-secondary">
            âš™ï¸ çˆ¬èŸ²è¨­å®š
        </a>
        
        <a href="{% url 'crawler_schedule' %}" class="btn btn-outline-secondary">
            â° æ’ç¨‹ç®¡ç†
        </a>
    </div>
    
    <!-- æœ€è¿‘åŸ·è¡Œè¨˜éŒ„ -->
    <div class="recent-executions">
        <h2>æœ€è¿‘åŸ·è¡Œè¨˜éŒ„</h2>
        
        {% if recent_executions %}
        <table class="table">
            <thead>
                <tr>
                    <th>åŸ·è¡Œæ™‚é–“</th>
                    <th>ä»»å‹™é¡å‹</th>
                    <th>ç‹€æ…‹</th>
                    <th>æˆåŠŸ/å¤±æ•—/ç¸½è¨ˆ</th>
                    <th>æˆåŠŸç‡</th>
                    <th>åŸ·è¡Œè¨Šæ¯</th>
                </tr>
            </thead>
            <tbody>
                {% for log in recent_executions %}
                <tr>
                    <td>{{ log.executed_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ log.get_task_name_display }}</td>
                    <td>
                        <span class="status-badge status-{{ log.status }}">
                            {{ log.get_status_display }}
                        </span>
                    </td>
                    <td>{{ log.success_count }}/{{ log.fail_count }}/{{ log.total_count }}</td>
                    <td>
                        <span style="color: {% if log.success_rate >= 90 %}green{% elif log.success_rate >= 70 %}orange{% else %}red{% endif %};">
                            {{ log.success_rate }}%
                        </span>
                    </td>
                    <td>{{ log.message|truncatechars:50 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>å°šç„¡åŸ·è¡Œè¨˜éŒ„</p>
        {% endif %}
    </div>
    
    <!-- å³æ™‚ç‹€æ…‹æ›´æ–° -->
    <div class="real-time-status" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h3>å³æ™‚ç‹€æ…‹ <span id="last-update" style="font-size: 12px; color: #666;"></span></h3>
        <div id="status-content">
            è¼‰å…¥ä¸­...
        </div>
    </div>
</div>

<style>
.stats-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
    min-width: 150px;
    flex: 1;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 10px 0;
}

.btn {
    padding: 8px 16px;
    margin: 0 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-outline-secondary {
    background: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.table th, .table td {
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    text-align: left;
}

.table th {
    background: #f8f9fa;
    font-weight: bold;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-failed {
    background: #f8d7da;
    color: #721c24;
}

.status-running {
    background: #d1ecf1;
    color: #0c5460;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªå‹•æ›´æ–°ç‹€æ…‹
    function updateStatus() {
        fetch('{% url "crawler_status_api" %}')
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('status-content');
                const lastUpdate = document.getElementById('last-update');
                
                let html = `
                    <p><strong>å¾…çˆ¬å–é‚€è«‹ï¼š</strong> ${data.pending_count} å€‹</p>
                `;
                
                if (data.latest_execution) {
                    html += `
                        <p><strong>æœ€è¿‘åŸ·è¡Œï¼š</strong> ${new Date(data.latest_execution.time).toLocaleString()}</p>
                        <p><strong>åŸ·è¡Œçµæœï¼š</strong> æˆåŠŸ ${data.latest_execution.success_count}ï¼Œå¤±æ•— ${data.latest_execution.fail_count}</p>
                    `;
                }
                
                content.innerHTML = html;
                lastUpdate.textContent = `(æ›´æ–°æ™‚é–“: ${new Date().toLocaleTimeString()})`;
            })
            .catch(error => {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
            });
    }
    
    // åˆå§‹è¼‰å…¥
    updateStatus();
    
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    setInterval(updateStatus, 30000);
    
    // æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•
    document.getElementById('trigger-btn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (confirm('ç¢ºå®šè¦æ‰‹å‹•è§¸ç™¼çˆ¬èŸ²ä»»å‹™å—ï¼Ÿ')) {
            this.disabled = true;
            this.textContent = 'ğŸ”„ åŸ·è¡Œä¸­...';
            
            fetch('{% url "trigger_crawler" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('çˆ¬èŸ²ä»»å‹™å·²æˆåŠŸå•Ÿå‹•ï¼ä»»å‹™ID: ' + data.task_id);
                    updateStatus(); // ç«‹å³æ›´æ–°ç‹€æ…‹
                } else {
                    alert('å•Ÿå‹•å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                alert('ç™¼ç”ŸéŒ¯èª¤: ' + error);
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'ğŸš€ æ‰‹å‹•è§¸ç™¼çˆ¬èŸ²';
            });
        }
    });
});
</script>
{% endblock %}