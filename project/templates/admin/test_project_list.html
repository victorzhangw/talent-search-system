{% extends 'base.html' %}
{% load static %}

{% block title %}測驗項目管理 - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">儀表板</a></li>
<li class="breadcrumb-item active">測驗項目管理</li>
{% endblock %}

{% block extra_css %}
<style>
.project-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.assignment-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.stats-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.filter-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border-radius: 12px;
    margin-bottom: 2rem;
}

.filter-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px 12px 0 0;
    padding: 1rem 1.5rem;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.filter-body {
    background: rgba(255, 255, 255, 0.98);
    padding: 1.5rem;
    border-radius: 0 0 12px 12px;
}

.category-tags {
    max-height: 60px;
    overflow: hidden;
    position: relative;
}

.category-tag {
    font-size: 0.75rem;
    margin: 0.2rem;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
}

.project-meta {
    font-size: 0.85rem;
    color: #6c757d;
}

.project-meta i {
    margin-right: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clipboard-check me-2"></i>測驗項目管理</h2>
        <a href="{% url 'test_project_create' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>新增測驗項目
        </a>
    </div>

    <!-- 統計資訊 -->
    <div class="stats-container">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.total }}</div>
                    <div class="stat-label">總測驗項目</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.all_open }}</div>
                    <div class="stat-label">全部開放</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.specific_assignment }}</div>
                    <div class="stat-label">指定開放</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋和篩選 -->
    <div class="filter-card">
        <div class="filter-header">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>搜尋與篩選</h5>
        </div>
        <div class="filter-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">搜尋關鍵字</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" name="search" class="form-control" 
                            placeholder="搜尋測驗名稱或描述..." value="{{ search }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">指派類型</label>
                    <select name="assignment_type" class="form-select">
                        <option value="">全部類型</option>
                        {% for value, label in assignment_choices %}
                        <option value="{{ value }}" {% if assignment_type_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>搜尋
                        </button>
                    </div>
                </div>
            </form>

            {% if search or assignment_type_filter %}
            <div class="mt-3">
                <a href="{% url 'test_project_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise me-1"></i>清除篩選
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 測驗項目列表 -->
    {% if page_obj.object_list %}
        <div class="row">
            {% for project in page_obj.object_list %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card project-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge assignment-badge
                                {% if project.assignment_type == 'all_open' %}bg-success
                                {% elif project.assignment_type == 'enterprise_only' %}bg-info
                                {% elif project.assignment_type == 'individual_only' %}bg-warning
                                {% else %}bg-primary{% endif %}">
                                {{ project.get_assignment_type_display }}
                            </span>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'test_project_detail' project.id %}">
                                    <i class="bi bi-eye me-2"></i>查看詳情
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'test_project_edit' project.id %}">
                                    <i class="bi bi-pencil me-2"></i>編輯
                                </a></li>
                                {% if project.assignment_type == 'specific_assignment' %}
                                <li><a class="dropdown-item" href="{% url 'test_project_assignments' project.id %}">
                                    <i class="bi bi-people me-2"></i>管理指派
                                </a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="{% url 'test_project_delete' project.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger" 
                                                onclick="return confirm('確定要刪除「{{ project.name }}」嗎？\n\n此操作將：\n• 刪除所有分類和特質設定\n• 移除所有企業指派\n• 無法復原')">
                                            <i class="bi bi-trash me-2"></i>刪除
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title text-primary">{{ project.name }}</h5>
                        
                        {% if project.description %}
                        <p class="card-text text-muted">{{ project.description|truncatechars:100 }}</p>
                        {% endif %}
                        
                        <!-- 分類標籤 -->
                        <div class="category-tags mb-3">
                            {% for category in project.categories.all|slice:":3" %}
                            <span class="badge category-tag bg-light text-dark">{{ category.name|truncatechars:15 }}</span>
                            {% endfor %}
                            {% if project.categories.count > 3 %}
                            <span class="badge category-tag bg-secondary">+{{ project.categories.count|add:"-3" }} 更多</span>
                            {% endif %}
                        </div>
                        
                        <!-- 統計資訊 -->
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="project-meta">
                                    <i class="bi bi-list"></i>{{ project.categories.count }}<br>
                                    <small>分類</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="project-meta">
                                    <i class="bi bi-tags"></i>{{ project.total_traits_count|default:0 }}<br>
                                    <small>特質</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="project-meta">
                                    <i class="bi bi-building"></i>{{ project.enterprise_assignments.count }}<br>
                                    <small>指派</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 項目資訊 -->
                        <div class="project-meta">
                            <div><i class="bi bi-person"></i>{{ project.created_by.username }}</div>
                            <div><i class="bi bi-calendar"></i>{{ project.created_at|date:"Y/m/d" }}</div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100" role="group">
                            <a href="{% url 'test_project_detail' project.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye me-1"></i>詳情
                            </a>
                            <a href="{% url 'test_project_edit' project.id %}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-pencil me-1"></i>編輯
                            </a>
                            {% if project.assignment_type == 'specific_assignment' %}
                            <a href="{% url 'test_project_assignments' project.id %}" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-people me-1"></i>指派
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 分頁 -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="分頁導航">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-clipboard-x text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">暫無測驗項目</h4>
            {% if search or status_filter or assignment_type_filter %}
                <p class="text-muted">沒有符合搜尋條件的測驗項目</p>
                <a href="{% url 'test_project_list' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise me-1"></i>清除篩選
                </a>
            {% else %}
                <p class="text-muted">開始建立您的第一個測驗項目</p>
                <a href="{% url 'test_project_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>新增測驗項目
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}