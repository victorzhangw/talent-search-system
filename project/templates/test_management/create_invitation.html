{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if is_quick_mode %}å¿«é€Ÿé‚€è«‹{% else %}ç™¼é€æ¸¬é©—é‚€è«‹{% endif %} - {{ project.name }} - {{ block.super }}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<li class="breadcrumb-item"><a href="{% url 'invitation_template_list' %}">è©•é‘‘é‚€è«‹</a></li>
<li class="breadcrumb-item active">
    {% if is_quick_mode %}å¿«é€Ÿé‚€è«‹{% else %}ç™¼é€é‚€è«‹{% endif %}
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- å·¦å´ï¼šè¡¨å–®å€åŸŸ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        {% if is_quick_mode %}
                            <i class="bi bi-lightning me-2"></i>å¿«é€Ÿé‚€è«‹
                        {% else %}
                            <i class="bi bi-envelope-plus me-2"></i>ç™¼é€æ¸¬é©—é‚€è«‹
                        {% endif %}
                    </h4>
                    <p class="text-muted mb-0 mt-2">æ¸¬é©—é …ç›®ï¼š{{ project.name }}</p>
                </div>
                <div class="card-body">
                    {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                                {% with message.tags|default:'info' as tag %}
                                    {% if 'error' in tag %}
                                        {% with 'danger' as alert_class %}
                                            <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                                                {{ message }}
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                            </div>
                                        {% endwith %}
                                    {% else %}
                                        <div class="alert alert-{{ tag }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <form method="post" id="invitationForm">
                        {% csrf_token %}
                        
                        {% if is_quick_mode %}
                            <!-- å¿«é€Ÿé‚€è«‹æ¨¡å¼ï¼šæ–°å¢å—æ¸¬äººå“¡ -->
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="bi bi-info-circle me-2"></i>å¿«é€Ÿé‚€è«‹æ¨¡å¼
                                </h6>
                                <p class="mb-0">æ–°å¢å—æ¸¬äººå“¡è³‡æ–™ä¸¦ç«‹å³ç™¼é€æ¸¬é©—é‚€è«‹</p>
                            </div>
                            
                            <h5 class="mb-3">å—æ¸¬äººå“¡è³‡æ–™</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.name.id_for_label }}" class="form-label">
                                            {{ form.name.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.email.id_for_label }}" class="form-label">
                                            {{ form.email.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.email }}
                                        {% if form.email.errors %}
                                            <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.phone.id_for_label }}" class="form-label">
                                            {{ form.phone.label }}
                                        </label>
                                        {{ form.phone }}
                                        {% if form.phone.errors %}
                                            <div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.position.id_for_label }}" class="form-label">
                                            {{ form.position.label }}
                                        </label>
                                        {{ form.position }}
                                        {% if form.position.errors %}
                                            <div class="invalid-feedback d-block">{{ form.position.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            <h5 class="mb-3">é‚€è«‹è¨­å®š</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.expires_in_days.id_for_label }}" class="form-label">
                                            {{ form.expires_in_days.label }}
                                        </label>
                                        {{ form.expires_in_days }}
                                    </div>
                                    
                                    <!-- è‡ªè¨‚æ™‚é–“æ¬„ä½ -->
                                    <div class="mb-3 custom-date-container" style="display: none;">
                                        <label for="{{ form.custom_expires_at.id_for_label }}" class="form-label">
                                            {{ form.custom_expires_at.label }}
                                        </label>
                                        {{ form.custom_expires_at }}
                                        {% if form.custom_expires_at.errors %}
                                            <div class="invalid-feedback d-block">{{ form.custom_expires_at.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è‡ªè¨‚é‚€è«‹è¨Šæ¯æ¬„ä½å·²éš±è— -->
                            <div class="mb-3" style="display: none;">
                                <label for="{{ form.custom_message.id_for_label }}" class="form-label">
                                    {{ form.custom_message.label }}
                                </label>
                                {{ form.custom_message }}
                                {% if form.custom_message.errors %}
                                    <div class="invalid-feedback d-block">{{ form.custom_message.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                        {% else %}
                            <!-- ä¸€èˆ¬é‚€è«‹æ¨¡å¼ï¼šé¸æ“‡å—æ¸¬äººå“¡ -->
                            <div class="mb-4">
                                <h5>é¸æ“‡å—æ¸¬äººå“¡</h5>
                                {% if form.invitees.field.queryset.count == 0 %}
                                    <div class="alert alert-warning">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-exclamation-triangle me-2"></i>å°šç„¡å—æ¸¬äººå“¡
                                        </h6>
                                        <p class="mb-2">æ‚¨é‚„æ²’æœ‰æ–°å¢ä»»ä½•å—æ¸¬äººå“¡ï¼Œè«‹å…ˆæ–°å¢å—æ¸¬äººå“¡æˆ–ä½¿ç”¨å¿«é€Ÿé‚€è«‹åŠŸèƒ½ã€‚</p>
                                        <div class="btn-group">
                                            <a href="{% url 'invitee_list' %}" class="btn btn-primary btn-sm">
                                                <i class="bi bi-people me-1"></i>ç®¡ç†å—æ¸¬äººå“¡
                                            </a>
                                            <a href="{% url 'quick_invitation' project.id %}" class="btn btn-success btn-sm">
                                                <i class="bi bi-lightning me-1"></i>å¿«é€Ÿé‚€è«‹
                                            </a>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- æœå°‹æ¡† -->
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="searchInvitees" 
                                               placeholder="æœå°‹å—æ¸¬äººå“¡å§“åæˆ–email..." onkeyup="filterInvitees()">
                                    </div>
                                    
                                    <!-- å…¨é¸æ§åˆ¶ -->
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllInvitees" onchange="toggleSelectAll()">
                                            <label class="form-check-label" for="selectAllInvitees">
                                                å…¨é¸ (<span id="selectedCount">0</span> / {{ form.invitees.field.queryset.count }} äºº)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- å—æ¸¬äººå“¡æ¸…å–® -->
                                    <div class="row" id="inviteesList">
                                        {% for invitee in form.invitees.field.queryset %}
                                            <div class="col-md-6 mb-2 invitee-item" 
                                                 data-name="{{ invitee.name }}" 
                                                 data-email="{{ invitee.email }}">
                                                <div class="card card-body">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="invitees" value="{{ invitee.id }}" 
                                                               id="invitee_{{ invitee.id }}" 
                                                               onchange="updateSelectedCount()">
                                                        <label class="form-check-label d-flex justify-content-between align-items-center" 
                                                               for="invitee_{{ invitee.id }}">
                                                            <div>
                                                                <strong>{{ invitee.name }}</strong>
                                                                <div class="small text-muted">{{ invitee.email }}</div>
                                                                {% if invitee.position %}
                                                                    <div class="small text-info">{{ invitee.position }}</div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-end">
                                                                <small class="text-muted">
                                                                    é‚€è«‹ {{ invitee.invited_count }} æ¬¡
                                                                    {% if invitee.invited_count > 0 %}
                                                                        <br>å®Œæˆç‡ {{ invitee.completion_rate }}%
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    
                                    {% if form.invitees.errors %}
                                        <div class="invalid-feedback d-block">{{ form.invitees.errors.0 }}</div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            {% if form.invitees.field.queryset.count > 0 %}
                            <hr class="my-4">
                            
                            <!-- é‚€è«‹è¨­å®š -->
                            <h5 class="mb-3">é‚€è«‹è¨­å®š</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.expires_in_days.id_for_label }}" class="form-label">
                                            {{ form.expires_in_days.label }}
                                        </label>
                                        {{ form.expires_in_days }}
                                    </div>
                                    
                                    <!-- è‡ªè¨‚æ™‚é–“æ¬„ä½ -->
                                    <div class="mb-3 custom-date-container" style="display: none;">
                                        <label for="{{ form.custom_expires_at.id_for_label }}" class="form-label">
                                            {{ form.custom_expires_at.label }}
                                        </label>
                                        {{ form.custom_expires_at }}
                                        {% if form.custom_expires_at.errors %}
                                            <div class="invalid-feedback d-block">{{ form.custom_expires_at.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è‡ªè¨‚é‚€è«‹è¨Šæ¯æ¬„ä½å·²éš±è— -->
                            <div class="mb-3" style="display: none;">
                                <label for="{{ form.custom_message.id_for_label }}" class="form-label">
                                    {{ form.custom_message.label }}
                                </label>
                                {{ form.custom_message }}
                                {% if form.custom_message.help_text %}
                                    <div class="form-text">{{ form.custom_message.help_text }}</div>
                                {% endif %}
                                {% if form.custom_message.errors %}
                                    <div class="invalid-feedback d-block">{{ form.custom_message.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-check">
                                {{ form.send_immediately }}
                                <label class="form-check-label" for="{{ form.send_immediately.id_for_label }}">
                                    {{ form.send_immediately.label }}
                                </label>
                                <div class="form-text">å–æ¶ˆå‹¾é¸å°‡åªå»ºç«‹é‚€è«‹è¨˜éŒ„ï¼Œä¸ç™¼é€éƒµä»¶</div>
                            </div>
                            {% endif %}
                        {% endif %}
                        
                        <!-- æäº¤æŒ‰éˆ• -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'test_templates' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>è¿”å›
                            </a>
                            
                            {% if is_quick_mode or form.invitees.field.queryset.count > 0 %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>
                                {% if is_quick_mode %}ç«‹å³é‚€è«‹{% else %}ç™¼é€é‚€è«‹{% endif %}
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- å³å´ï¼šæ¸¬é©—é …ç›®è³‡è¨Š -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>æ¸¬é©—é …ç›®è³‡è¨Š
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">{{ project.name }}</h6>
                    <p class="text-muted">{{ project.description|default:"æš«ç„¡æè¿°" }}</p>
                    
                    <div class="small">
                        <div class="mb-2">
                            <strong>è©•åˆ†æ¬„ä½ï¼š</strong>{{ project.score_field_chinese }}
                        </div>
                        <div class="mb-2">
                            <strong>é æ¸¬æ¬„ä½ï¼š</strong>{{ project.prediction_field_chinese }}
                        </div>
                        <div class="mb-2">
                            <strong>å»ºç«‹æ™‚é–“ï¼š</strong>{{ project.created_at|date:"Y/m/d" }}
                        </div>
                    </div>
                </div>
            </div>
            
            {% if not is_quick_mode and invitee_stats %}
            <!-- å—æ¸¬äººå“¡çµ±è¨ˆ -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>å—æ¸¬äººå“¡çµ±è¨ˆ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4 text-primary mb-0">{{ invitee_stats.total }}</div>
                            <small class="text-muted">ç¸½äººæ•¸</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-success mb-0">{{ invitee_stats.no_invitations }}</div>
                            <small class="text-muted">æœªé‚€è«‹é</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{% url 'invitee_list' %}" class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-people me-1"></i>ç®¡ç†å—æ¸¬äººå“¡
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// è‡ªè¨‚æ™‚é–“é¡¯ç¤º/éš±è—
function toggleCustomDate() {
    const expiresSelect = document.querySelector('select[name="expires_in_days"]');
    const customContainers = document.querySelectorAll('.custom-date-container');
    
    if (expiresSelect && customContainers.length > 0) {
        customContainers.forEach(customContainer => {
            const customInput = customContainer.querySelector('input');
            
            if (expiresSelect.value === 'custom') {
                customContainer.style.display = 'block';
                if (customInput) {
                    customInput.style.display = 'block';
                    customInput.required = true;
                }
            } else {
                customContainer.style.display = 'none';
                if (customInput) {
                    customInput.style.display = 'none';
                    customInput.required = false;
                }
            }
        });
    }
}

// å—æ¸¬äººå“¡æœå°‹
function filterInvitees() {
    const searchText = document.getElementById('searchInvitees').value.toLowerCase();
    const inviteeItems = document.querySelectorAll('.invitee-item');
    
    inviteeItems.forEach(item => {
        const name = item.dataset.name.toLowerCase();
        const email = item.dataset.email.toLowerCase();
        
        if (name.includes(searchText) || email.includes(searchText)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// å…¨é¸/å–æ¶ˆå…¨é¸
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllInvitees');
    const inviteeCheckboxes = document.querySelectorAll('input[name="invitees"]');
    
    inviteeCheckboxes.forEach(checkbox => {
        const item = checkbox.closest('.invitee-item');
        if (item.style.display !== 'none') {
            checkbox.checked = selectAllCheckbox.checked;
        }
    });
    
    updateSelectedCount();
}

// æ›´æ–°é¸ä¸­è¨ˆæ•¸
function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('input[name="invitees"]:checked');
    const countElement = document.getElementById('selectedCount');
    
    if (countElement) {
        countElement.textContent = selectedCheckboxes.length;
    }
    
    // æ›´æ–°å…¨é¸checkboxç‹€æ…‹
    const selectAllCheckbox = document.getElementById('selectAllInvitees');
    const allCheckboxes = document.querySelectorAll('input[name="invitees"]');
    const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => {
        const item = cb.closest('.invitee-item');
        return item.style.display !== 'none';
    });
    
    if (selectAllCheckbox && visibleCheckboxes.length > 0) {
        const checkedVisibleBoxes = visibleCheckboxes.filter(cb => cb.checked);
        selectAllCheckbox.checked = checkedVisibleBoxes.length === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedVisibleBoxes.length > 0 && checkedVisibleBoxes.length < visibleCheckboxes.length;
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ç¶å®šcheckboxè®Šæ›´äº‹ä»¶
    document.querySelectorAll('input[name="invitees"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // åˆå§‹åŒ–é¸ä¸­è¨ˆæ•¸
    updateSelectedCount();
    
    // åˆå§‹åŒ–è‡ªè¨‚æ™‚é–“
    toggleCustomDate();
    
    // ç¶å®šé‚€è«‹æœ‰æ•ˆæœŸé–“çš„changeäº‹ä»¶
    const expiresSelect = document.querySelector('select[name="expires_in_days"]');
    if (expiresSelect) {
        expiresSelect.addEventListener('change', toggleCustomDate);
    }
    
    // è¡¨å–®æäº¤æ™‚é¡¯ç¤º loading
    const form = document.getElementById('invitationForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // åŸºæœ¬é©—è­‰
            if (!form.checkValidity()) {
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†å—æ¸¬äººå“¡ï¼ˆéå¿«é€Ÿé‚€è«‹æ¨¡å¼ï¼‰
            const isQuickMode = document.querySelector('input[name="name"]') !== null;
            if (!isQuickMode) {
                const selectedInvitees = document.querySelectorAll('input[name="invitees"]:checked');
                if (selectedInvitees.length === 0) {
                    e.preventDefault();
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½å—æ¸¬äººå“¡ï¼');
                    return;
                }
            }
            
            // é¡¯ç¤º loading
            if (window.showLoading) {
                window.showLoading('æ­£åœ¨ç™¼é€æ¸¬é©—é‚€è«‹...', 'è«‹ç¨å€™ï¼Œç³»çµ±æ­£åœ¨å»ºç«‹é‚€è«‹ä¸¦ç™¼é€éƒµä»¶');
            }
            
            // ç¦ç”¨æäº¤æŒ‰éˆ•
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ç™¼é€ä¸­...';
            }
            
            // ğŸ”§ åŠ å…¥è¶…æ™‚ä¿è­·ï¼š10ç§’å¾Œæª¢æŸ¥é é¢ç‹€æ…‹
            setTimeout(() => {
                if (window.loadingOverlay?.isShowing()) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰æˆåŠŸè¨Šæ¯
                    const hasSuccessMessage = document.querySelector('.alert-success, .messages .alert-success');
                    if (hasSuccessMessage) {
                        // æœ‰æˆåŠŸè¨Šæ¯ï¼Œå˜—è©¦è·³è½‰
                        window.hideLoading();
                        const projectId = window.location.pathname.match(/test-projects\/(\d+)/);
                        if (projectId) {
                            window.location.href = `/enterprise/test-projects/${projectId[1]}/stats/`;
                        } else {
                            window.location.reload();
                        }
                    } else {
                        // æ²’æœ‰æˆåŠŸè¨Šæ¯ï¼Œå¯èƒ½æœ‰éŒ¯èª¤æˆ–å¡ä½äº†
                        window.hideLoading();
                        // æ¢å¾©æŒ‰éˆ•
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-send me-1"></i>' + 
                                                (isQuickMode ? 'ç«‹å³é‚€è«‹' : 'ç™¼é€é‚€è«‹');
                        }
                        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
                        const hasErrorMessage = document.querySelector('.alert-danger, .messages .alert-danger');
                        if (!hasErrorMessage) {
                            alert('æäº¤è¶…æ™‚ï¼Œè«‹é‡è©¦æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·š');
                        }
                    }
                }
            }, 10000); // 10ç§’è¶…æ™‚
        });
    }
});
</script>
{% endblock %}
