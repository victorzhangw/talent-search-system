{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}æ¸¬é©—çµæœè©³æƒ… - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<li class="breadcrumb-item"><a href="{% url 'test_result_list' %}">è©•é‘‘çµæœåˆ—è¡¨</a></li>
<li class="breadcrumb-item active">æ¸¬é©—çµæœè©³æƒ…</li>
{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .radar-chart-container {
        position: relative;
        height: 500px;
        width: 100%;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    #categoryRadarChart {
        max-width: 100%;
        max-height: 500px;
    }
    
    .trait-score-bar {
        height: 20px;
        background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }
    
    .trait-score-fill {
        height: 100%;
        background: linear-gradient(to right, #007bff, #28a745);
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .trait-score-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .info-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-completed { background-color: #28a745; }
    .status-failed { background-color: #dc3545; }
    .status-crawling { background-color: #ffc107; animation: pulse 1.5s infinite; }

    .card-header {
        background-color: #EAF8FA;
    }

    .alert-success {
        background-color: #F0F6ED;
        border: none;
    }
    
    .alert-danger {
        background-color: #FEECED;
        border: none;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #007bff;
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 1.25rem;
        width: 2px;
        height: calc(100% - 0.5rem);
        background: #e9ecef;
    }
    
    .timeline-item:last-child::after {
        display: none;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- çµæœæ¨™é¡Œå€åŸŸ -->
    <div class="result-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-1">
                    <i class="bi bi-person-circle me-2"></i>{{ result.test_invitation.invitee.name }}
                </h4>
                <p class="mb-2 opacity-75">
                    
                </p>
                <h4 class="mb-1">
                    <i class="bi bi-clipboard-check me-2"></i>{{ result.test_project.name }}
                </h4>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    {% if result.crawl_status == 'completed' %}
                        <a href="{% url 'generate_test_result_pdf' result.id %}" class="btn btn-light">
                            <i class="bi bi-file-pdf me-1"></i>ä¸‹è¼‰å ±å‘Š
                        </a>
                        {% if is_admin %}
                        <a href="{% url 'view_raw_data' result.id %}" class="btn btn-outline-light" target="_blank" title="ç®¡ç†å“¡ï¼šæŸ¥çœ‹çˆ¬èŸ²åŸå§‹æ•¸æ“š">
                            <i class="bi bi-code-square me-1"></i>æŸ¥çœ‹æ•¸æ“š
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€è¡Œï¼šå·¦å´åŸºæœ¬è³‡è¨Š + å³å´é›·é”åœ– (col-lg-6 + col-lg-6) -->
    <div class="row">
        <!-- å·¦å´ï¼šæ¸¬é©—çµæœæ¦‚æ³ã€å—æ¸¬è€…è³‡è¨Šæ¬„ä½ã€æ¸¬é©—ç‹€æ…‹æ¬„ä½ (col-lg-6) -->
        <div class="col-lg-6">
            <!-- æ¸¬é©—çµæœæ¦‚æ³ -->
            {% comment %}æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ•¸æ“šå¯é¡¯ç¤º{% endcomment %}
            {% with score_exists=False prediction_exists=False %}
                {% if result.test_project.score_field_chinese and result.test_project.score_field_system %}
                    {% with score_value_direct=result.raw_data|get_item:result.test_project.score_field_system %}
                    {% with score_value_performance=result.raw_data.performance_metrics|get_item:result.test_project.score_field_system %}
                        {% if score_value_performance or score_value_direct %}
                            {% with score_exists=True %}{% endwith %}
                        {% endif %}
                    {% endwith %}
                    {% endwith %}
                {% endif %}
                
                {% if result.test_project.prediction_field_chinese and result.test_project.prediction_field_system %}
                    {% with prediction_value_direct=result.raw_data|get_item:result.test_project.prediction_field_system %}
                    {% with prediction_value_performance=result.raw_data.performance_metrics|get_item:result.test_project.prediction_field_system %}
                        {% if prediction_value_performance or prediction_value_direct %}
                            {% with prediction_exists=True %}{% endwith %}
                        {% endif %}
                    {% endwith %}
                    {% endwith %}
                {% endif %}
            {% endwith %}
            
            {% comment %}ç°¡åŒ–ç‰ˆæœ¬ï¼šç›´æ¥æª¢æŸ¥æ•¸æ“š{% endcomment %}
            {% if result.test_project.score_field_chinese and result.test_project.score_field_system and result.raw_data.performance_metrics|get_item:result.test_project.score_field_system or result.test_project.prediction_field_chinese and result.test_project.prediction_field_system and result.raw_data.performance_metrics|get_item:result.test_project.prediction_field_system %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>æ¸¬é©—çµæœ
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- è©•åˆ†æŒ‡æ¨™ -->
                        {% if result.test_project.score_field_chinese and result.test_project.score_field_system %}
                            {% with score_value_direct=result.raw_data|get_item:result.test_project.score_field_system %}
                            {% with score_value_performance=result.raw_data.performance_metrics|get_item:result.test_project.score_field_system %}
                            {% if score_value_performance or score_value_direct %}
                            <div class="col-md-6">
                                <div class="p-4 border rounded">
                                    <div class="row align-items-center">
                                        <!-- å·¦å´ï¼šæ–‡å­—å…§å®¹ -->
                                        <div class="col-6 text-center">
                                            <!-- è©•åˆ†æ¬„ä½ä¸­æ–‡åç¨± -->
                                            <h6 class="text-muted mb-1">{{ result.test_project.score_field_chinese }}</h6>
                                            
                                            <!-- Composite Index æè¿°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
                                            {% with composite_description=result.raw_data.performance_metrics.Composite_Index_Description %}
                                            {% if composite_description %}
                                                {% with description_parts=composite_description|split:":" %}
                                                {% if description_parts|length > 1 %}
                                                    <div class="text-info small">{{ description_parts.1|trim }}</div>
                                                {% else %}
                                                    <div class="text-info small">{{ composite_description }}</div>
                                                {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                            {% endwith %}
                                        </div>
                                        
                                        <!-- å³å´ï¼šå¤§æ•¸å­— -->
                                        <div class="col-6 text-center">
                                            {% with ci_raw_value=result.raw_data.performance_metrics.CI_Raw_Value %}
                                            {% if ci_raw_value %}
                                                <h1 class="display-3 text-info mb-0 fw-bold fs-1">{{ ci_raw_value }}</h1>
                                            {% elif score_value_performance %}
                                                {% with clean_score=score_value_performance|cut:"%" %}
                                                <h1 class="display-3 text-info mb-0 fw-bold fs-1">{{ clean_score }}</h1>
                                                {% endwith %}
                                            {% else %}
                                                {% with clean_score=score_value_direct|cut:"%" %}
                                                <h1 class="display-3 text-info mb-0 fw-bold fs-1">{{ clean_score }}</h1>
                                                {% endwith %}
                                            {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endif %}
                        
                        <!-- é æ¸¬æŒ‡æ¨™ -->
                        {% if result.test_project.prediction_field_chinese and result.test_project.prediction_field_system %}
                            {% with prediction_value_direct=result.raw_data|get_item:result.test_project.prediction_field_system %}
                            {% with prediction_value_performance=result.raw_data.performance_metrics|get_item:result.test_project.prediction_field_system %}
                            {% if prediction_value_performance or prediction_value_direct %}
                            <div class="col-md-6">
                                <div class="p-4 border rounded">
                                    <div class="row align-items-center">
                                        <!-- å·¦å´ï¼šæ–‡å­—å…§å®¹ -->
                                        <div class="col-8 text-center">
                                            <h6 class="text-muted mb-1">{{ result.test_project.prediction_field_chinese }}</h6>
                                        </div>
                                        <!-- å³å´ï¼šæ•¸å€¼ -->
                                        <div class="col-4 text-start">
                                            {% if prediction_value_performance %}
                                                <h1 class="display-3 mb-0 fw-bold fs-1" style="color: #FB828B;">{{ prediction_value_performance }}</h1>
                                            {% else %}
                                                <h1 class="display-3 mb-0 fw-bold fs-1" style="color: #FB828B;">{{ prediction_value_direct }}</h1>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- å—æ¸¬è€…è³‡è¨Šèˆ‡æ¸¬é©—ç‹€æ…‹ -->
            <div class="row">
                <!-- å—æ¸¬è€…è³‡è¨Šæ¬„ä½ -->
                <div class="col-lg-6">
                    <div class="card info-card mb-4" style="min-height: 350px;">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-person me-2"></i>å—æ¸¬è€…è³‡è¨Š
                            </h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="fw-bold text-muted">å§“åï¼š</td>
                                    <td>{{ result.test_invitation.invitee.name }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Emailï¼š</td>
                                    <td>{{ result.test_invitation.invitee.email }}</td>
                                </tr>
                                {% if result.test_invitation.invitee.company %}
                                <tr>
                                    <td class="fw-bold text-muted">å…¬å¸ï¼š</td>
                                    <td>{{ result.test_invitation.invitee.company }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td class="fw-bold text-muted">ç‹€æ…‹ï¼š</td>
                                    <td>
                                        <span class="badge bg-{% if result.test_invitation.invitee.status == 'employed' %}primary{% else %}secondary{% endif %}">
                                            {{ result.test_invitation.invitee.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% if result.test_invitation.invitee.position %}
                                <tr>
                                    <td class="fw-bold text-muted">è·ä½ï¼š</td>
                                    <td>{{ result.test_invitation.invitee.position }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td class="fw-bold text-muted">æ¸¬é©—é …ç›®ï¼š</td>
                                    <td>{{ result.test_project.name }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ¸¬é©—ç‹€æ…‹æ¬„ä½ -->
                <div class="col-lg-6">
                    <div class="card info-card mb-4" style="min-height: 350px;">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>æ¸¬é©—ç‹€æ…‹
                            </h6>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-center mb-3">
                                {% if result.crawl_status == 'completed' %}
                                    <span class="status-indicator status-completed"></span>
                                    <span class="badge bg-success">æ¸¬é©—å®Œæˆ</span>
                                {% elif result.crawl_status == 'failed' %}
                                    <span class="status-indicator status-failed"></span>
                                    <span class="badge bg-danger">å–å¾—å¤±æ•—</span>
                                {% elif result.crawl_status == 'crawling' %}
                                    <span class="status-indicator status-crawling"></span>
                                    <span class="badge bg-warning">å–å¾—ä¸­</span>
                                {% else %}
                                    <span class="status-indicator bg-secondary"></span>
                                    <span class="badge bg-secondary">å¾…å–å¾—</span>
                                {% endif %}
                            </div>
                            
                            <!-- æ™‚é–“è»¸ -->
                            <div class="timeline flex-grow-1">
                                <div class="timeline-item">
                                    <strong>é‚€è«‹ç™¼é€</strong>
                                    <div class="text-muted small">{{ result.test_invitation.invited_at|date:"Y-m-d H:i" }}</div>
                                </div>
                                {% if result.test_invitation.started_at %}
                                <div class="timeline-item">
                                    <strong>é–‹å§‹æ¸¬é©—</strong>
                                    <div class="text-muted small">{{ result.test_invitation.started_at|date:"Y-m-d H:i" }}</div>
                                </div>
                                {% endif %}
                                {% if result.test_invitation.completed_at %}
                                <div class="timeline-item">
                                    <strong>å®Œæˆæ¸¬é©—</strong>
                                    <div class="text-muted small">{{ result.test_invitation.completed_at|date:"Y-m-d H:i" }}</div>
                                </div>
                                {% endif %}
                                {% if result.crawled_at %}
                                <div class="timeline-item">
                                    <strong>çµæœå–å¾—</strong>
                                    <div class="text-muted small">{{ result.crawled_at|date:"Y-m-d H:i" }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šç‰¹è³ªå‘åº¦é›·é”åœ– (col-lg-6) -->
        <div class="col-lg-6">
            <div class="card info-card mb-4" style="height: calc(100% - 1rem);">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>ç‰¹è³ªå‘åº¦é›·é”åœ–
                        <!-- {% if category_scores %}
                        <span class="badge bg-success">æœ‰æ•¸æ“š</span>
                        {% else %}
                        <span class="badge bg-warning">ç„¡æ•¸æ“š</span>
                        {% endif %} -->
                    </h6>
                </div>
                <div class="card-body py-2 d-flex align-items-center justify-content-center">
                    {% if category_scores %}
                    <div class="radar-chart-container">
                        <canvas id="categoryRadarChart" width="600" height="600"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-info w-100">
                        <p class="mb-0">æš«ç„¡æ¸¬é©—çµæœæ•¸æ“šå¯é¡¯ç¤ºé›·é”åœ–</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒè¡Œï¼šé—œéµç‰¹è³ªåˆ†æ•¸ (col-lg-12) -->
    <div class="row">
        <div class="col-lg-12">
            {% if category_traits %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-star me-2"></i>é—œéµç‰¹è³ªåˆ†æ•¸
                    </h6>
                </div>
                <div class="card-body px-4">
                    <table class="table table-borderless">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 20%;">ç‰¹è³ªåç¨±</th>
                                <th class="text-center" style="width: 10%;"></th>
                                <th class="text-center" style="width: 70%;">åˆ†æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% with unique_traits=category_traits|get_unique_traits %}
                            {% for trait in unique_traits %}
                            {% with headsupflag=result.raw_data|get_headsupflag:trait.system_name %}
                            <tr>
                                <td class="align-middle">
                                    <strong>{{ trait.name }}</strong>
                                </td>
                                <td class="align-middle text-center">
                                    {{ trait.score|floatformat:0 }}
                                </td>
                                <td class="align-middle text-center">
                                    <div class="progress position-relative" style="height: 25px; background-color: #e9ecef;">
                                        <div class="progress-bar" 
                                             role="progressbar" 
                                             style="width: {{ trait.score }}%; background-color: {% if headsupflag == 1 %}#FB828B{% else %}#9FDD95{% endif %};">
                                        </div>
                                        <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                                            <span class="text-white fw-bold">{{ trait.score|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                            {% endwith %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ç¬¬ä¸‰è¡Œï¼šå·¦å´åœ–è¡¨ + å³å´åˆ†æ (col-lg-4 + col-lg-8) -->
    {% if result.crawl_status == 'completed' %}
    <div class="row">
        <!-- å·¦å´ï¼šåœ–è¡¨èˆ‡ç™¼å±•å»ºè­°å€åŸŸ (col-lg-4) -->
        <div class="col-lg-4">
            <!-- ç‰¹è³ªå‘åº¦åˆ†æ•¸ -->
            {% if category_scores %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>ç‰¹è³ªå‘åº¦åˆ†æ•¸
                    </h6>
                </div>
                <div class="card-body">
                    {% for category, score in category_scores.items %}
                    {% with category_obj=result.test_project|get_category_by_name:category %}
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #FFF0C1;">
                            <h6 class="mb-0">{{ category }}</h6>
                            <span class="fw-bold fs-5">{{ score|floatformat:0 }}</span>
                        </div>
                        <div class="card-body">
                            {% if category_obj and category_obj.description %}
                                <p class="mb-0">{{ category_obj.description }}</p>
                            {% else %}
                                <p class="mb-0 text-muted">æš«ç„¡èªªæ˜</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ç™¼å±•å»ºè­°åƒæ•¸ -->
            {% if category_scores %}
            {% with highest_category=category_scores|get_highest_score_category %}
            {% if highest_category and highest_category.development_parameter_name %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-lightbulb me-2"></i>{{ highest_category.development_parameter_name }}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert ">
                        {{ highest_category.development_parameter_content|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endwith %}
            {% endif %}
        </div>

        <!-- å³å´ï¼šç¶œåˆåˆ†æå€åŸŸ (col-lg-8) -->
        <div class="col-lg-8">
            {% if mixed_role_categories %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>æ··åˆå‹äººæ‰
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-primary mb-0">
                        {{ mixed_role_sentence|default:'' }}
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- ç¶œåˆåˆ†æ -->
            {% if category_scores %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>ç¶œåˆåˆ†æ
                    </h6>
                </div>
                <div class="card-body">
                    {% with highest_category=category_scores|get_highest_score_category %}
                    {% with lowest_category=category_scores|get_lowest_score_category %}
                    {% if highest_category %}
                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="bi bi-arrow-up-circle me-1"></i>å„ªå‹¢é¢å‘
                        </h6>
                        <div class="alert alert-success">
                            <strong>{{ highest_category.name }}</strong>
                            <div class="mt-2">{{ highest_category.advantage_analysis|safe }}</div>
                        </div>
                        {% if mixed_role_categories %}
                            {% for category in mixed_role_categories %}
                                {% if not highest_category or category.id != highest_category.id %}
                                <div class="alert alert-success mt-3">
                                    <strong>{{ category.name }}</strong>
                                    <div class="mt-2">{{ category.advantage_analysis|default:'å°šæœªæä¾›è³‡æ–™'|safe }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if lowest_category %}
                    <div class="mb-3">
                        <h6 class="text-danger">
                            <i class="bi bi-arrow-down-circle me-1"></i>åŠ£å‹¢é¢å‘
                        </h6>
                        <div class="alert alert-danger text-dark">
                            <strong>{{ lowest_category.name }}</strong>
                            <div class="mt-2 ">{{ lowest_category.disadvantage_analysis|safe }}</div>
                        </div>
                        
                        
                    </div>
                    {% endif %}
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- çˆ¬å–å¤±æ•—æˆ–æœªå®Œæˆç‹€æ…‹ -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card info-card">
                <div class="card-body text-center py-5">
                    {% if result.crawl_status == 'failed' %}
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-danger">çˆ¬å–å¤±æ•—</h5>
                        <p class="text-muted">æ¸¬é©—çµæœçˆ¬å–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>
                        <button type="button" class="btn btn-warning" onclick="retryCrawling()">
                            <i class="bi bi-arrow-clockwise me-1"></i>é‡æ–°çˆ¬å–
                        </button>
                    {% elif result.crawl_status == 'crawling' %}
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">çˆ¬å–ä¸­...</span>
                        </div>
                        <h5 class="mt-3">æ­£åœ¨çˆ¬å–æ¸¬é©—çµæœ</h5>
                        <p class="text-muted">è«‹ç¨å¾Œï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚</p>
                    {% else %}
                        <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-warning">å¾…çˆ¬å–</h5>
                        <p class="text-muted">æ¸¬é©—çµæœå°šæœªé–‹å§‹çˆ¬å–ã€‚</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if has_debug_data %}
<div class="card info-card mb-4 border border-warning">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #FFF5E6;">
        <div>
            <h6 class="mb-0"><i class="bi bi-bug me-2"></i>ç‰¹è³ªæ¯”å° Debug</h6>
            <small class="text-muted">å·¦å´ç‚ºè³‡æ–™åº«åˆ†é¡è¨­å®šï¼Œå³å´ç‚ºçˆ¬èŸ²æŠ“åˆ°çš„ç‰¹è³ªåˆ†æ•¸ã€‚</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">è³‡æ–™åº«åˆ†é¡ç‰¹è³ª</h6>
                {% if debug_project_traits %}
                <div class="accordion" id="dbTraitsAccordion">
                    {% for category_name, category_info in debug_project_traits.items %}
                    {% with traits=category_info.traits included=category_info.included has_missing=category_info.has_missing %}
                    <div class="accordion-item {% if has_missing %}border border-danger{% endif %}">
                        <h2 class="accordion-header" id="heading-db-{{ forloop.counter }}">
                            <button class="accordion-button collapsed {% if has_missing %}text-danger bg-danger-subtle{% elif not included %}bg-warning-subtle{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-db-{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse-db-{{ forloop.counter }}">
                                {{ category_name }}
                                <span class="badge bg-secondary ms-2">{{ traits|length }}</span>
                                {% if has_missing %}
                                <span class="badge bg-danger ms-2">æœ‰ç‰¹è³ªæœªè¨ˆç®—</span>
                                {% elif not included %}
                                <span class="badge bg-warning text-dark ms-2">æœªåƒèˆ‡è¨ˆç®—</span>
                                {% else %}
                                <span class="badge bg-success ms-2">å…¨éƒ¨è¨ˆç®—</span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse-db-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading-db-{{ forloop.counter }}" data-bs-parent="#dbTraitsAccordion">
                            <div class="accordion-body p-2">
                                {% if traits %}
                                <ul class="list-group list-group-flush">
                                    {% for trait in traits %}
                                    <li class="list-group-item px-2 py-1 d-flex justify-content-between align-items-center {% if not trait.matched %}bg-warning-subtle border-warning text-danger{% endif %}">
                                        <div>
                                            <div class="fw-semibold">
                                                {{ trait.system_name }}
                                                {% if not trait.matched %}
                                                <span class="badge bg-danger ms-2">æœªæ‰¾åˆ°åˆ†æ•¸</span>
                                                {% else %}
                                                <span class="badge bg-success-subtle text-success border border-success ms-2">å·²è¨ˆç®—</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {{ trait.chinese_name }} (ID: {{ trait.trait_id }})
                                                {% if trait.score is not None %}
                                                    Â· åˆ†æ•¸ {{ trait.score|floatformat:2 }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <span class="badge bg-light text-dark border">æ¬Šé‡ {{ trait.weight }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <div class="text-muted">æ­¤åˆ†é¡ç›®å‰æœªè¨­å®šç‰¹è³ªã€‚</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted">æœªæ‰¾åˆ°åˆ†é¡ç‰¹è³ªè¨­å®šã€‚</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">çˆ¬èŸ²æŠ“åˆ°çš„ç‰¹è³ªåˆ†æ•¸</h6>
                {% if debug_raw_traits %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 35%;">Key</th>
                                <th style="width: 35%;">ä¸­æ–‡åç¨±</th>
                                <th style="width: 15%;">åˆ†æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trait in debug_raw_traits %}
                            <tr class="{% if not trait.matched %}table-warning{% endif %}">
                                <td class="fw-semibold">{{ trait.key }}</td>
                                <td>{{ trait.chinese_name|default:"-" }}</td>
                                <td>
                                    {{ trait.score|default:"-" }}
                                    {% if not trait.matched %}
                                    <span class="badge bg-danger-subtle text-danger border border-danger ms-1">æœªåŒ¹é…åˆ†é¡</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted">çˆ¬èŸ²è³‡æ–™ä¸­æœªæ‰¾åˆ°ç‰¹è³ªåˆ†æ•¸ã€‚</div>
                {% endif %}
            </div>
        </div>
        {% if debug_summary_json %}
        <div class="mt-3">
            <h6 class="fw-bold">JSON åŒ¹é…æ‘˜è¦</h6>
            <pre class="bg-dark text-light p-3 small overflow-auto" style="max-height: 460px;">{{ debug_summary_json|safe }}</pre>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Chart.js Script -->
{% if category_scores %}
<script>
// å‹•æ…‹è¼‰å…¥ä¸¦å‰µå»ºåœ–è¡¨
function loadAndCreateChart() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        const canvas = document.getElementById('categoryRadarChart');
        if (canvas) {
            const chart = new Chart(canvas, {
                type: 'radar',
                data: {
                    labels: {{ category_labels|safe }},
                    datasets: [{
                        label: 'åˆ†é¡èƒ½åŠ›è©•ä¼°',
                        data: {{ category_values|safe }},
                        borderColor: '#4285f4',
                        backgroundColor: 'rgba(66, 133, 244, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#4285f4',
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return Math.round(context.parsed.r);
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                stepSize: 20,
                                display: true,
                                backdropColor: 'rgba(255, 255, 255, 0.8)',
                                backdropPadding: 2,
                                callback: function(value, index, values) {
                                    if (value === 20 || value === 40 || value === 60 || value === 80 || value === 100) {
                                        return value;
                                    }
                                    return '';
                                },
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#666'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333',
                                callback: function(label, index) {
                                    const values = {{ category_values|safe }};
                                    return label + ' (' + Math.round(values[index]) + ')';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }
    };
    document.head.appendChild(script);
}

// ç«‹å³åŸ·è¡Œ
loadAndCreateChart();
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
console.log('ğŸš€ JavaScript é–‹å§‹è¼‰å…¥...');

// å…¨åŸŸå‡½æ•¸å®šç¾©
function handlePdfGeneration(link) {
    console.log('PDF æŒ‰éˆ•è¢«é»æ“Š:', link.href);
    window.open(link.href, '_blank');
    return false;
}

function testFunction() {
    console.log('æ¸¬è©¦å‡½æ•¸è¢«èª¿ç”¨');
    alert('æ¸¬è©¦å‡½æ•¸æ­£å¸¸å·¥ä½œï¼');
    return false;
}

// è¨»å†Šåˆ°å…¨åŸŸ
window.handlePdfGeneration = handlePdfGeneration;
window.testFunction = testFunction;

console.log('âœ… æ‰€æœ‰å‡½æ•¸å·²è¨»å†Š:', {
    handlePdfGeneration: typeof window.handlePdfGeneration,
    testFunction: typeof window.testFunction
});

console.log('âœ… å‡½æ•¸è¨»å†Šå®Œæˆï¼handlePdfGeneration: ' + typeof window.handlePdfGeneration);

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM è¼‰å…¥å®Œæˆ');
});
</script>
{% endblock %}
