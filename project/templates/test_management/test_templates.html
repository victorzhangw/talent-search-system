{% extends 'base.html' %}
{% load static %}

{% block title %}測驗項目選擇 - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">首頁</a></li>
<!-- <li class="breadcrumb-item"><a href="{% url 'enterprise_dashboard' %}">企業測驗管理</a></li> -->
<li class="breadcrumb-item active">評鑑邀請</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clipboard-check me-2"></i>評鑑邀請</h2>
    </div>

    <!-- 統計卡片 -->
    <!-- <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0">{{ stats.total }}</h4>
                            <p class="mb-0">可用測驗項目</p>
                        </div>
                        <i class="bi bi-clipboard-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0">{{ stats.all_open }}</h4>
                            <p class="mb-0">全部開放</p>
                        </div>
                        <i class="bi bi-globe fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0">{{ stats.enterprise_only }}</h4>
                            <p class="mb-0">企業專屬</p>
                        </div>
                        <i class="bi bi-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0">{{ stats.specific_assignment }}</h4>
                            <p class="mb-0">指定開放</p>
                        </div>
                        <i class="bi bi-person-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div> -->

    <!-- 測驗項目列表 -->
    {% if page_obj.object_list %}
        <div class="row">
            {% for project in page_obj.object_list %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">{{ project.name }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted mb-3">
                            {{ project.description|truncatechars:100|default:"暫無描述" }}
                        </p>
                        
                        <div class="small text-muted mb-3">
                            <i class="bi bi-calendar3 me-1"></i>
                            建立於 {{ project.created_at|date:"Y-m-d" }}
                        </div>
                        
                        <!-- 邀請統計 -->
                        <div class="row text-center small mb-3">
                            <div class="col-3">
                                <div class="text-primary">
                                    <i class="bi bi-envelope"></i>
                                    <div><strong>{{ project.invitation_stats.total }}</strong></div>
                                    <div class="text-muted">總計</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="text-warning">
                                    <i class="bi bi-clock"></i>
                                    <div><strong>{{ project.invitation_stats.pending|add:project.invitation_stats.in_progress|default:project.invitation_stats.pending }}</strong></div>
                                    <div class="text-muted">進行中</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="text-success">
                                    <i class="bi bi-check-circle"></i>
                                    <div><strong>{{ project.invitation_stats.completed }}</strong></div>
                                    <div class="text-muted">已完成</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="text-secondary">
                                    <i class="bi bi-x-circle"></i>
                                    <div><strong>{{ project.invitation_stats.expired|add:project.invitation_stats.cancelled|default:project.invitation_stats.expired }}</strong></div>
                                    <div class="text-muted">已結束</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 可選：添加詳細統計的提示（當有取消邀請時顯示） -->
                        {% if project.invitation_stats.cancelled > 0 %}
                        <div class="alert alert-info alert-sm py-1 px-2 small">
                            <i class="bi bi-info-circle me-1"></i>
                            已結束包含：已過期 {{ project.invitation_stats.expired }} 筆、已取消 {{ project.invitation_stats.cancelled }} 筆
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            <div class="btn-group">
                                <a href="{% url 'quick_invitation' project.id %}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-envelope-plus me-1"></i>快速邀請
                                </a>
                                <!-- <button type="button" class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                    <span class="visually-hidden">更多選項</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'bulk_invitation' %}">
                                            <i class="bi bi-file-spreadsheet me-2"></i>批次邀請
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'quick_invitation' project.id %}">
                                            <i class="bi bi-lightning me-2"></i>快速邀請
                                        </a>
                                    </li>
                                </ul> -->
                            </div>
                            <!-- <a href="{% url 'enterprise_test_project_stats' project.id %}" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-graph-up me-1"></i>查看測驗統計
                            </a> -->
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 分頁 -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="分頁導航">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">上一頁</a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if assignment_type_filter %}&assignment_type={{ assignment_type_filter }}{% endif %}">下一頁</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">暫無可用的測驗項目</h5>
            <p class="text-muted">請聯絡管理員為您指派測驗項目</p>
        </div>
    {% endif %}
</div>

<script>
// 移除舊的 startInvitation 函數，因為現在使用直接連結
</script>
{% endblock %}
