{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}æ¸¬é©—çµæœè©³æƒ… - UPDATED VERSION - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">å„€è¡¨æ¿</a></li>
<li class="breadcrumb-item"><a href="{% url 'test_result_list' %}">æ¸¬é©—çµæœç®¡ç†</a></li>
<li class="breadcrumb-item active">æ¸¬é©—çµæœè©³æƒ…</li>
{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .radar-chart-container {
        position: relative;
        height: 600px;
        width: 100%;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    #categoryRadarChart {
        max-width: 100%;
        max-height: 600px;
    }
    
    .category-score-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 15px;
        color: white;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .trait-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .trait-table-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        font-weight: bold;
    }
    
    .trait-score-bar {
        height: 20px;
        background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }
    
    .trait-score-fill {
        height: 100%;
        background: linear-gradient(to right, #007bff, #28a745);
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .trait-score-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .info-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .score-display {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        padding: 2rem;
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border-radius: 15px;
        margin: 1rem 0;
    }
    
    .category-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #007bff;
    }
    
    .trait-badge {
        background: linear-gradient(45deg, #6f42c1, #e83e8c);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.2rem;
        display: inline-block;
        font-size: 0.9rem;
    }
    
    .raw-data-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-completed { background-color: #28a745; }
    .status-failed { background-color: #dc3545; }
    .status-crawling { background-color: #ffc107; animation: pulse 1.5s infinite; }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #007bff;
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 1.25rem;
        width: 2px;
        height: calc(100% - 0.5rem);
        background: #e9ecef;
    }
    
    .timeline-item:last-child::after {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- çµæœæ¨™é¡Œå€åŸŸ -->
    <div class="result-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1">
                    <i class="bi bi-person-circle me-2"></i>{{ result.test_invitation.invitee.name }}
                    <span style="color: red; font-size: 12px;">[TEMPLATE UPDATED]</span>
                </h2>
                <p class="mb-2 opacity-75">
                    <i class="bi bi-envelope me-2"></i>{{ result.test_invitation.invitee.email }}
                </p>
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>{{ result.test_project.name }}
                </h5>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    {% if result.crawl_status == 'completed' %}
                        <a href="{% url 'generate_test_result_pdf' result.id %}" class="btn btn-light" target="_blank" onclick="return window.handlePdfGeneration ? window.handlePdfGeneration(this) : (console.error('handlePdfGeneration æœªå®šç¾©'), false);">
                            <i class="bi bi-file-pdf me-1"></i>ç”Ÿæˆå ±å‘Š
                        </a>
                        <a href="{% url 'generate_test_result_pdf' result.id %}" class="btn btn-outline-info btn-sm" target="_blank" title="ç›´æ¥ä¸‹è¼‰ï¼ˆå‚™ç”¨ï¼‰" onclick="window.addDebugMessage ? window.addDebugMessage('ğŸ”„ å‚™ç”¨æŒ‰éˆ•è¢«é»æ“Š: ' + this.href) : console.log('addDebugMessage æœªå®šç¾©'); console.log('å‚™ç”¨æŒ‰éˆ•è¢«é»æ“Š:', this.href);">
                            <i class="bi bi-download"></i>
                        </a>
                        {% if result.id %}
                        <a href="{% url 'export_test_result' result.id %}" class="btn btn-outline-light">
                            <i class="bi bi-download me-1"></i>åŒ¯å‡ºæ•¸æ“š
                        </a>
                        <button type="button" class="btn btn-warning btn-sm" onclick="return window.testFunction ? window.testFunction() : console.error('testFunction æœªå®šç¾©');">
                            ğŸ§ª æ¸¬è©¦
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦å´ï¼šåŸºæœ¬è³‡è¨Šå’Œç‹€æ…‹ -->
        <div class="col-lg-4">
            <!-- çˆ¬å–ç‹€æ…‹ -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>å—æ¸¬ç‹€æ…‹
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if result.crawl_status == 'completed' %}
                            <span class="status-indicator status-completed"></span>
                            <span class="badge bg-success">æ¸¬é©—å®Œæˆ</span>
                        {% elif result.crawl_status == 'failed' %}
                            <span class="status-indicator status-failed"></span>
                            <span class="badge bg-danger">å–å¾—å¤±æ•—</span>
                        {% elif result.crawl_status == 'crawling' %}
                            <span class="status-indicator status-crawling"></span>
                            <span class="badge bg-warning">å–å¾—ä¸­</span>
                        {% else %}
                            <span class="status-indicator bg-secondary"></span>
                            <span class="badge bg-secondary">å¾…å–å¾—</span>
                        {% endif %}
                    </div>
                    
                    <!-- æ™‚é–“è»¸ -->
                    <div class="timeline">
                        <div class="timeline-item">
                            <strong>é‚€è«‹ç™¼é€</strong>
                            <div class="text-muted small">{{ result.test_invitation.invited_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        {% if result.test_invitation.started_at %}
                        <div class="timeline-item">
                            <strong>é–‹å§‹æ¸¬é©—</strong>
                            <div class="text-muted small">{{ result.test_invitation.started_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        {% endif %}
                        {% if result.test_invitation.completed_at %}
                        <div class="timeline-item">
                            <strong>å®Œæˆæ¸¬é©—</strong>
                            <div class="text-muted small">{{ result.test_invitation.completed_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        {% endif %}
                        {% if result.crawled_at %}
                        <div class="timeline-item">
                            <strong>çµæœå–å¾—</strong>
                            <div class="text-muted small">{{ result.crawled_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- å—æ¸¬äººå“¡è³‡è¨Š -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-person me-2"></i>å—æ¸¬äººå“¡è³‡è¨Š
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless table-sm">
                        <tr>
                            <td class="fw-bold text-muted">å§“åï¼š</td>
                            <td>{{ result.test_invitation.invitee.name }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold text-muted">Emailï¼š</td>
                            <td>{{ result.test_invitation.invitee.email }}</td>
                        </tr>
                        {% if result.test_invitation.invitee.company %}
                        <tr>
                            <td class="fw-bold text-muted">å…¬å¸ï¼š</td>
                            <td>{{ result.test_invitation.invitee.company }}</td>
                        </tr>
                        {% endif %}
                        {% if result.test_invitation.invitee.position %}
                        <tr>
                            <td class="fw-bold text-muted">è·ä½ï¼š</td>
                            <td>{{ result.test_invitation.invitee.position }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="fw-bold text-muted">æ¸¬é©—é …ç›®ï¼š</td>
                            <td>{{ result.test_project.name }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å³å´ï¼šæ¸¬é©—çµæœ -->
        <div class="col-lg-8">
            {% if result.crawl_status == 'completed' %}
                <!-- è©•åˆ†çµæœ -->
                {% if result.score_value %}
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>{{ result.test_project.score_field_chinese|default:"è©•åˆ†çµæœ" }}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="score-display">
                            {{ result.score_value }}
                            {% if result.test_project.score_unit %}
                                <small class="opacity-75">{{ result.test_project.score_unit }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- é æ¸¬çµæœ -->
                {% if result.prediction_value %}
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i>{{ result.test_project.prediction_field_chinese|default:"é æ¸¬çµæœ" }}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            {{ result.prediction_value }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- åˆ†é¡çµæœ -->
                {% if result.category_results %}
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-tags me-2"></i>åˆ†é¡çµæœ
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for category, value in result.category_results.items %}
                        <div class="category-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ category }}</strong>
                                <span class="badge bg-primary">{{ value }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ç‰¹è³ªçµæœ -->
                {% if result.trait_results %}
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-puzzle me-2"></i>ç‰¹è³ªåˆ†æ
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for trait, value in result.trait_results.items %}
                            <span class="trait-badge">{{ trait }}: {{ value }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- åˆ†é¡é›·é”åœ– -->
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-diagram-3 me-2"></i>åˆ†é¡èƒ½åŠ›é›·é”åœ–
                            {% if category_scores %}
                            <span class="badge bg-success">æœ‰æ•¸æ“š</span>
                            {% else %}
                            <span class="badge bg-warning">ç„¡æ•¸æ“š</span>
                            {% endif %}
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if category_scores %}
                        <div class="radar-chart-container">
                            <canvas id="categoryRadarChart" width="600" height="600"></canvas>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p>æš«ç„¡æ¸¬é©—çµæœæ•¸æ“šå¯é¡¯ç¤ºé›·é”åœ–</p>
                        </div>
                        {% endif %}
                        
                        <script>
                            {% if category_scores %}
                            
                            // å‹•æ…‹è¼‰å…¥ä¸¦å‰µå»ºåœ–è¡¨
                            function loadAndCreateChart() {
                                const script = document.createElement('script');
                                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                                script.onload = function() {
                                    const canvas = document.getElementById('categoryRadarChart');
                                    if (canvas) {
                                        const chart = new Chart(canvas, {
                                            type: 'radar',
                                            data: {
                                                labels: {{ category_labels|safe }},
                                                datasets: [{
                                                    label: 'åˆ†é¡èƒ½åŠ›è©•ä¼°',
                                                    data: {{ category_values|safe }},
                                                    borderColor: '#4285f4',
                                                    backgroundColor: 'rgba(66, 133, 244, 0.2)',
                                                    borderWidth: 2,
                                                    pointBackgroundColor: '#4285f4',
                                                    pointBorderColor: '#fff',
                                                    pointRadius: 4,
                                                    fill: true
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: false,
                                                plugins: {
                                                    legend: { display: false },
                                                    tooltip: {
                                                        callbacks: {
                                                            label: function(context) {
                                                                return context.parsed.r.toFixed(1);
                                                            }
                                                        }
                                                    }
                                                },
                                                scales: {
                                                    r: {
                                                        beginAtZero: true,
                                                        max: 100,
                                                        ticks: { 
                                                            stepSize: 20,
                                                            display: true,
                                                            backdropColor: 'rgba(255, 255, 255, 0.8)',
                                                            backdropPadding: 2,
                                                            callback: function(value, index, values) {
                                                                if (value === 20 || value === 40 || value === 60 || value === 80 || value === 100) {
                                                                    return value;
                                                                }
                                                                return '';
                                                            },
                                                            font: {
                                                                size: 12,
                                                                weight: 'bold'
                                                            },
                                                            color: '#666'
                                                        },
                                                        pointLabels: {
                                                            font: {
                                                                size: 16,
                                                                weight: 'bold'
                                                            },
                                                            color: '#333',
                                                            callback: function(label, index) {
                                                                const values = {{ category_values|safe }};
                                                                return label + ' (' + values[index].toFixed(1) + ')';
                                                            }
                                                        },
                                                        grid: {
                                                            color: 'rgba(0, 0, 0, 0.1)'
                                                        },
                                                        angleLines: {
                                                            color: 'rgba(0, 0, 0, 0.1)'
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                    }
                                };
                                document.head.appendChild(script);
                            }
                            
                            // ç«‹å³åŸ·è¡Œ
                            loadAndCreateChart();
                            {% endif %}
                        </script>
                    </div>
                </div>

                <!-- æ¸¬é©—çµæœ -->
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-clipboard-data me-2"></i>æ¸¬é©—çµæœ
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Vehicles ä¸»è¦æŒ‡æ¨™ -->
                        {% if result.raw_data.vehicles %}
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h3 class="text-primary mb-1">{{ result.raw_data.vehicles }}</h3>
                                    <h6 class="text-muted mb-1">Vehicles</h6>
                                    <small class="text-success">{{ result.raw_data.vehicles_percentage }}%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h5 class="text-info mb-1">{{ result.raw_data.composite_index }}</h5>
                                    <h6 class="text-muted mb-1">Composite Index</h6>
                                    <small class="text-muted">{{ result.raw_data.vehicles_percentage }}% ç›¸å°æ‡‰ç­‰ç´š</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- åˆ†é¡ç‰¹è³ªè©³ç´°åˆ†æ -->
                        {% if category_traits %}
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-3">åˆ†é¡ç‰¹è³ªè©³ç´°åˆ†æ</h6>
                                {% for category_name, traits in category_traits.items %}
                                <div class="trait-table">
                                    <div class="trait-table-header">
                                        {{ category_name }}
                                        {% if category_scores %}
                                        <span class="float-end">å¹³å‡åˆ†æ•¸: {{ category_scores|get_item:category_name|floatformat:1 }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%;">ç‰¹è³ªåç¨±</th>
                                                    <th style="width: 15%;">åˆ†æ•¸</th>
                                                    <th style="width: 55%;">åˆ†æ•¸è¦–è¦ºåŒ–</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for trait in traits %}
                                                <tr>
                                                    <td><strong>{{ trait.name }}</strong></td>
                                                    <td>
                                                        <span class="badge {% if trait.score >= 80 %}bg-success{% elif trait.score >= 60 %}bg-info{% elif trait.score >= 40 %}bg-warning{% else %}bg-danger{% endif %}">
                                                            {{ trait.score|floatformat:1 }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="trait-score-bar">
                                                            <div class="trait-score-fill" style="width: {{ trait.score }}%;"></div>
                                                            <div class="trait-score-text">{{ trait.score|floatformat:1 }}%</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- æ¸¬é©—è©³ç´°è³‡è¨Š -->
                        {% if result.raw_data.details %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-info-circle me-2"></i>æ¸¬é©—è³‡è¨Š</h6>
                                    <div class="row">
                                        {% if result.raw_data.details.test_completion_time %}
                                        <div class="col-md-4">
                                            <strong>å®Œæˆæ™‚é–“ï¼š</strong>{{ result.raw_data.details.test_completion_time }}
                                        </div>
                                        {% endif %}
                                        {% if result.raw_data.details.test_date %}
                                        <div class="col-md-4">
                                            <strong>æ¸¬é©—æ—¥æœŸï¼š</strong>{{ result.raw_data.details.test_date|date:"Y-m-d H:i" }}
                                        </div>
                                        {% endif %}
                                        {% if result.raw_data.details.overall_assessment %}
                                        <div class="col-md-4">
                                            <strong>æ•´é«”è©•ä¼°ï¼š</strong>{{ result.raw_data.details.overall_assessment }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if result.raw_data.details.recommendations %}
                                    <div class="mt-3">
                                        <strong>å»ºè­°ï¼š</strong>{{ result.raw_data.details.recommendations }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- åŸå§‹æ•¸æ“šï¼ˆæ‘ºç–Šé¡¯ç¤ºï¼‰ -->
                <div class="card info-card">
                    <div class="card-header">
                        <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#rawDataCollapse">
                            <i class="bi bi-code me-2"></i>åŸå§‹æ•¸æ“š <i class="bi bi-chevron-down float-end"></i>
                        </button>
                    </div>
                    <div class="collapse" id="rawDataCollapse">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyRawData()">
                                    <i class="bi bi-clipboard me-1"></i>è¤‡è£½
                                </button>
                            </div>
                            <div class="raw-data-container">
                                <pre id="rawDataContent">{{ result.raw_data|pprint }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- çˆ¬å–å¤±æ•—æˆ–æœªå®Œæˆç‹€æ…‹ -->
                <div class="card info-card">
                    <div class="card-body text-center py-5">
                        {% if result.crawl_status == 'failed' %}
                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                            <h5 class="mt-3 text-danger">çˆ¬å–å¤±æ•—</h5>
                            <p class="text-muted">æ¸¬é©—çµæœçˆ¬å–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>
                            <button type="button" class="btn btn-warning" onclick="retryCrawling()">
                                <i class="bi bi-arrow-clockwise me-1"></i>é‡æ–°çˆ¬å–
                            </button>
                        {% elif result.crawl_status == 'crawling' %}
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">çˆ¬å–ä¸­...</span>
                            </div>
                            <h5 class="mt-3">æ­£åœ¨çˆ¬å–æ¸¬é©—çµæœ</h5>
                            <p class="text-muted">è«‹ç¨å¾Œï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚</p>
                        {% else %}
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
                            <h5 class="mt-3 text-warning">å¾…çˆ¬å–</h5>
                            <p class="text-muted">æ¸¬é©—çµæœå°šæœªé–‹å§‹çˆ¬å–ã€‚</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('ğŸš€ JavaScript é–‹å§‹è¼‰å…¥...');

// å…¨åŸŸå‡½æ•¸å®šç¾©
function addDebugMessage(message) {
    console.log('[èª¿è©¦] ' + message);
    const container = document.createElement('div');
    container.style.cssText = 'position:fixed;top:10px;right:10px;background:black;color:lime;padding:10px;z-index:9999;font-family:monospace;border:1px solid lime;max-width:300px;';
    container.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
    document.body.appendChild(container);
    setTimeout(() => container.remove(), 5000);
}

function handlePdfGeneration(link) {
    console.log('PDF æŒ‰éˆ•è¢«é»æ“Š:', link.href);
    addDebugMessage('PDF æŒ‰éˆ•è¢«é»æ“Š');
    window.open(link.href, '_blank');
    return false;
}

function testFunction() {
    console.log('æ¸¬è©¦å‡½æ•¸è¢«èª¿ç”¨');
    alert('æ¸¬è©¦å‡½æ•¸æ­£å¸¸å·¥ä½œï¼');
    return false;
}

// è¨»å†Šåˆ°å…¨åŸŸ
window.addDebugMessage = addDebugMessage;
window.handlePdfGeneration = handlePdfGeneration;
window.testFunction = testFunction;

console.log('âœ… æ‰€æœ‰å‡½æ•¸å·²è¨»å†Š:', {
    addDebugMessage: typeof window.addDebugMessage,
    handlePdfGeneration: typeof window.handlePdfGeneration,
    testFunction: typeof window.testFunction
});

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM è¼‰å…¥å®Œæˆ');
    // èª¿è©¦è¨Šæ¯å·²ç¦ç”¨
});
</script>
{% endblock %}
    let debugContainer = document.getElementById('debugContainer');
    if (!debugContainer) {
        debugContainer = document.createElement('div');
        debugContainer.id = 'debugContainer';
        debugContainer.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 9999;
            font-family: 'Courier New', monospace;
            border: 2px solid #00ff00;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(debugContainer);
        
        // æ·»åŠ æ¨™é¡Œ
        const title = document.createElement('div');
        title.textContent = 'ğŸ” PDF ç”Ÿæˆèª¿è©¦è³‡è¨Š';
        title.style.cssText = 'font-weight: bold; border-bottom: 1px solid #00ff00; padding-bottom: 5px; margin-bottom: 10px; color: #ffff00;';
        debugContainer.appendChild(title);
        
        // æ·»åŠ é—œé–‰æŒ‰éˆ•
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = 'position: absolute; top: 5px; right: 8px; background: none; border: none; color: #ff6b6b; font-size: 18px; cursor: pointer; font-weight: bold;';
        closeBtn.onclick = () => debugContainer.remove();
        debugContainer.appendChild(closeBtn);
    }
    
    const timestamp = new Date().toLocaleTimeString();
    const debugLine = document.createElement('div');
    debugLine.textContent = `[${timestamp}] ${message}`;
    debugLine.style.cssText = 'margin-bottom: 3px; padding: 2px 0; border-left: 3px solid #00ff00; padding-left: 8px;';
    debugContainer.appendChild(debugLine);
    
    // æ»¾å‹•åˆ°åº•éƒ¨
    debugContainer.scrollTop = debugContainer.scrollHeight;
    
    // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
    console.log(`[PDF èª¿è©¦] ${message}`);
}
// ç«‹å³è¨»å†Šåˆ°å…¨åŸŸ
window.addDebugMessage = addDebugMessage;
console.log('âœ… addDebugMessage å·²å®šç¾©ä¸¦è¨»å†Š');

// è™•ç† PDF ç”Ÿæˆï¼ˆä¸»è¦å‡½æ•¸ï¼‰
function handlePdfGeneration(link) {
    console.log('=== PDF ç”ŸæˆæŒ‰éˆ•è¢«é»æ“Š ===');
    console.log('é€£çµç¶²å€:', link.href);
    console.log('ç›®å‰æ™‚é–“:', new Date().toISOString());
    
    // æ·»åŠ æŒä¹…åŒ–èª¿è©¦è³‡è¨Šåˆ°é é¢
    addDebugMessage('PDF ç”ŸæˆæŒ‰éˆ•è¢«é»æ“Š: ' + link.href);
    
    // é¡¯ç¤ºè¼‰å…¥æç¤º
    const originalText = link.innerHTML;
    link.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>ç”Ÿæˆä¸­...';
    link.classList.add('disabled');
    
    // ä½¿ç”¨ fetch ä¾†æ¸¬è©¦é€£çµæ˜¯å¦å¯å­˜å–
    addDebugMessage('é–‹å§‹æ¸¬è©¦ PDF é€£çµ...');
    
    fetch(link.href, {
        method: 'HEAD',
        credentials: 'same-origin'
    })
    .then(response => {
        addDebugMessage('PDF é€£çµå›æ‡‰: ' + response.status + ' ' + response.statusText);
        console.log('PDF é€£çµæ¸¬è©¦å›æ‡‰:', response.status, response.statusText);
        
        if (response.ok) {
            // é€£çµæ­£å¸¸ï¼Œå˜—è©¦æ‰“é–‹æ–°è¦–çª—
            addDebugMessage('é€£çµæ­£å¸¸ï¼Œæ­£åœ¨é–‹å•Ÿæ–°è¦–çª—...');
            const newWindow = window.open(link.href, '_blank');
            
            if (newWindow) {
                addDebugMessage('âœ… æ–°è¦–çª—å·²æˆåŠŸé–‹å•Ÿ');
                console.log('PDF æ–°è¦–çª—å·²æˆåŠŸé–‹å•Ÿ');
                showToast('å ±å‘Šæ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹æŸ¥çœ‹æ–°é–‹å•Ÿçš„åˆ†é ', 'success');
            } else {
                addDebugMessage('âŒ å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹');
                console.log('å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹');
                showToast('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—æˆ–é»æ“Šå‚™ç”¨æŒ‰éˆ•', 'warning');
                // å˜—è©¦ç›´æ¥å°èˆªåˆ°è©²é é¢
                addDebugMessage('å˜—è©¦ç›´æ¥è·³è½‰é é¢...');
                window.location.href = link.href;
            }
        } else {
            addDebugMessage('âŒ é€£çµå›æ‡‰éŒ¯èª¤: HTTP ' + response.status);
            console.error('PDF é€£çµéŒ¯èª¤:', response.status);
            showToast('ç”Ÿæˆå ±å‘Šå¤±æ•—: HTTP ' + response.status, 'danger');
        }
    })
    .catch(error => {
        addDebugMessage('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤: ' + error.message);
        console.error('PDF é€£çµæ¸¬è©¦å¤±æ•—:', error);
        showToast('ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦', 'danger');
    })
    .finally(() => {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        setTimeout(() => {
            link.innerHTML = originalText;
            link.classList.remove('disabled');
        }, 3000);
    });
    
    // é˜»æ­¢é»˜èªäº‹ä»¶
    return false;
}
// ç«‹å³è¨»å†Šåˆ°å…¨åŸŸ
window.handlePdfGeneration = handlePdfGeneration;
console.log('âœ… handlePdfGeneration å·²å®šç¾©ä¸¦è¨»å†Š');

// è¤‡è£½åŸå§‹æ•¸æ“š
function copyRawData() {
    const rawDataContent = document.getElementById('rawDataContent');
    const text = rawDataContent.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
        showToast('åŸå§‹æ•¸æ“šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿', 'success');
    }, function(err) {
        console.error('è¤‡è£½å¤±æ•—: ', err);
        showToast('è¤‡è£½å¤±æ•—', 'danger');
    });
}
// ç«‹å³è¨»å†Šåˆ°å…¨åŸŸ
window.copyRawData = copyRawData;

// ç”Ÿæˆå ±å‘ŠåŠŸèƒ½å·²ç§»è‡³ PDF ç”Ÿæˆé€£çµ

// é‡æ–°çˆ¬å–
function retryCrawling() {
    if (confirm('ç¢ºå®šè¦é‡æ–°çˆ¬å–æ­¤æ¸¬é©—çµæœå—ï¼Ÿ')) {
        showLoading();
        
        fetch(`/enterprise/invitations/{{ result.test_invitation.id }}/crawl/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('é‡æ–°çˆ¬å–å·²é–‹å§‹', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast(`é‡æ–°çˆ¬å–å¤±æ•—ï¼š${data.error}`, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('é‡æ–°çˆ¬å–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'danger');
        });
    }
}
// ç«‹å³è¨»å†Šåˆ°å…¨åŸŸ
window.retryCrawling = retryCrawling;

// ç²å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Toast é€šçŸ¥
function showToast(message, type = 'info') {
    // å‰µå»º toast å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast_' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast show`;
    toast.setAttribute('role', 'alert');
    
    const bgColor = type === 'success' ? 'bg-success' : 
                   type === 'danger' ? 'bg-danger' : 
                   type === 'warning' ? 'bg-warning' : 'bg-info';
    
    toast.innerHTML = `
        <div class="toast-header ${bgColor} text-white">
            <strong class="me-auto">${type === 'success' ? 'âœ… æˆåŠŸ' : type === 'danger' ? 'âŒ éŒ¯èª¤' : type === 'warning' ? 'âš ï¸ è­¦å‘Š' : 'â„¹ï¸ æç¤º'}</strong>
            <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('${toastId}').remove()"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // è‡ªå‹•é—œé–‰
    setTimeout(() => {
        if (document.getElementById(toastId)) {
            document.getElementById(toastId).remove();
        }
    }, 8000);
    
    // æ·»åŠ åˆ°èª¿è©¦ä¿¡æ¯
    addDebugMessage('Toast é¡¯ç¤º: ' + message);
}

// èª¿è©¦ä¿¡æ¯ - ç„¡æ¢ä»¶è¼¸å‡º
console.log('=== Template Debug Info ===');
console.log('jQuery available:', typeof $ !== 'undefined');
console.log('Document ready state:', document.readyState);

// å®‰å…¨åœ°æ£€æŸ¥å’Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯
try {
    console.log('category_scores exists:', {% if category_scores %}true{% else %}false{% endif %});
    console.log('category_scores length:', {{ category_scores|length }});
    
    {% if category_scores %}
    console.log('category_scores:', {{ category_scores|safe }});
    console.log('category_labels:', {{ category_labels|safe }});
    console.log('category_values:', {{ category_values|safe }});
    console.log('category_scores keys:', Object.keys({{ category_scores|safe }}));
    console.log('category_scores values:', Object.values({{ category_scores|safe }}));
    {% else %}
    console.log('category_scores is empty or undefined');
    {% endif %}
} catch (error) {
    console.error('Error in template debug info:', error);
}

// å‹•æ…‹è¼‰å…¥ Chart.js ä¸¦å‰µå»ºé›·é”åœ–
{% if category_scores %}
console.log('Category scores condition met - starting chart initialization');

// ç¡®ä¿å®‰å…¨çš„æ•°æ®ä¼ é€’
var categoryLabels = {{ category_labels|safe }};
var categoryValues = {{ category_values|safe }};

console.log('Chart data variables:', categoryLabels, categoryValues);

function loadChartAndCreateRadar() {
    console.log('Loading Chart.js dynamically...');
    
    // æ£€æŸ¥Chart.jsæ˜¯å¦å·²ç»åŠ è½½
    if (typeof Chart !== 'undefined') {
        console.log('Chart.js already loaded');
        createRadarChart();
        return;
    }
    
    // å‹•æ…‹è¼‰å…¥ Chart.js
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        console.log('Chart.js loaded successfully, version:', Chart.version);
        createRadarChart();
    };
    script.onerror = function() {
        console.error('Failed to load Chart.js');
    };
    document.head.appendChild(script);
}

function createRadarChart() {
    console.log('Creating radar chart...');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    
    const categoryRadarChart = document.getElementById('categoryRadarChart');
    if (!categoryRadarChart) {
        console.error('categoryRadarChart canvas element not found');
        return;
    }
    
    console.log('Canvas element found');
    console.log('Using data:', categoryLabels, categoryValues);
    
    try {
        const chart = new Chart(categoryRadarChart, {
            type: 'radar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'åˆ†é¡èƒ½åŠ›è©•ä¼°',
                    data: categoryValues,
                    borderColor: '#4285f4',
                    backgroundColor: 'rgba(66, 133, 244, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#4285f4',
                    pointBorderColor: '#fff',
                    pointRadius: 4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.r.toFixed(1);
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            display: true,
                            backdropColor: 'rgba(255, 255, 255, 0.8)',
                            backdropPadding: 2,
                            callback: function(value, index, values) {
                                if (value === 20 || value === 40 || value === 60 || value === 80 || value === 100) {
                                    return value;
                                }
                                return '';
                            },
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: '#666'
                        },
                        pointLabels: {
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#333',
                            callback: function(label, index) {
                                const value = categoryValues[index];
                                return label + ' (' + value.toFixed(1) + ')';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        angleLines: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        });
        
        console.log('Radar chart created successfully:', chart);
    } catch (error) {
        console.error('Error creating radar chart:', error);
        console.error('Error details:', error.stack);
    }
}

// å¤šç§æ–¹å¼ç¡®ä¿å‡½æ•°æ‰§è¡Œ
function initializeChart() {
    console.log('Initializing chart...');
    loadChartAndCreateRadar();
}

// å½“é¡µé¢è½½å…¥å®Œæˆæ—¶å¯åŠ¨
if (typeof $ !== 'undefined') {
    $(document).ready(function() {
        console.log('jQuery ready, initializing chart');
        initializeChart();
    });
} else {
    // å¦‚æœæ²¡æœ‰jQueryï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing chart');
        initializeChart();
    });
}

// ä½œä¸ºå¤‡ç”¨ï¼Œå»¶è¿Ÿæ‰§è¡Œ
setTimeout(function() {
    console.log('Backup initialization after 1 second');
    initializeChart();
}, 1000);

{% else %}
console.log('No category_scores data - chart initialization skipped');
{% endif %}

// ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡å°è¯•
window.addEventListener('load', function() {
    console.log('Window loaded, final chart initialization attempt');
    {% if category_scores %}
    if (!document.querySelector('#categoryRadarChart canvas')) {
        console.log('Chart not found, retrying...');
        setTimeout(initializeChart, 500);
    }
    {% endif %}
});

// è‡ªå‹•é‡æ–°æ•´ç†ï¼ˆå¦‚æœæ­£åœ¨çˆ¬å–ä¸­ï¼‰
{% if result.crawl_status == 'crawling' %}
setInterval(function() {
    window.location.reload();
}, 30000); // 30ç§’é‡æ–°æ•´ç†ä¸€æ¬¡
{% endif %}

// ===== åˆå§‹åŒ–å’Œæ¸¬è©¦ =====
console.log('âœ… æ‰€æœ‰ PDF ç”Ÿæˆå‡½æ•¸å·²è¨»å†Šåˆ°å…¨å±€ç¯„åœ');
console.log('ğŸ” æ¸¬è©¦å‡½æ•¸å¯ç”¨æ€§:');
console.log('  - handlePdfGeneration:', typeof window.handlePdfGeneration);
console.log('  - addDebugMessage:', typeof window.addDebugMessage);
console.log('  - copyRawData:', typeof window.copyRawData);
console.log('  - retryCrawling:', typeof window.retryCrawling);

// DOM è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ– ===');
    // èª¿è©¦è¨Šæ¯å·²ç¦ç”¨
    console.log('é é¢ç¶²å€:', window.location.href);
    console.log('ç›®å‰æ™‚é–“:', new Date().toISOString());
    console.log('ç•«å¸ƒå…ƒç´ æ˜¯å¦å­˜åœ¨:', !!document.getElementById('categoryRadarChart'));
    console.log('è­¦å‘Šå…ƒç´ æ•¸é‡:', document.querySelectorAll('.alert').length);
});
</script>
{% endblock %}