{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.variable-help {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
}

.variable-tag {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 2px 6px;
    font-family: monospace;
    font-size: 12px;
    cursor: pointer;
    margin: 2px;
    display: inline-block;
}

.variable-tag:hover {
    background-color: #dee2e6;
}

.template-preview {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
}

.form-floating > .form-control {
    height: auto;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">å„€è¡¨æ¿</a></li>
<li class="breadcrumb-item"><a href="{% url 'enterprise_dashboard' %}">ä¼æ¥­æ¸¬é©—ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'invitation_template_list' %}">é‚€è«‹æ¨¡æ¿ç®¡ç†</a></li>
<li class="breadcrumb-item active">{{ action == 'create' and 'å»ºç«‹æ¨¡æ¿' or 'ç·¨è¼¯æ¨¡æ¿' }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-envelope-paper me-2"></i>{{ title }}</h2>
                <a href="{% url 'invitation_template_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                </a>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- æ¨¡æ¿è¡¨å–® -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">æ¨¡æ¿è³‡è¨Š</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="templateForm">
                                {% csrf_token %}
                                
                                <!-- åŸºæœ¬è³‡è¨Š -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label for="{{ form.name.id_for_label }}" class="form-label">
                                            æ¨¡æ¿åç¨± <span class="text-danger">*</span>
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.name.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.template_type.id_for_label }}" class="form-label">æ¨¡æ¿é¡å‹</label>
                                        {{ form.template_type }}
                                        {% if form.template_type.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.template_type.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- éƒµä»¶ä¸»æ—¨ -->
                                <div class="mb-3">
                                    <label for="{{ form.subject_template.id_for_label }}" class="form-label">
                                        éƒµä»¶ä¸»æ—¨æ¨¡æ¿ <span class="text-danger">*</span>
                                    </label>
                                    {{ form.subject_template }}
                                    <div class="form-text">{{ form.subject_template.help_text }}</div>
                                    {% if form.subject_template.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.subject_template.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- éƒµä»¶å…§å®¹ -->
                                <div class="mb-3">
                                    <label for="{{ form.message_template.id_for_label }}" class="form-label">
                                        éƒµä»¶å…§å®¹æ¨¡æ¿ <span class="text-danger">*</span>
                                    </label>
                                    {{ form.message_template }}
                                    <div class="form-text">{{ form.message_template.help_text }}</div>
                                    {% if form.message_template.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.message_template.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- é è¨­æ¨¡æ¿é¸é … -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.is_default }}
                                        <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                            è¨­ç‚ºé è¨­æ¨¡æ¿
                                        </label>
                                        <div class="form-text">é è¨­æ¨¡æ¿æœƒåœ¨å»ºç«‹æ–°é‚€è«‹æ™‚è‡ªå‹•é¸ç”¨</div>
                                    </div>
                                </div>

                                <!-- æ“ä½œæŒ‰éˆ• -->
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="window.history.back()">
                                        <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                                    </button>
                                    <button type="button" class="btn btn-outline-info me-2" onclick="previewTemplate()">
                                        <i class="bi bi-eye me-1"></i>é è¦½æ•ˆæœ
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i>{{ action == 'create' and 'å»ºç«‹æ¨¡æ¿' or 'æ›´æ–°æ¨¡æ¿' }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- è®Šæ•¸èªªæ˜ -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>å¯ç”¨è®Šæ•¸</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">é»æ“Šè®Šæ•¸å¯è‡ªå‹•æ’å…¥åˆ°æ¸¸æ¨™ä½ç½®</p>
                            
                            <div class="mb-3">
                                <strong class="small">åŸºæœ¬è®Šæ•¸ï¼š</strong><br>
                                <span class="variable-tag" onclick="insertVariable('{invitee_name}')">{invitee_name}</span>
                                <span class="variable-tag" onclick="insertVariable('{enterprise_name}')">{enterprise_name}</span>
                                <span class="variable-tag" onclick="insertVariable('{test_name}')">{test_name}</span>
                                <span class="variable-tag" onclick="insertVariable('{company_name}')">{company_name}</span>
                            </div>
                            
                            <div class="mb-3">
                                <strong class="small">æ¸¬é©—ç›¸é—œï¼š</strong><br>
                                <span class="variable-tag" onclick="insertVariable('{test_url}')">{test_url}</span>
                                <span class="variable-tag" onclick="insertVariable('{expires_date}')">{expires_date}</span>
                            </div>

                            <hr>
                            
                            <div class="small">
                                <strong>è®Šæ•¸èªªæ˜ï¼š</strong>
                                <ul class="list-unstyled mt-2">
                                    <li><code>{invitee_name}</code> - å—æ¸¬è€…å§“å</li>
                                    <li><code>{enterprise_name}</code> - ä¼æ¥­åç¨±</li>
                                    <li><code>{test_name}</code> - æ¸¬é©—åç¨±</li>
                                    <li><code>{company_name}</code> - å—æ¸¬è€…å…¬å¸</li>
                                    <li><code>{test_url}</code> - æ¸¬é©—é€£çµ</li>
                                    <li><code>{expires_date}</code> - éæœŸæ™‚é–“</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- é è¨­æ¨¡æ¿ç¯„ä¾‹ -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>æ¨¡æ¿ç¯„ä¾‹</h6>
                        </div>
                        <div class="card-body">
                            <div class="btn-group-vertical w-100">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('standard')">
                                    è¼‰å…¥æ¨™æº–æ¨¡æ¿
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('formal')">
                                    è¼‰å…¥æ­£å¼æ¨¡æ¿
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('casual')">
                                    è¼‰å…¥è¼•é¬†æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é è¦½æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¨¡æ¿é è¦½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">éƒµä»¶ä¸»æ—¨ï¼š</label>
                    <div class="border rounded p-2 bg-light" id="previewSubject"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">éƒµä»¶å…§å®¹ï¼š</label>
                    <div class="border rounded p-3 bg-light" id="previewMessage" style="white-space: pre-line;"></div>
                </div>
                <div class="alert alert-info">
                    <small><i class="bi bi-info-circle me-1"></i>æ­¤ç‚ºç¤ºç¯„æ•ˆæœï¼Œå¯¦éš›ç™¼é€æ™‚æœƒä½¿ç”¨çœŸå¯¦è³‡æ–™</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
// ç•¶å‰ç„¦é»çš„è¼¸å…¥æ¡†
let currentInput = null;

// ç›£è½è¼¸å…¥æ¡†ç„¦é»
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('#id_subject_template, #id_message_template');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            currentInput = this;
        });
    });
});

// æ’å…¥è®Šæ•¸
function insertVariable(variable) {
    if (currentInput) {
        const cursorPos = currentInput.selectionStart;
        const textBefore = currentInput.value.substring(0, cursorPos);
        const textAfter = currentInput.value.substring(currentInput.selectionEnd);
        
        currentInput.value = textBefore + variable + textAfter;
        
        // è¨­ç½®æ¸¸æ¨™ä½ç½®
        const newPos = cursorPos + variable.length;
        currentInput.setSelectionRange(newPos, newPos);
        currentInput.focus();
    } else {
        alert('è«‹å…ˆé»æ“Šè¦æ’å…¥è®Šæ•¸çš„è¼¸å…¥æ¡†');
    }
}

// è¼‰å…¥æ¨¡æ¿ç¯„ä¾‹
function loadTemplate(type) {
    const templates = {
        standard: {
            subject: 'ã€{enterprise_name}ã€‘æ¸¬é©—é‚€è«‹ - {test_name}',
            message: `è¦ªæ„›çš„ {invitee_name} æ‚¨å¥½ï¼š

{enterprise_name} é‚€è«‹æ‚¨åƒèˆ‡ {test_name} æ¸¬é©—ã€‚

æ­¤æ¸¬é©—å°‡å”åŠ©æˆ‘å€‘æ›´äº†è§£æ‚¨çš„ç‰¹è³ªèˆ‡èƒ½åŠ›ï¼Œè«‹æ–¼ {expires_date} å‰å®Œæˆæ¸¬é©—ã€‚

æ¸¬é©—é€£çµï¼š{test_url}

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹éš¨æ™‚èˆ‡æˆ‘å€‘è¯çµ¡ã€‚

ç¥æ‚¨é †å¿ƒ
{enterprise_name} æ•¬ä¸Š`
        },
        formal: {
            subject: '{enterprise_name} - {test_name} äººæ‰è©•ä¼°é‚€è«‹',
            message: `å°Šæ•¬çš„ {invitee_name}ï¼š

æ„Ÿè¬æ‚¨å° {enterprise_name} çš„é—œæ³¨ã€‚

ç‚ºäº†æ›´å¥½åœ°äº†è§£æ‚¨çš„å°ˆæ¥­èƒ½åŠ›èˆ‡å€‹äººç‰¹è³ªï¼Œæˆ‘å€‘èª æ‘¯é‚€è«‹æ‚¨åƒèˆ‡ {test_name} è©•ä¼°ã€‚

è©•ä¼°è³‡è¨Šï¼š
â€¢ æ¸¬é©—åç¨±ï¼š{test_name}
â€¢ æˆªæ­¢æ™‚é–“ï¼š{expires_date}
â€¢ è©•ä¼°é€£çµï¼š{test_url}

æ­¤è©•ä¼°çµæœå°‡ä½œç‚ºæˆ‘å€‘äººæ‰é¸æ‹”çš„é‡è¦åƒè€ƒä¾æ“šï¼Œè«‹æ‚¨å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆã€‚

å¦‚æœ‰ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚è¯ç¹«æˆ‘å€‘ã€‚

æ­¤è‡´
æ•¬ç¦®

{enterprise_name}
äººåŠ›è³‡æºéƒ¨`
        },
        casual: {
            subject: 'ä¾†å®Œæˆä¸€å€‹æœ‰è¶£çš„æ¸¬é©—å§ï¼- {test_name}',
            message: `Hi {invitee_name}ï¼

{enterprise_name} é€™é‚Šæœ‰å€‹æœ‰è¶£çš„æ¸¬é©—æƒ³é‚€è«‹ä½ åƒèˆ‡ ğŸ˜Š

æ¸¬é©—åç¨±ï¼š{test_name}
èŠ±è²»æ™‚é–“ï¼šå¤§ç´„10-15åˆ†é˜
å®ŒæˆæœŸé™ï¼š{expires_date}

é»é€™è£¡é–‹å§‹ï¼š{test_url}

é€™å€‹æ¸¬é©—æœƒå¹«åŠ©æˆ‘å€‘æ›´äº†è§£ä½ çš„ç‰¹è³ªå’Œå„ªå‹¢ï¼Œåˆ¥æ“”å¿ƒï¼Œæ²’æœ‰æ¨™æº–ç­”æ¡ˆï¼Œèª å¯¦å›ç­”å°±å¥½ï¼

æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥è¯çµ¡æˆ‘å€‘å“¦ï½

{enterprise_name} åœ˜éšŠ`
        }
    };
    
    if (templates[type]) {
        if (confirm('è¼‰å…¥æ¨¡æ¿ç¯„ä¾‹æœƒè¦†è“‹ç•¶å‰å…§å®¹ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
            document.getElementById('id_subject_template').value = templates[type].subject;
            document.getElementById('id_message_template').value = templates[type].message;
        }
    }
}

// é è¦½æ¨¡æ¿
function previewTemplate() {
    const subject = document.getElementById('id_subject_template').value;
    const message = document.getElementById('id_message_template').value;
    
    if (!subject || !message) {
        alert('è«‹å…ˆå¡«å¯«ä¸»æ—¨å’Œå…§å®¹æ¨¡æ¿');
        return;
    }
    
    // ç¤ºç¯„æ•¸æ“š
    const sampleData = {
        invitee_name: 'å¼µä¸‰',
        enterprise_name: 'æ‚¨çš„ä¼æ¥­åç¨±',
        test_name: 'PIäººæ ¼ç‰¹è³ªæ¸¬é©—',
        company_name: 'ç§‘æŠ€å…¬å¸',
        test_url: 'https://example.com/test/abc123',
        expires_date: '2025å¹´01æœˆ15æ—¥'
    };
    
    // æ›¿æ›è®Šæ•¸
    let previewSubject = subject;
    let previewMessage = message;
    
    Object.keys(sampleData).forEach(key => {
        const regex = new RegExp(`{${key}}`, 'g');
        previewSubject = previewSubject.replace(regex, sampleData[key]);
        previewMessage = previewMessage.replace(regex, sampleData[key]);
    });
    
    document.getElementById('previewSubject').textContent = previewSubject;
    document.getElementById('previewMessage').textContent = previewMessage;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}
</script>
{% endblock %}