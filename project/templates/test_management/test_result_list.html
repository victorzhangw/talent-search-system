{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load tz %}
{% csrf_token %}

{% block title %}æ¸¬é©—çµæœç®¡ç† - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é </a></li>
<!-- {% if user.user_type == 'admin' %}
<li class="breadcrumb-item"><a href="{% url 'test_result_dashboard' %}">æ¸¬é©—çµæœå„€è¡¨æ¿</a></li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'enterprise_dashboard' %}">ä¼æ¥­æ¸¬é©—ç®¡ç†</a></li>
{% endif %} -->
<li class="breadcrumb-item active">è©•é‘‘çµæœåˆ—è¡¨</li>
{% endblock %}

{% block extra_css %}
<style>
.status-badge {
    font-size: 0.875em;
    font-weight: 500;
}

.crawl-status-badge {
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
}

.action-buttons .btn {
    margin-right: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- éš±è—çš„ CSRF Token -->
    <form style="display: none;">
        {% csrf_token %}
    </form>
    {% if project_overview %}
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h2><i class="bi bi-graph-up me-2"></i>{{ project_overview.project.name }} - æ¸¬é©—çµ±1111è¨ˆ</h2>
            <p class="text-muted mb-0">{{ project_overview.project.description|default:"æš«ç„¡æè¿°" }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'test_templates' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>è¿”å›æ¸¬é©—é …ç›®
            </a>
            <a href="{% url 'quick_invitation' project_overview.project.id %}" class="btn btn-primary">
                <i class="bi bi-envelope-plus me-1"></i>ç™¼é€é‚€è«‹
            </a>
        </div>
    </div>

    <div class="row mb-4 g-3">
        {% with stats=project_overview.invitation_stats %}
        <div class="col-6 col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.total }}</h4>
                    <small>ç¸½é‚€è«‹</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.pending }}</h4>
                    <small>å¾…å®Œæˆ</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.in_progress }}</h4>
                    <small>é€²è¡Œä¸­</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.completed }}</h4>
                    <small>å·²å®Œæˆ</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.expired }}</h4>
                    <small>å·²éæœŸ</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ stats.cancelled }}</h4>
                    <small>å·²å–æ¶ˆ</small>
                </div>
            </div>
        </div>
        {% endwith %}
    </div>
    {% else %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-clipboard-data me-2"></i>è©•é‘‘çµæœåˆ—è¡¨
        </h2>
        {% if user.user_type == 'admin' %}
        <div>
            <a href="{% url 'test_result_dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-graph-up me-1"></i>è¿”å›å„€è¡¨æ¿
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- æœå°‹å’Œéæ¿¾ -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">æœå°‹å—æ¸¬äººå“¡</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="è¼¸å…¥å§“åæˆ– Email" value="{{ search }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">è©•é‘‘åˆ¥</label>
                    {% if lock_project_filter %}
                        <input type="hidden" name="project" value="{{ project_filter }}">
                    {% endif %}
                    <select name="project" class="form-select" {% if lock_project_filter %}disabled{% endif %}>
                        <option value="">å…¨éƒ¨é …ç›®</option>
                        {% for project in project_choices %}
                            <option value="{{ project.id }}" {% if project_filter == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
                        {% endfor %}
                    </select>
                    {% if lock_project_filter and project_overview %}
                        <small class="text-muted">ç›®å‰åƒ…é¡¯ç¤ºã€Œ{{ project_overview.project.name }}ã€çš„çµæœ</small>
                    {% endif %}
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">å—æ¸¬èº«ä»½</label>
                    <select name="identity" class="form-select">
                        <option value="">å…¨éƒ¨èº«ä»½</option>
                        {% for value, label in identity_choices %}
                            <option value="{{ value }}" {% if identity_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">è·ä½</label>
                    <select name="position" class="form-select">
                        <option value="">å…¨éƒ¨è·ä½</option>
                        {% for pos in position_choices %}
                            <option value="{{ pos }}" {% if position_filter == pos %}selected{% endif %}>{{ pos }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">æ¸¬é©—ç‹€æ…‹</label>
                    <select name="status" class="form-select">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">çµæœç‹€æ…‹</label>
                    <select name="crawl_status" class="form-select">
                        <option value="">å…¨éƒ¨çµæœ</option>
                        {% for value, label in crawl_status_choices %}
                            <option value="{{ value }}" {% if crawl_status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">æ’åºæ–¹å¼</label>
                    <select name="order" class="form-select">
                        {% for value, label in order_choices %}
                            <option value="{{ value }}" {% if order_option == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 align-self-end">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>æœå°‹
                        </button>
                        <a href="{% url 'test_result_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i>é‡ç½®
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- çµæœåˆ—è¡¨ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                è©•é‘‘çµæœåˆ—è¡¨
                <small class="text-muted">ï¼ˆå…± {{ page_obj.paginator.count }} ç­†ï¼‰</small>
            </h5>
        <div class="ms-auto">
            <a href="{% url 'export_filtered_test_results' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-outline-success">
                <i class="bi bi-download me-1"></i> åŒ¯å‡ºçµæœ
            </a>
        </div>
            <!-- å…¨é¸åŠŸèƒ½å·²éš±è— -->
        </div>
        <div class="card-body p-0">
            {% if page_obj.object_list %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>è©•é‘‘åˆ¥</th>
                                <th>å—è©¦è€…</th>
                                <th>èº«ä»½åˆ¥</th>
                                <th>è·ä½</th>
                                <th>å®Œæˆæ™‚é–“</th>
                                <th>åˆ†æ•¸</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invitation in page_obj.object_list %}
                            <tr>
                                <!-- é¸å–è¤‡é¸æ¡†å·²éš±è— -->
                                <td>
                                    <div>
                                        <strong>{{ invitation.test_project.name }}</strong>
                                        {% if invitation.test_project.category %}
                                        <div class="small text-muted">{{ invitation.test_project.category.name }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ invitation.invitee.name }}</strong>
                                        <div class="small text-muted">{{ invitation.invitee.email }}</div>
                                    </div>
                                </td>
                                <td>
                                    {{ invitation.invitee.get_status_display }}
                                </td>
                                <td>
                                    {{ invitation.invitee.position|default:"-" }}
                                </td>
                                <td>
                                    {% if invitation.effective_completed_at %}
                                        {{ invitation.effective_completed_at|localtime|date:"Y-m-d H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% with result=invitation.testprojectresult %}
                                        {% if result and result.crawl_status == 'completed' %}
                                            {% with score_value_direct=result.raw_data|get_item:invitation.test_project.score_field_system %}
                                            {% with score_value_performance=result.raw_data.performance_metrics|get_item:invitation.test_project.score_field_system %}
                                            {% with prediction_value_direct=result.raw_data|get_item:invitation.test_project.prediction_field_system %}
                                            {% with prediction_value_performance=result.raw_data.performance_metrics|get_item:invitation.test_project.prediction_field_system %}
                                            {% with ci_raw_value=result.raw_data.performance_metrics.CI_Raw_Value %}
                                            {% with ci_value=ci_raw_value|default:score_value_performance|default:score_value_direct %}
                                            {% with prediction_value=prediction_value_performance|default:prediction_value_direct %}
                                                <div class="small">
                                                    {% if ci_value %}
                                                        <div>CI åˆ†æ•¸ï¼š{{ ci_value|cut:"%" }}</div>
                                                    {% endif %}
                                                    {% if prediction_value %}
                                                        <div>é æ¸¬å€¼åˆ†æ•¸ï¼š{{ prediction_value }}</div>
                                                    {% endif %}
                                                    {% if not ci_value and not prediction_value %}
                                                        <span class="text-muted">æš«ç„¡æ•¸æ“š</span>
                                                    {% endif %}
                                                </div>
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted small">æš«ç„¡æ•¸æ“š</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        {% with result=invitation.testprojectresult %}
                                        {% if result %}
                                            {% if result.crawl_status == 'completed' %}
                                                {% if user.user_type == 'admin' %}
                                                    {% url 'admin_test_result_detail' result.id as detail_url %}
                                                    {% url 'admin_generate_test_result_pdf' result.id as pdf_url %}
                                                {% else %}
                                                    {% url 'test_result_detail' result.id as detail_url %}
                                                    {% url 'generate_test_result_pdf' result.id as pdf_url %}
                                                {% endif %}
                                                <a href="{{ detail_url }}" class="btn btn-success btn-sm" title="æŸ¥çœ‹è©³ç´°çµæœ">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{{ pdf_url }}" class="btn btn-outline-info btn-sm" title="ä¸‹è¼‰PDFå ±å‘Š" target="_blank" rel="noopener">
                                                    <i class="bi bi-file-earmark-pdf"></i>
                                                </a>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šé‡æ–°çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶é‡æ–°çˆ¬å–">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% elif result.crawl_status == 'failed' %}
                                                <button type="button" class="btn btn-warning btn-sm" 
                                                        onclick="startCrawling({{ invitation.id }})" title="é‡æ–°è™•ç†">
                                                    <i class="bi bi-arrow-clockwise"></i>
                                                </button>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶é‡æ–°çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶é‡æ–°çˆ¬å–">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% elif result.crawl_status == 'crawling' %}
                                                <span class="text-info small">
                                                    <i class="bi bi-hourglass-split me-1"></i>ç³»çµ±è™•ç†ä¸­...
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            {% if invitation.status == 'completed' %}
                                                <button type="button" class="btn btn-primary btn-sm" 
                                                        onclick="startCrawling({{ invitation.id }})" title="å–å¾—æ¸¬é©—çµæœ">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>å–å¾—çµæœ
                                                </button>
                                            {% elif invitation.status == 'in_progress' %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                                        title="æ¸¬é©—é€²è¡Œä¸­ï¼Œè«‹ç­‰å¾…å®Œæˆ">
                                                    <i class="bi bi-hourglass-split me-1"></i>æ¸¬é©—ä¸­
                                                </button>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶çˆ¬å–ï¼ˆå¿½ç•¥æ¸¬é©—ç‹€æ…‹ï¼‰">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% elif invitation.status == 'pending' %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                                        title="å—æ¸¬è€…å°šæœªé–‹å§‹æ¸¬é©—">
                                                    <i class="bi bi-clock me-1"></i>å¾…é–‹å§‹
                                                </button>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶çˆ¬å–ï¼ˆå¿½ç•¥æ¸¬é©—ç‹€æ…‹ï¼‰">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% elif invitation.status == 'expired' %}
                                                <span class="text-muted small">
                                                    <i class="bi bi-calendar2-x me-1"></i>å·²éæœŸ
                                                </span>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶çˆ¬å–ï¼ˆå¿½ç•¥æ¸¬é©—ç‹€æ…‹ï¼‰">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% elif invitation.status == 'cancelled' %}
                                                <span class="text-muted small">
                                                    <i class="bi bi-x-circle me-1"></i>å·²å–æ¶ˆ
                                                </span>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶çˆ¬å–ï¼ˆå¿½ç•¥æ¸¬é©—ç‹€æ…‹ï¼‰">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% else %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                                        title="ç‹€æ…‹æœªçŸ¥">
                                                    <i class="bi bi-question-circle me-1"></i>æœªçŸ¥ç‹€æ…‹
                                                </button>
                                                {% if user.user_type == 'admin' %}
                                                <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šå¼·åˆ¶çˆ¬å–æŒ‰éˆ• -->
                                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                                        onclick="forceRecrawl({{ invitation.id }})" title="ç®¡ç†å“¡ï¼šå¼·åˆ¶çˆ¬å–ï¼ˆå¿½ç•¥æ¸¬é©—ç‹€æ…‹ï¼‰">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é æ§åˆ¶ -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="åˆ†é å°èˆª" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}" aria-label="ç¬¬ä¸€é ">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}" aria-label="ä¸Šä¸€é ">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}" aria-label="ä¸‹ä¸€é ">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}" aria-label="æœ€å¾Œä¸€é ">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                    
                    <!-- åˆ†é è³‡è¨Š -->
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            ç¬¬ {{ page_obj.number }} é ï¼Œå…± {{ page_obj.paginator.num_pages }} é 
                            ï¼ˆç¬¬ {{ page_obj.start_index }}-{{ page_obj.end_index }} ç­†ï¼Œç¸½å…± {{ page_obj.paginator.count }} ç­†ï¼‰
                        </small>
                    </div>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h5 class="mt-3 text-muted">æ²’æœ‰æ‰¾åˆ°æ¸¬é©—çµæœ</h5>
                    <p class="text-muted">å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–å»ºç«‹æ–°çš„æ¸¬é©—é‚€è«‹</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ‰¹é‡è™•ç†ç¢ºèªå°è©±æ¡†å·²éš±è— -->

<!-- é€²åº¦æç¤º Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">è™•ç†ä¸­...</span>
                </div>
                <h6 id="progressText">æ­£åœ¨è™•ç†æ¸¬é©—çµæœ...</h6>
                <p class="text-muted" id="progressDetail">è«‹ç¨å¾Œï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast å®¹å™¨ -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- æ ¸å¿ƒ JavaScript -->
<script type="text/javascript">

// ===== å…¨åŸŸè®Šæ•¸ =====
let selectedInvitations = [];

// ===== ä¸»è¦å‡½æ•¸ï¼šé–‹å§‹å–®å€‹è™•ç† =====
function startCrawling(invitationId) {
    console.log('ğŸ¯ startCrawling è¢«èª¿ç”¨ï¼Œé‚€è«‹ ID:', invitationId);
    
    if (!confirm('ç¢ºå®šè¦é–‹å§‹è™•ç†é€™å€‹æ¸¬é©—çµæœå—ï¼Ÿæ­¤éç¨‹å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚')) {
        return;
    }
    
    // é¡¯ç¤ºé€²åº¦ Modal
    showProgressModal('æ­£åœ¨è™•ç†æ¸¬é©—çµæœ...', 'è«‹ç¨å¾Œï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“');
    
    // ç²å– CSRF token - æ”¹é€²ç‰ˆæœ¬
    let csrfToken = getCookie('csrftoken');
    
    // å¦‚æœç„¡æ³•å¾ cookie ç²å–ï¼Œå˜—è©¦å¾è¡¨å–®ç²å–
    if (!csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
    }
    
    // æª¢æŸ¥ token æ˜¯å¦æœ‰æ•ˆï¼ˆé•·åº¦æª¢æŸ¥ï¼‰
    if (!csrfToken || csrfToken.length < 32) {
        showToast('âŒ ç„¡æ³•ç²å–æœ‰æ•ˆçš„å®‰å…¨ä»¤ç‰Œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦', 'danger');
        console.error('Invalid CSRF token:', csrfToken);
        hideProgressModal();
        return;
    }
    
    console.log('ğŸ” CSRF Token ç²å–æˆåŠŸï¼Œé•·åº¦:', csrfToken.length);
    
    // ç™¼é€ AJAX è«‹æ±‚
    fetch(`/enterprise/invitations/${invitationId}/crawl/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',  // ç¢ºä¿ç™¼é€ cookies
    })
    .then(response => {
        console.log('æ”¶åˆ°éŸ¿æ‡‰ï¼Œç‹€æ…‹ï¼š', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“Š è™•ç†çµæœï¼š', data);
        
        // é—œé–‰é€²åº¦ Modal
        hideProgressModal();
        
        if (data.success) {
            showToast('æ¸¬é©—çµæœè™•ç†å®Œæˆï¼', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // è™•ç†åŒ…å«æ›è¡Œç¬¦çš„éŒ¯èª¤è¨Šæ¯
            const errorMessage = data.error || 'æœªçŸ¥éŒ¯èª¤';
            showToast(`è™•ç†å¤±æ•—ï¼š${errorMessage}`, 'danger', 8000);  // å»¶é•·é¡¯ç¤ºæ™‚é–“
        }
    })
    .catch(error => {
        console.error('è™•ç†éŒ¯èª¤ï¼š', error);
        hideProgressModal();
        
        if (error.message.includes('403')) {
            showToast('âŒ æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦', 'danger');
        } else if (error.message.includes('401')) {
            showToast('âŒ ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥', 'danger');
        } else {
            showToast('âŒ è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦', 'danger');
        }
    });
}

// ===== ç®¡ç†å“¡å¼·åˆ¶é‡æ–°çˆ¬å–å‡½æ•¸ =====
function forceRecrawl(invitationId) {
    console.log('ğŸ”§ forceRecrawl è¢«èª¿ç”¨ï¼Œé‚€è«‹ ID:', invitationId);
    
    if (!confirm('âš ï¸ ç®¡ç†å“¡æ“ä½œï¼šç¢ºå®šè¦å¼·åˆ¶é‡æ–°çˆ¬å–é€™å€‹æ¸¬é©—çµæœå—ï¼Ÿ\n\næ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰æ•¸æ“šï¼Œå»ºè­°åƒ…åœ¨éœ€è¦ä¿®å¾©æ•¸æ“šæ™‚ä½¿ç”¨ã€‚')) {
        return;
    }
    
    // ç²å– CSRF token - æ”¹é€²ç‰ˆæœ¬
    let csrfToken = getCookie('csrftoken');
    
    // å¦‚æœç„¡æ³•å¾ cookie ç²å–ï¼Œå˜—è©¦å¾è¡¨å–®ç²å–
    if (!csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
    }
    
    // æª¢æŸ¥ token æ˜¯å¦æœ‰æ•ˆï¼ˆé•·åº¦æª¢æŸ¥ï¼‰
    if (!csrfToken || csrfToken.length < 32) {
        showToast('âŒ ç„¡æ³•ç²å–æœ‰æ•ˆçš„å®‰å…¨ä»¤ç‰Œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦', 'danger');
        console.error('Invalid CSRF token:', csrfToken);
        return;
    }
    
    console.log('ğŸ” CSRF Token ç²å–æˆåŠŸï¼Œé•·åº¦:', csrfToken.length);
    
    // é¡¯ç¤ºé€²åº¦ Modal
    showProgressModal('æ­£åœ¨åŸ·è¡Œå¼·åˆ¶é‡æ–°çˆ¬å–...', 'ç®¡ç†å“¡æ“ä½œé€²è¡Œä¸­ï¼Œè«‹ç¨å¾Œ...');
    
    // ç™¼é€å¼·åˆ¶é‡æ–°çˆ¬å–è«‹æ±‚
    fetch(`/management/invitations/${invitationId}/force-recrawl/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',  // ç¢ºä¿ç™¼é€ cookies
    })
    .then(response => {
        console.log('æ”¶åˆ°å¼·åˆ¶é‡æ–°çˆ¬å–éŸ¿æ‡‰ï¼Œç‹€æ…‹ï¼š', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“Š å¼·åˆ¶é‡æ–°çˆ¬å–çµæœï¼š', data);
        
        // é—œé–‰é€²åº¦ Modal
        hideProgressModal();
        
        if (data.success) {
            showToast('âœ… å¼·åˆ¶é‡æ–°çˆ¬å–ä»»å‹™å·²å•Ÿå‹•ï¼ç³»çµ±å°‡é‡æ–°è™•ç†è©²æ¸¬é©—çµæœã€‚', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast(`âŒ å¼·åˆ¶é‡æ–°çˆ¬å–å¤±æ•—ï¼š${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'danger');
        }
    })
    .catch(error => {
        console.error('å¼·åˆ¶é‡æ–°çˆ¬å–éŒ¯èª¤ï¼š', error);
        hideProgressModal();
        
        if (error.message.includes('403')) {
            showToast('âŒ æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹ç¢ºèªæ‚¨æ˜¯ç®¡ç†å“¡èº«ä»½', 'danger');
        } else if (error.message.includes('401')) {
            showToast('âŒ è«‹å…ˆç™»å…¥å¾Œå†æ“ä½œ', 'danger');
        } else {
            showToast('âŒ å¼·åˆ¶é‡æ–°çˆ¬å–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹å¾Œé‡è©¦', 'danger');
        }
    });
}

// ===== é¡¯ç¤ºæ‰¹é‡è™•ç† Modal =====
function showBulkCrawlModal() {
    const checkedBoxes = document.querySelectorAll('.invitation-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        showToast('è«‹å…ˆé¸æ“‡è¦è™•ç†çš„æ¸¬é©—é‚€è«‹', 'warning');
        return;
    }
    
    updateSelectedCount();
    const bulkCrawlModal = new bootstrap.Modal(document.getElementById('bulkCrawlModal'));
    bulkCrawlModal.show();
}

// ===== åŸ·è¡Œæ‰¹é‡è™•ç† =====
function executeBulkCrawl() {
    if (selectedInvitations.length === 0) {
        showToast('æ²’æœ‰é¸æ“‡è¦è™•ç†çš„é …ç›®', 'warning');
        return;
    }
    
    // é—œé–‰ç¢ºèª Modal
    const bulkCrawlModal = bootstrap.Modal.getInstance(document.getElementById('bulkCrawlModal'));
    bulkCrawlModal.hide();
    
    // é¡¯ç¤ºé€²åº¦ Modal
    showProgressModal('æ­£åœ¨æ‰¹é‡è™•ç†æ¸¬é©—çµæœ...', `è™•ç† ${selectedInvitations.length} å€‹é …ç›®ï¼Œè«‹ç¨å¾Œ...`);
    
    // ç²å– CSRF token
    let csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
    }
    
    if (!csrfToken || csrfToken.length < 32) {
        showToast('âŒ ç„¡æ³•ç²å–æœ‰æ•ˆçš„å®‰å…¨ä»¤ç‰Œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦', 'danger');
        hideProgressModal();
        return;
    }
    
    // ç™¼é€æ‰¹é‡è™•ç†è«‹æ±‚
    fetch('/enterprise/test-results/bulk-crawl/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            invitation_ids: selectedInvitations
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgressModal();
        
        if (data.success) {
            showToast(`æ‰¹é‡è™•ç†å·²é–‹å§‹ï¼ŒæˆåŠŸè™•ç† ${data.processed_count} å€‹é …ç›®`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast(`æ‰¹é‡è™•ç†å¤±æ•—ï¼š${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'danger');
        }
    })
    .catch(error => {
        console.error('æ‰¹é‡è™•ç†éŒ¯èª¤ï¼š', error);
        hideProgressModal();
        showToast('æ‰¹é‡è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'danger');
    });
}

// ===== å…¨é¸åŠŸèƒ½ =====
function initializeSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const invitationCheckboxes = document.querySelectorAll('.invitation-checkbox');
    
    // ç¶å®šé ­éƒ¨å…¨é¸
    if (selectAllHeader) {
        selectAllHeader.addEventListener('change', function() {
            invitationCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = this.checked;
            updateSelectedCount();
        });
    }
    
    // ç¶å®šå´é‚Šå…¨é¸
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            invitationCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            if (selectAllHeader) selectAllHeader.checked = this.checked;
            updateSelectedCount();
        });
    }
    
    // ç¶å®šå€‹åˆ¥è¤‡é¸æ¡†
    invitationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            
            const checkedCount = document.querySelectorAll('.invitation-checkbox:checked').length;
            const totalCount = invitationCheckboxes.length;
            
            const isAllChecked = checkedCount === totalCount && totalCount > 0;
            const isPartialChecked = checkedCount > 0 && checkedCount < totalCount;
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = isAllChecked;
                selectAllCheckbox.indeterminate = isPartialChecked;
            }
            
            if (selectAllHeader) {
                selectAllHeader.checked = isAllChecked;
                selectAllHeader.indeterminate = isPartialChecked;
            }
        });
    });
}

// ===== æ›´æ–°é¸ä¸­è¨ˆæ•¸ =====
function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.invitation-checkbox:checked');
    selectedInvitations = Array.from(checkedBoxes).map(checkbox => checkbox.value);
    
    const countElement = document.getElementById('selectedCountModal');
    if (countElement) {
        countElement.textContent = selectedInvitations.length;
    }
}

// ===== é¡¯ç¤ºé€²åº¦ Modal =====
function showProgressModal(title, detail) {
    console.log('ğŸ”„ é¡¯ç¤ºé€²åº¦ Modalï¼š', title);
    
    const progressModal = document.getElementById('progressModal');
    const progressText = document.getElementById('progressText');
    const progressDetail = document.getElementById('progressDetail');
    
    if (progressText) progressText.textContent = title;
    if (progressDetail) progressDetail.textContent = detail;
    
    const modal = new bootstrap.Modal(progressModal);
    modal.show();
}

// ===== éš±è—é€²åº¦ Modal =====
function hideProgressModal() {
    
    const progressModal = document.getElementById('progressModal');
    const modal = bootstrap.Modal.getInstance(progressModal);
    
    if (modal) {
        modal.hide();
        
        // å»¶é²æª¢æŸ¥æ˜¯å¦çœŸçš„é—œé–‰äº†
        setTimeout(() => {
            const isVisible = progressModal.classList.contains('show');
            console.log('Modal æ˜¯å¦é‚„é¡¯ç¤º:', isVisible);
            
            if (isVisible) {
                console.log('âŒ Modal ä»ç„¶é¡¯ç¤ºï¼ŒåŸ·è¡Œå¼·åˆ¶é—œé–‰');
                // å¼·åˆ¶é—œé–‰
                progressModal.classList.remove('show', 'fade');
                progressModal.style.display = 'none';
                
                // ç§»é™¤èƒŒæ™¯
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // æ¢å¾© body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                console.log('ğŸ’ª å¼·åˆ¶é—œé–‰å®Œæˆ');
            }
        }, 500);
    } else {
        console.log('âŒ æ²’æœ‰æ‰¾åˆ° Modal å¯¦ä¾‹');
    }
}

// ===== é¡¯ç¤º Toast é€šçŸ¥ =====
function showToast(message, type = 'info', duration) {
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    
    const toastId = 'toast_' + Date.now();
    const bgClass = `bg-${type}`;
    const iconClass = type === 'success' ? 'check-circle' : 
                     type === 'danger' ? 'exclamation-triangle' : 
                     type === 'warning' ? 'exclamation-circle' : 'info-circle';
    
    // è™•ç†æ›è¡Œç¬¦ï¼Œå°‡ \n è½‰æ›ç‚º <br>
    const formattedMessage = message.replace(/\n/g, '<br>');
    
    const toastHTML = `
        <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" style="max-width: 500px;">
            <div class="toast-header ${bgClass} text-white border-0">
                <i class="bi bi-${iconClass} me-2"></i>
                <strong class="me-auto">ç³»çµ±é€šçŸ¥</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${formattedMessage}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: duration || (type === 'success' ? 3000 : (type === 'danger' ? 8000 : 5000))
    });
    
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// ===== ç²å– CSRF Token =====
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ===== DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–åŠŸèƒ½...');
    
    // åˆå§‹åŒ–å…¨é¸åŠŸèƒ½
    initializeSelectAll();
    
    // æ›´æ–°é¸ä¸­è¨ˆæ•¸
    updateSelectedCount();
    
    console.log('æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    console.log('startCrawling å‡½æ•¸ç‹€æ…‹:', typeof startCrawling);
});

console.log('ğŸš€ æ¸¬é©—çµæœç®¡ç†ç³»çµ± JavaScript è¼‰å…¥å®Œæˆ');
</script>
{% endblock %}

{% block extra_js %}
<script>
console.log('extra_js block è¼‰å…¥å®Œæˆ');
</script>
{% endblock %}
