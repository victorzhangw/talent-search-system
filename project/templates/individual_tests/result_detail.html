{# templates/individual_tests/result_detail.html #}
{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}測驗結果 - {{ test_project.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">首頁</a></li>
<li class="breadcrumb-item"><a href="{% url 'individual_tests' %}">我的測驗</a></li>
<li class="breadcrumb-item"><a href="{% url 'individual_test_results_list' %}">我的結果</a></li>
<li class="breadcrumb-item active">測驗結果詳情</li>
{% endblock %}

{% block extra_css %}
<style>
    /* 整體頁面樣式 */
    .result-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    /* Header 區域樣式 */
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 3rem 2rem;
        margin-bottom: 3rem;
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .result-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: rotate(45deg);
    }
    
    .result-header::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 150px;
        height: 150px;
        background: rgba(255,255,255,0.05);
        border-radius: 50%;
    }
    
    .score-circle {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        font-weight: bold;
        margin: 0 auto;
        position: relative;
        z-index: 2;
        border: 3px solid rgba(255,255,255,0.3);
    }
    
    /* 主要內容區域 */
    .content-section {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        position: relative;
        transition: all 0.3s ease;
    }
    
    .content-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
    
    /* 角色信息區域 */
    .role-section {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-left: 5px solid #28a745;
    }
    
    .role-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
        padding: 5px;
        height: 100%;
    }
    
    .role-image {
        width: calc(100% - 10px);
        height: calc(100% - 10px);
        max-width: 200px;
        max-height: 200px;
        border-radius: 50%;
        object-fit: cover;
        border: none;
        box-shadow: none;
    }
    
    .role-image-placeholder {
        width: calc(100% - 10px);
        height: calc(100% - 10px);
        max-width: 200px;
        max-height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        box-shadow: none;
    }
    
    .role-image-placeholder i {
        font-size: 3rem;
        color: #28a745;
    }
    
    .role-title {
        font-size: 1.5rem;
        color: #28a745;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .role-title i {
        margin-right: 0.5rem;
        font-size: 1.3rem;
    }
    
    /* 標籤區域 */
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        margin: 1.5rem 0;
    }
    
    .tag-item {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-weight: 500;
        font-size: 0.85rem;
        box-shadow: 0 3px 10px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
    }
    
    .tag-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
    }
    
    /* 分數顯示區域 */
    .score-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-left: 5px solid #ffc107;
        text-align: center;
    }
    
    .score-display {
        margin: 1rem 0;
    }
    
    .score-number {
        font-size: 2rem;
        font-weight: 800;
        color: #ff6b35;
        display: block;
        line-height: 1;
    }
    
    .score-unit {
        font-size: 1rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }
    
    .score-category {
        font-size: 1rem;
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    /* 雷達圖區域 */
    .radar-section {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 5px solid #2196f3;
        min-height: 500px;
    }
    
    .radar-chart-container {
        position: relative;
        width: 100%;
        height: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 15px;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        margin-top: 1.5rem;
    }
    
    #radarChart {
        max-width: 100%;
        max-height: 100%;
    }
    
    /* 建議區域樣式 */
    .advice-section {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border-left: 5px solid #9c27b0;
    }
    
    .development-section {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border-left: 5px solid #4caf50;
    }
    
    /* 區段標題 */
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.8rem;
        font-size: 1.1rem;
    }
    
    /* 內容文字 */
    .section-content {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #495057;
    }
    
    /* 操作按鈕區域 */
    .action-buttons {
        text-align: center;
        margin-top: 4rem;
        padding: 3rem 0;
        background: white;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .action-buttons .btn {
        margin: 0.5rem;
        padding: 0.8rem 2rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
        .result-header {
            padding: 2rem 1rem;
            margin-bottom: 2rem;
        }
        
        .content-section {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .score-number {
            font-size: 1.8rem;
        }
        
        .role-title {
            font-size: 1.2rem;
        }
        
        .section-title {
            font-size: 1rem;
        }
        
        .section-content {
            font-size: 0.9rem;
        }
        
        .role-image, .role-image-placeholder {
            width: calc(100% - 10px);
            height: calc(100% - 10px);
            max-width: 150px;
            max-height: 150px;
        }
        
        .role-image-placeholder i {
            font-size: 2.5rem;
        }
        
        .radar-chart-container {
            height: 350px;
        }
    }
    
    /* 動畫效果 */
    .content-section {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .content-section:nth-child(even) {
        animation-delay: 0.1s;
    }
    
    .content-section:nth-child(odd) {
        animation-delay: 0.2s;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-container">
    <div class="container">
        <!-- 測驗結果 Header -->
        <div class="result-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h1 fw-bold mb-3">{{ test_project.name }}</h1>
                    <p class="mb-3">{{ test_project.description|default:"探索您的人格特質，發現內在潛能" }}</p>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span class="me-3">完成時間：{{ result.test_completion_date|date:"Y年m月d日 H:i" }}</span>
                        {% if result.completion_days_ago %}
                        <span class="badge bg-light text-dark">{{ result.completion_days_ago }}天前</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="score-circle">
                        {% if highest_category %}
                            {{ highest_category.percentage }}分
                        {% else %}
                            {{ result.score_value|floatformat:1 }}/5.0
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色信息區域 -->
        <div class="content-section role-section">
            {% if highest_category %}
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <!-- 角色圖片 -->
                        <div class="role-image-container">
                            {% if highest_category.image %}
                                <img src="{{ highest_category.image.url }}" alt="{{ highest_category.role_name }}" class="role-image">
                            {% else %}
                                <div class="role-image-placeholder">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h2 class="role-title">
                            <i class="bi bi-person-badge"></i>
                            {{ highest_category.role_name }}
                        </h2>
                        <div class="section-content">
                            <p class="lead">這是您最具優勢的角色類型，基於您在 <strong class="text-success">{{ highest_category.name }}</strong> 分類中的傑出表現。</p>
                            <div class="tags-container">
                                {% for tag in highest_category.tag_text|split:"," %}
                                    <span class="tag-item">#{{ tag|trim }}</span>
                                {% endfor %}
                            </div>
                            <div class="role-description mt-4">
                                {{ highest_category.role_info|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="role-image-placeholder">
                            <i class="bi bi-person-circle"></i>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h2 class="role-title">
                            <i class="bi bi-person-badge"></i>
                            您的專屬角色
                        </h2>
                        <p class="section-content">角色資訊將在此顯示...</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- 建議與雷達圖區域 -->
        <div class="row">
            <div class="col-lg-6">
                <!-- 優勢建議區域 -->
                <div class="content-section advice-section">
                    <h3 class="section-title">
                        <i class="bi bi-lightbulb"></i>
                        優勢建議
                    </h3>
                    {% if highest_category %}
                        <div class="section-content">
                            {{ highest_category.strength_advice|linebreaks }}
                        </div>
                    {% else %}
                        <p class="section-content">優勢建議將在此顯示...</p>
                    {% endif %}
                </div>
                
                <!-- 發展方向區域 -->
                <div class="content-section development-section">
                    <h3 class="section-title">
                        <i class="bi bi-arrow-up-right-circle"></i>
                        發展方向
                    </h3>
                    {% if highest_category %}
                        <div class="section-content">
                            {{ highest_category.development_direction|linebreaks }}
                        </div>
                    {% else %}
                        <p class="section-content">發展方向將在此顯示...</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-6">
                <!-- 雷達圖區域 -->
                <div class="content-section radar-section">
                    <h3 class="section-title">
                        <i class="bi bi-radar"></i>
                        能力雷達圖
                    </h3>
                    <div class="radar-chart-container">
                        <canvas id="radarChart" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按鈕區域 -->
        <div class="action-buttons">
            <a href="{% url 'individual_test_results_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list me-2"></i>返回結果列表
            </a>
            <a href="{% url 'individual_tests' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回測驗列表
            </a>
            <a href="{% url 'direct_test_access' test_project.id %}" class="btn btn-primary">
                <i class="bi bi-box-arrow-up-right me-2"></i>重新進入測驗
            </a>
            <a href="{% url 'generate_individual_test_result_pdf' result.id %}" class="btn btn-success" target="_blank">
                <i class="bi bi-file-pdf me-2"></i>下載PDF報告
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
console.log('========== 雷達圖調試開始 ==========');
console.log('1. 頁面載入時間:', new Date());
console.log('2. Chart.js 載入狀態:', typeof Chart !== 'undefined' ? 'loaded' : 'not loaded');

// 等待 DOM 完全載入
document.addEventListener('DOMContentLoaded', function() {
    console.log('3. DOM 載入完成');
    
    // 檢查 Canvas 元素
    const radarCanvas = document.getElementById('radarChart');
    console.log('4. Canvas 元素:', radarCanvas);
    
    if (!radarCanvas) {
        console.error('❌ Canvas 元素不存在！');
        return;
    }
    
    // 檢查 Chart.js
    if (typeof Chart === 'undefined') {
        console.error('❌ Chart.js 未載入！');
        return;
    }
    
    console.log('5. Chart.js 版本:', Chart.version);
    
    // 雷達圖資料
    const radarData = {
        labels: {{ radar_data.labels|safe }},
        scores: {{ radar_data.scores|safe }}
    };
    
    console.log('6. 雷達圖資料:', radarData);
    
    // 初始化雷達圖
    try {
        console.log('7. 開始初始化雷達圖...');
        const ctx = radarCanvas.getContext('2d');
        
        const radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: radarData.labels,
                datasets: [{
                    label: '能力評分',
                    data: radarData.scores,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 12
                            }
                        },
                        pointLabels: {
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        console.log('✅ 雷達圖初始化成功！', radarChart);
    } catch (error) {
        console.error('❌ 雷達圖初始化失敗:', error);
    }
});
</script>
{% endblock %}