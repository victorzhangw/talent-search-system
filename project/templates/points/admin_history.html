{% extends 'base.html' %}

{% block title %}企業購買與份數紀錄 - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">儀表板</a></li>
<li class="breadcrumb-item active">企業購買與份數紀錄</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i>企業購買紀錄</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3 align-items-end">
                        <input type="hidden" name="usage_page" value="{{ usage_page_obj.number }}">
                        <input type="hidden" name="name" value="{{ filters.name }}">
                        <input type="hidden" name="email" value="{{ filters.email }}">
                        <div class="col-md-4">
                            <label class="form-label">評鑑項目</label>
                            <select name="project" class="form-select">
                                <option value="">全部</option>
                                {% for project in projects %}
                                    <option value="{{ project.id }}" {% if filters.project|default:'' == project.id|stringformat:'s' %}selected{% endif %}>{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">付款日期(起)</label>
                            <input type="date" name="date_from" value="{{ filters.date_from }}" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">付款日期(迄)</label>
                            <input type="date" name="date_to" value="{{ filters.date_to }}" class="form-control">
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-search me-1"></i>篩選</button>
                        </div>
                    </form>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>公司名稱</th>
                                <th>訂單編號</th>
                                <th>評鑑項目</th>
                                <th>付款日期</th>
                                <th>付款方式</th>
                                <th class="text-end">付款金額</th>
                                <th>發票資訊</th>
                                <th>優惠券</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if purchase_page_obj.object_list %}
                                {% for record in purchase_page_obj %}
                                    <tr>
                                        <td>{{ record.enterprise_user.enterprise_profile.company_name|default:record.enterprise_user.username }}</td>
                                        <td>{{ record.order_number }}</td>
                                        <td>{{ record.test_project.name }}</td>
                                        <td>{{ record.payment_date|date:'Y-m-d H:i' }}</td>
                                        <td>
                                            {% if record.payment_method %}
                                                {{ record.get_payment_method_display }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">{{ record.payment_amount|default:'-' }}</td>
                                        <td>
                                            {% if record.invoice_number %}
                                                <div>號碼：{{ record.invoice_number }}</div>
                                                {% if record.invoice_random_code %}<div>隨機碼：{{ record.invoice_random_code }}</div>{% endif %}
                                                {% if record.invoice_info %}<div class="small text-muted">{{ record.invoice_info }}</div>{% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ record.coupon_code|default:'-' }}</td>
                                        <td>{{ record.notes|default:'-' }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">尚無購買紀錄</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    {% include 'points/includes/purchase_pagination.html' with page_obj=purchase_page_obj filters=filters usage_page_obj=usage_page_obj %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>企業與受測者份數紀錄</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <input type="hidden" name="project" value="{{ filters.project }}">
                        <input type="hidden" name="date_from" value="{{ filters.date_from }}">
                        <input type="hidden" name="date_to" value="{{ filters.date_to }}">
                        <input type="hidden" name="purchase_page" value="{{ purchase_page_obj.number }}">
                        <div class="col-md-4">
                            <label class="form-label">姓名</label>
                            <input type="text" name="name" value="{{ filters.name }}" class="form-control" placeholder="搜尋姓名">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">E-mail</label>
                            <input type="text" name="email" value="{{ filters.email }}" class="form-control" placeholder="搜尋 E-mail">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100"><i class="bi bi-search me-1"></i>篩選</button>
                        </div>
                    </form>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>狀態</th>
                                <th>姓名</th>
                                <th>Email</th>
                                <th>評鑑項目</th>
                                <th>測驗時間</th>
                                <th class="text-end">異動份數</th>
                                <th class="text-end">剩餘份數</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if usage_page_obj.object_list %}
                                {% for log in usage_page_obj %}
                                    <tr>
                                        <td>
                                            {% if log.action == 'consume' %}
                                                <span class="badge bg-primary">測驗</span>
                                            {% else %}
                                                <span class="badge bg-secondary">取消</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ log.invitee_name|default:'-' }}</td>
                                        <td>{{ log.invitee_email|default:'-' }}</td>
                                        <td>{{ log.test_project.name }}</td>
                                        <td>{{ log.action_time|date:'Y-m-d H:i' }}</td>
                                        <td class="text-end">{{ log.quantity }}</td>
                                        <td class="text-end">
                                            {% if log.remaining_quota is None %}
                                                不限
                                            {% else %}
                                                {{ log.remaining_quota }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">尚無份數使用紀錄</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    {% include 'points/includes/usage_pagination.html' with page_obj=usage_page_obj filters=filters purchase_page_obj=purchase_page_obj %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
