<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éƒ¨ç½²æª¢æŸ¥å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }

      .check-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #ddd;
      }

      .check-item.success {
        border-left-color: #28a745;
        background: #d4edda;
      }

      .check-item.error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }

      .check-item.warning {
        border-left-color: #ffc107;
        background: #fff3cd;
      }

      .check-title {
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .check-detail {
        font-size: 14px;
        color: #555;
        font-family: "Courier New", monospace;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        text-align: center;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” éƒ¨ç½²æª¢æŸ¥å·¥å…·</h1>
      <p class="subtitle">è¨ºæ–·å‰å¾Œç«¯é€£æ¥å•é¡Œ</p>

      <div id="results"></div>

      <button class="btn" onclick="runChecks()" id="checkBtn">é–‹å§‹æª¢æŸ¥</button>
    </div>

    <script>
      const API_URLS = [
        "http://localhost:8000",
        "https://talent-search-api.onrender.com",
      ];

      function getDetectedApiUrl() {
        const hostname = window.location.hostname;

        if (
          hostname.includes("render.com") ||
          hostname.includes("onrender.com")
        ) {
          return "https://talent-search-api.onrender.com";
        } else if (hostname.includes("vercel.app")) {
          return "https://talent-search-api.onrender.com";
        } else if (hostname.includes("netlify.app")) {
          return "https://talent-search-api.onrender.com";
        } else {
          return "http://localhost:8000";
        }
      }

      async function checkApiHealth(apiUrl) {
        try {
          const response = await fetch(`${apiUrl}/health`, {
            method: "GET",
            mode: "cors",
          });

          if (response.ok) {
            const data = await response.json();
            return { success: true, data };
          } else {
            return { success: false, error: `HTTP ${response.status}` };
          }
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      async function checkApiSearch(apiUrl) {
        try {
          const response = await fetch(`${apiUrl}/api/search`, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              query: "åˆ—å‡ºæ‰€æœ‰å€™é¸äºº",
              filters: null,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            return { success: true, data };
          } else {
            return { success: false, error: `HTTP ${response.status}` };
          }
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      function addCheckItem(title, detail, status) {
        const resultsDiv = document.getElementById("results");
        const item = document.createElement("div");
        item.className = `check-item ${status}`;

        let icon = "â³";
        if (status === "success") icon = "âœ…";
        if (status === "error") icon = "âŒ";
        if (status === "warning") icon = "âš ï¸";

        item.innerHTML = `
                <div class="check-title">
                    <span class="icon">${icon}</span>
                    ${title}
                </div>
                <div class="check-detail">${detail}</div>
            `;

        resultsDiv.appendChild(item);
      }

      async function runChecks() {
        const resultsDiv = document.getElementById("results");
        const btn = document.getElementById("checkBtn");

        resultsDiv.innerHTML = "";
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> æª¢æŸ¥ä¸­...';

        // 1. æª¢æŸ¥ç•¶å‰ç’°å¢ƒ
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        addCheckItem(
          "ç•¶å‰ç’°å¢ƒ",
          `ä¸»æ©Ÿå: ${hostname}<br>å”è­°: ${protocol}`,
          "success"
        );

        // 2. æª¢æŸ¥è‡ªå‹•æª¢æ¸¬çš„ API URL
        const detectedUrl = getDetectedApiUrl();
        addCheckItem("è‡ªå‹•æª¢æ¸¬ API URL", `æª¢æ¸¬åˆ°: ${detectedUrl}`, "success");

        // 3. æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„ API
        for (const apiUrl of API_URLS) {
          addCheckItem(`æª¢æŸ¥ API: ${apiUrl}`, "æ­£åœ¨é€£æ¥...", "warning");

          // å¥åº·æª¢æŸ¥
          const healthResult = await checkApiHealth(apiUrl);

          if (healthResult.success) {
            addCheckItem(
              `âœ… ${apiUrl} - å¥åº·æª¢æŸ¥`,
              `ç‹€æ…‹: ${healthResult.data.status}<br>` +
                `è³‡æ–™åº«: ${healthResult.data.database}<br>` +
                `ç’°å¢ƒ: ${healthResult.data.environment}`,
              "success"
            );

            // æœç´¢æ¸¬è©¦
            const searchResult = await checkApiSearch(apiUrl);

            if (searchResult.success) {
              addCheckItem(
                `âœ… ${apiUrl} - æœç´¢åŠŸèƒ½`,
                `æ‰¾åˆ° ${searchResult.data.total} ä½å€™é¸äºº<br>` +
                  `æŸ¥è©¢ç†è§£: ${searchResult.data.query_understanding}`,
                "success"
              );
            } else {
              addCheckItem(
                `âŒ ${apiUrl} - æœç´¢åŠŸèƒ½`,
                `éŒ¯èª¤: ${searchResult.error}`,
                "error"
              );
            }
          } else {
            addCheckItem(
              `âŒ ${apiUrl} - å¥åº·æª¢æŸ¥`,
              `éŒ¯èª¤: ${healthResult.error}`,
              "error"
            );
          }
        }

        // 4. CORS æª¢æŸ¥
        addCheckItem(
          "CORS è¨­å®š",
          "å¦‚æœä¸Šè¿°æª¢æŸ¥å¤±æ•—ï¼Œå¯èƒ½æ˜¯ CORS å•é¡Œã€‚<br>" +
            "è«‹ç¢ºèªå¾Œç«¯å…è¨±ç•¶å‰åŸŸåçš„è«‹æ±‚ã€‚",
          "warning"
        );

        btn.disabled = false;
        btn.innerHTML = "é‡æ–°æª¢æŸ¥";
      }
    </script>
  </body>
</html>
